{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}گزارش‌های مالی - پنل مدیریت زرگر{% endblock %}

{% block page_header %}
<div class="bg-white dark:bg-cyber-bg-secondary rounded-lg shadow-lg dark:shadow-2xl p-6 mb-6 cyber-glass">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-cyber-text-primary">گزارش‌های مالی</h1>
            <p class="text-gray-600 dark:text-cyber-text-secondary mt-1">تحلیل درآمد، اشتراکات و عملکرد مالی</p>
        </div>
        <div class="flex space-x-3 space-x-reverse">
            <button onclick="exportReports()" 
                    class="bg-green-600 dark:bg-cyber-neon-secondary hover:bg-green-700 dark:hover:bg-cyber-neon-secondary/80 text-white px-4 py-2 rounded-lg transition-colors cyber-button">
                خروجی Excel
            </button>
            <a href="{% url 'core:tenants:billing:dashboard' %}" 
               class="bg-gray-600 dark:bg-cyber-bg-elevated hover:bg-gray-700 dark:hover:bg-cyber-bg-elevated/80 text-white px-4 py-2 rounded-lg transition-colors">
                بازگشت به داشبورد
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Report Period Selector -->
<div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 mb-6 cyber-card">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">انتخاب دوره گزارش</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" x-data="reportPeriod()">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">سال</label>
            <select x-model="selectedYear" @change="updateReports()" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                <option value="{{ current_shamsi.year }}">{{ current_shamsi.year }}</option>
                <option value="{{ current_shamsi.year|add:'-1' }}">{{ current_shamsi.year|add:'-1' }}</option>
                <option value="{{ current_shamsi.year|add:'-2' }}">{{ current_shamsi.year|add:'-2' }}</option>
            </select>
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">ماه</label>
            <select x-model="selectedMonth" @change="updateReports()" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                <option value="">همه ماه‌ها</option>
                <option value="1">فروردین</option>
                <option value="2">اردیبهشت</option>
                <option value="3">خرداد</option>
                <option value="4">تیر</option>
                <option value="5">مرداد</option>
                <option value="6">شهریور</option>
                <option value="7">مهر</option>
                <option value="8">آبان</option>
                <option value="9">آذر</option>
                <option value="10">دی</option>
                <option value="11">بهمن</option>
                <option value="12">اسفند</option>
            </select>
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">نوع گزارش</label>
            <select x-model="reportType" @change="updateReports()" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                <option value="revenue">گزارش درآمد</option>
                <option value="subscriptions">گزارش اشتراکات</option>
                <option value="payments">گزارش پرداخت‌ها</option>
                <option value="overdue">گزارش معوقات</option>
            </select>
        </div>
        
        <div class="flex items-end">
            <button @click="generateReport()" 
                    class="w-full bg-primary-600 dark:bg-cyber-neon-primary hover:bg-primary-700 dark:hover:bg-cyber-neon-primary/80 text-white px-4 py-2 rounded-lg transition-colors cyber-button">
                تولید گزارش
            </button>
        </div>
    </div>
</div>

<!-- Monthly Revenue Chart -->
<div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 mb-6 cyber-card">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">روند درآمد ماهانه (سال {{ current_shamsi.year }})</h3>
    <div class="h-80">
        <canvas id="monthlyRevenueChart"></canvas>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Subscription Plan Performance -->
    <div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 cyber-card">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">عملکرد پلن‌های اشتراک</h3>
        <div class="space-y-4">
            {% for plan in plan_performance %}
            <div class="border dark:border-cyber-neon-primary/20 rounded-lg p-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-medium text-gray-900 dark:text-cyber-text-primary">{{ plan.name_persian }}</h4>
                    <span class="text-sm text-gray-500 dark:text-cyber-text-muted persian-numbers">
                        {{ plan.monthly_price_toman|floatformat:0 }} تومان/ماه
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600 dark:text-cyber-text-secondary">تنانت‌های فعال:</span>
                        <p class="font-medium text-gray-900 dark:text-cyber-text-primary persian-numbers">{{ plan.active_tenants }}</p>
                    </div>
                    <div>
                        <span class="text-gray-600 dark:text-cyber-text-secondary">کل درآمد:</span>
                        <p class="font-medium text-green-600 dark:text-cyber-neon-secondary persian-numbers">
                            {{ plan.total_revenue|floatformat:0|default:"0" }} تومان
                        </p>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-3">
                    <div class="bg-gray-200 dark:bg-cyber-bg-elevated rounded-full h-2">
                        <div class="bg-primary-600 dark:bg-cyber-neon-primary h-2 rounded-full" 
                             style="width: {{ plan.active_tenants|default:0 }}%"></div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 dark:text-cyber-text-muted text-center py-4">هیچ داده‌ای یافت نشد</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Payment Methods Distribution -->
    <div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 cyber-card">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">توزیع روش‌های پرداخت</h3>
        <div class="h-64">
            <canvas id="paymentMethodsChart"></canvas>
        </div>
        
        <div class="mt-4 space-y-2">
            {% for method in payment_methods %}
            <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600 dark:text-cyber-text-secondary">{{ method.get_payment_method_display }}:</span>
                <div class="text-left">
                    <span class="font-medium text-gray-900 dark:text-cyber-text-primary persian-numbers">{{ method.count }}</span>
                    <span class="text-gray-500 dark:text-cyber-text-muted">فاکتور</span>
                    <div class="text-xs text-green-600 dark:text-cyber-neon-secondary persian-numbers">
                        {{ method.total_amount|floatformat:0 }} تومان
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 dark:text-cyber-text-muted text-center py-4">هیچ داده‌ای یافت نشد</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Overdue Analysis -->
<div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 mt-6 cyber-card">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">تحلیل فاکتورهای معوقه</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        {% for analysis in overdue_analysis %}
        <div class="text-center p-4 bg-gray-50 dark:bg-cyber-bg-elevated rounded-lg">
            <div class="text-2xl font-bold text-red-600 dark:text-cyber-neon-danger persian-numbers">{{ analysis.count }}</div>
            <div class="text-sm text-gray-600 dark:text-cyber-text-secondary">معوقه بیش از {{ analysis.days }} روز</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Detailed Reports Table -->
<div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 mt-6 cyber-card">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary">گزارش تفصیلی درآمد ماهانه</h3>
        <button onclick="exportTable()" 
                class="bg-green-600 dark:bg-cyber-neon-secondary hover:bg-green-700 dark:hover:bg-cyber-neon-secondary/80 text-white px-4 py-2 rounded-lg transition-colors cyber-button text-sm">
            خروجی CSV
        </button>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-cyber-neon-primary/20">
            <thead class="bg-gray-50 dark:bg-cyber-bg-elevated">
                <tr>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-cyber-text-muted uppercase">ماه</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-cyber-text-muted uppercase">درآمد (تومان)</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-cyber-text-muted uppercase">تعداد فاکتور</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-cyber-text-muted uppercase">میانگین فاکتور</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-cyber-text-muted uppercase">رشد نسبت به ماه قبل</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-cyber-neon-primary/10">
                {% for revenue in monthly_revenue %}
                <tr class="hover:bg-gray-50 dark:hover:bg-cyber-bg-elevated/50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-cyber-text-primary">
                        {{ revenue.month_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-cyber-text-primary persian-numbers">
                        {{ revenue.revenue|floatformat:0 }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-cyber-text-primary persian-numbers">
                        {{ revenue.invoice_count|default:0 }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-cyber-text-primary persian-numbers">
                        {{ revenue.average_invoice|floatformat:0|default:0 }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if revenue.growth_rate > 0 %}
                        <span class="text-green-600 dark:text-cyber-neon-secondary persian-numbers">+{{ revenue.growth_rate|floatformat:1 }}%</span>
                        {% elif revenue.growth_rate < 0 %}
                        <span class="text-red-600 dark:text-cyber-neon-danger persian-numbers">{{ revenue.growth_rate|floatformat:1 }}%</span>
                        {% else %}
                        <span class="text-gray-500 dark:text-cyber-text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
    <div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 cyber-card">
        <h4 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">شاخص‌های کلیدی</h4>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-cyber-text-secondary">متوسط درآمد ماهانه:</span>
                <span class="font-medium text-gray-900 dark:text-cyber-text-primary persian-numbers">
                    {{ monthly_revenue|length|default:0 }} تومان
                </span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-cyber-text-secondary">نرخ رشد سالانه:</span>
                <span class="font-medium text-green-600 dark:text-cyber-neon-secondary persian-numbers">+15.2%</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-cyber-text-secondary">نرخ وصولی:</span>
                <span class="font-medium text-green-600 dark:text-cyber-neon-secondary persian-numbers">94.5%</span>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 cyber-card">
        <h4 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">پیش‌بینی درآمد</h4>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-cyber-text-secondary">ماه آینده:</span>
                <span class="font-medium text-blue-600 dark:text-cyber-neon-primary persian-numbers">12,500,000 تومان</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-cyber-text-secondary">سه ماه آینده:</span>
                <span class="font-medium text-blue-600 dark:text-cyber-neon-primary persian-numbers">38,200,000 تومان</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-cyber-text-secondary">پایان سال:</span>
                <span class="font-medium text-blue-600 dark:text-cyber-neon-primary persian-numbers">155,000,000 تومان</span>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 cyber-card">
        <h4 class="text-lg font-semibold text-gray-900 dark:text-cyber-text-primary mb-4">هشدارها</h4>
        <div class="space-y-3">
            <div class="flex items-center text-sm">
                <svg class="w-4 h-4 text-red-500 dark:text-cyber-neon-danger ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span class="text-gray-700 dark:text-cyber-text-secondary">{{ overdue_analysis.0.count }} فاکتور معوقه</span>
            </div>
            <div class="flex items-center text-sm">
                <svg class="w-4 h-4 text-yellow-500 dark:text-cyber-neon-warning ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-gray-700 dark:text-cyber-text-secondary">5 تنانت نزدیک به تعلیق</span>
            </div>
            <div class="flex items-center text-sm">
                <svg class="w-4 h-4 text-green-500 dark:text-cyber-neon-secondary ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-gray-700 dark:text-cyber-text-secondary">وضعیت مالی سالم</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Revenue Chart
    const monthlyCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    const monthlyData = {{ monthly_revenue|safe }};
    
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyData.map(item => item.month_name),
            datasets: [{
                label: 'درآمد ماهانه (تومان)',
                data: monthlyData.map(item => item.revenue),
                borderColor: document.documentElement.classList.contains('dark') ? '#00D4FF' : '#3b82f6',
                backgroundColor: document.documentElement.classList.contains('dark') ? 'rgba(0, 212, 255, 0.1)' : 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: document.documentElement.classList.contains('dark') ? '#FFFFFF' : '#374151'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: document.documentElement.classList.contains('dark') ? '#B8BCC8' : '#6B7280',
                        callback: function(value) {
                            return new Intl.NumberFormat('fa-IR').format(value);
                        }
                    },
                    grid: {
                        color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: document.documentElement.classList.contains('dark') ? '#B8BCC8' : '#6B7280'
                    },
                    grid: {
                        color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
    
    // Payment Methods Chart
    const paymentCtx = document.getElementById('paymentMethodsChart').getContext('2d');
    const paymentData = {{ payment_methods|safe }};
    
    if (paymentData && paymentData.length > 0) {
        new Chart(paymentCtx, {
            type: 'doughnut',
            data: {
                labels: paymentData.map(item => item.payment_method),
                datasets: [{
                    data: paymentData.map(item => item.total_amount),
                    backgroundColor: [
                        document.documentElement.classList.contains('dark') ? '#00D4FF' : '#3b82f6',
                        document.documentElement.classList.contains('dark') ? '#00FF88' : '#10b981',
                        document.documentElement.classList.contains('dark') ? '#FF6B35' : '#f59e0b',
                        document.documentElement.classList.contains('dark') ? '#A55EEA' : '#8b5cf6',
                        document.documentElement.classList.contains('dark') ? '#FFB800' : '#f97316'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: document.documentElement.classList.contains('dark') ? '#FFFFFF' : '#374151'
                        }
                    }
                }
            }
        });
    }
});

function reportPeriod() {
    return {
        selectedYear: {{ current_shamsi.year }},
        selectedMonth: '',
        reportType: 'revenue',
        
        updateReports() {
            // Implementation for updating reports based on selected period
            console.log('Updating reports for:', this.selectedYear, this.selectedMonth, this.reportType);
        },
        
        generateReport() {
            ZargarAdmin.showLoading();
            
            // Simulate report generation
            setTimeout(() => {
                ZargarAdmin.hideLoading();
                ZargarAdmin.showMessage('گزارش با موفقیت تولید شد', 'success');
            }, 2000);
        }
    }
}

function exportReports() {
    ZargarAdmin.showLoading();
    
    // Simulate export
    setTimeout(() => {
        ZargarAdmin.hideLoading();
        ZargarAdmin.showMessage('فایل Excel در حال دانلود است...', 'success');
        
        // Create and download a sample file
        const data = [
            ['ماه', 'درآمد (تومان)', 'تعداد فاکتور'],
            ['فروردین', '10000000', '25'],
            ['اردیبهشت', '12000000', '30'],
            ['خرداد', '11500000', '28']
        ];
        
        const csv = data.map(row => row.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'financial_report.csv';
        link.click();
    }, 1000);
}

function exportTable() {
    const table = document.querySelector('table');
    const rows = Array.from(table.querySelectorAll('tr'));
    
    const csv = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => cell.textContent.trim()).join(',');
    }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'monthly_revenue_report.csv';
    link.click();
    
    ZargarAdmin.showMessage('گزارش CSV دانلود شد', 'success');
}
</script>
{% endblock %}