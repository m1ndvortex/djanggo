{% extends "base_rtl.html" %}
{% load static %}

{% block title %}یادآوری تولد و سالگرد - زرگر{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/customer-reminders.css' %}">
<script src="{% static 'js/customer-reminders.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="min-h-screen 
     {% if user.theme_preference == 'dark' %}
     bg-gradient-to-br from-cyber-bg-primary via-cyber-bg-secondary to-cyber-bg-surface
     {% else %}
     bg-gradient-to-br from-gray-50 to-gray-100
     {% endif %}"
     x-data="birthdayReminders()" 
     x-init="initReminders()"
     :class="{ 'dark': darkMode, 'light': !darkMode }">

    <!-- Header -->
    <header class="{% if user.theme_preference == 'dark' %}cyber-glass-header{% else %}bg-white/80 backdrop-blur-sm border-b border-gray-200{% endif %} sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-logo-container{% else %}bg-pink-600 p-2 rounded-lg{% endif %}">
                        <svg class="h-8 w-8 {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-white{% endif %}" 
                             fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 6c1.11 0 2-.9 2-2 0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.89 2 2 2zm4.6 9.99l-1.07-1.07-1.08 1.07c-1.3 1.3-3.58 1.31-4.89 0l-1.07-1.07L7.4 15.99C8.7 17.3 10.98 17.3 12.28 16c1.3 1.3 3.58 1.3 4.89 0-.01 0-.01 0 0 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-text-primary cyber-glow-text{% else %}text-gray-900{% endif %}">
                            یادآوری تولد و سالگرد
                        </h1>
                        <p class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-pink-600{% endif %}">
                            پیشنهادات هدیه و قالب‌های فارسی
                        </p>
                    </div>
                </div>
                
                <!-- Navigation -->
                <nav class="hidden md:flex items-center space-x-6 space-x-reverse">
                    <a href="{% url 'customers:loyalty_dashboard' %}" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link{% else %}nav-link{% endif %}">
                        داشبورد وفاداری
                    </a>
                    <a href="{% url 'customers:engagement_dashboard' %}" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link{% else %}nav-link{% endif %}">
                        تعامل مشتریان
                    </a>
                    <a href="{% url 'customers:birthday_reminders' %}" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link active{% else %}nav-link active{% endif %}">
                        یادآوری‌ها
                    </a>
                    <a href="/" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link{% else %}nav-link{% endif %}">
                        بازگشت به داشبورد
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        
        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <!-- Create Birthday Reminders -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
                <div class="flex items-center mb-4">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-icon-container primary{% else %}bg-pink-100 p-3 rounded-lg{% endif %}">
                        <svg class="h-6 w-6 {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-pink-600{% endif %}" 
                             fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 6c1.11 0 2-.9 2-2 0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.89 2 2 2z"/>
                        </svg>
                    </div>
                    <h3 class="mr-3 text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        یادآوری تولد
                    </h3>
                </div>
                
                <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %} mb-4">
                    ایجاد یادآوری برای تولدهای آینده مشتریان
                </p>
                
                <form method="post" class="space-y-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_birthday_reminders">
                    
                    <div>
                        <label class="block text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-700{% endif %} mb-1">
                            چند روز قبل یادآوری شود؟
                        </label>
                        <select name="days_ahead" 
                                class="w-full {% if user.theme_preference == 'dark' %}cyber-input{% else %}border border-gray-300 rounded-lg px-3 py-2{% endif %}">
                            <option value="1">۱ روز قبل</option>
                            <option value="3">۳ روز قبل</option>
                            <option value="7" selected>۷ روز قبل</option>
                            <option value="14">۱۴ روز قبل</option>
                        </select>
                    </div>
                    
                    <button type="submit" 
                            class="w-full {% if user.theme_preference == 'dark' %}cyber-button-primary{% else %}bg-pink-600 text-white py-2 px-4 rounded-lg hover:bg-pink-700{% endif %}">
                        ایجاد یادآوری تولد
                    </button>
                </form>
            </div>

            <!-- Create Anniversary Reminders -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
                <div class="flex items-center mb-4">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-icon-container tertiary{% else %}bg-blue-100 p-3 rounded-lg{% endif %}">
                        <svg class="h-6 w-6 {% if user.theme_preference == 'dark' %}text-cyber-neon-tertiary{% else %}text-blue-600{% endif %}" 
                             fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <h3 class="mr-3 text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        یادآوری سالگرد
                    </h3>
                </div>
                
                <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %} mb-4">
                    ایجاد یادآوری برای سالگرد مشتری شدن
                </p>
                
                <form method="post" class="space-y-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_anniversary_reminders">
                    
                    <div>
                        <label class="block text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-700{% endif %} mb-1">
                            چند روز قبل یادآوری شود؟
                        </label>
                        <select name="days_ahead" 
                                class="w-full {% if user.theme_preference == 'dark' %}cyber-input{% else %}border border-gray-300 rounded-lg px-3 py-2{% endif %}">
                            <option value="1">۱ روز قبل</option>
                            <option value="3">۳ روز قبل</option>
                            <option value="7" selected>۷ روز قبل</option>
                            <option value="14">۱۴ روز قبل</option>
                        </select>
                    </div>
                    
                    <button type="submit" 
                            class="w-full {% if user.theme_preference == 'dark' %}cyber-button-tertiary{% else %}bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700{% endif %}">
                        ایجاد یادآوری سالگرد
                    </button>
                </form>
            </div>

            <!-- Cultural Events -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
                <div class="flex items-center mb-4">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-icon-container success{% else %}bg-green-100 p-3 rounded-lg{% endif %}">
                        <svg class="h-6 w-6 {% if user.theme_preference == 'dark' %}text-cyber-neon-success{% else %}text-green-600{% endif %}" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <h3 class="mr-3 text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        رویدادهای فرهنگی
                    </h3>
                </div>
                
                <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %} mb-4">
                    تبریک مناسبت‌های ایرانی برای مشتریان VIP
                </p>
                
                <div class="space-y-2">
                    {% for event in cultural_events %}
                    <form method="post" class="inline-block w-full">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create_cultural_event">
                        <input type="hidden" name="event_type" value="{{ event.type }}">
                        
                        <button type="submit" 
                                class="w-full text-right {% if user.theme_preference == 'dark' %}cyber-button-secondary{% else %}bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded{% endif %} text-sm">
                            {{ event.name }} ({{ event.eligible_customers }} مشتری)
                        </button>
                    </form>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Upcoming Birthdays -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Upcoming Birthdays -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
                <h3 class="text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %} mb-4">
                    تولدهای آینده (۳۰ روز)
                </h3>
                
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    {% for birthday in upcoming_birthdays %}
                    <div class="{% if user.theme_preference == 'dark' %}cyber-glass-base{% else %}bg-pink-50{% endif %} p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="{% if user.theme_preference == 'dark' %}cyber-avatar{% else %}bg-pink-100 p-2 rounded-full{% endif %}">
                                    <svg class="h-4 w-4 {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-pink-600{% endif %}" 
                                         fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 6c1.11 0 2-.9 2-2 0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.89 2 2 2z"/>
                                    </svg>
                                </div>
                                <div class="mr-3">
                                    <p class="font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                        {{ birthday.customer.full_persian_name }}
                                    </p>
                                    <p class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                        {{ birthday.days_ahead }} روز دیگر
                                    </p>
                                </div>
                            </div>
                            {% if birthday.customer.is_vip %}
                            <span class="{% if user.theme_preference == 'dark' %}cyber-badge success{% else %}bg-green-100 text-green-800 px-2 py-1 rounded text-xs{% endif %}">
                                VIP
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Gift Suggestions -->
                        {% if birthday.gift_suggestions %}
                        <div class="mt-3">
                            <p class="text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-700{% endif %} mb-2">
                                پیشنهادات هدیه:
                            </p>
                            <div class="flex flex-wrap gap-2">
                                {% for gift in birthday.gift_suggestions %}
                                <span class="{% if user.theme_preference == 'dark' %}cyber-badge primary{% else %}bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs{% endif %}">
                                    {{ gift.name_persian }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Persian Message Preview -->
                        {% if birthday.event %}
                        <div class="mt-3 p-3 {% if user.theme_preference == 'dark' %}bg-cyber-bg-surface/50{% else %}bg-gray-100{% endif %} rounded">
                            <p class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                پیام: {{ birthday.event.message_persian|truncatechars:100 }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %} text-center py-8">
                        تولد آینده‌ای برنامه‌ریزی نشده است
                    </p>
                    {% endfor %}
                </div>
            </div>

            <!-- Upcoming Anniversaries -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
                <h3 class="text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %} mb-4">
                    سالگردهای آینده (۳۰ روز)
                </h3>
                
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    {% for anniversary in upcoming_anniversaries %}
                    <div class="{% if user.theme_preference == 'dark' %}cyber-glass-base{% else %}bg-blue-50{% endif %} p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="{% if user.theme_preference == 'dark' %}cyber-avatar{% else %}bg-blue-100 p-2 rounded-full{% endif %}">
                                    <svg class="h-4 w-4 {% if user.theme_preference == 'dark' %}text-cyber-neon-tertiary{% else %}text-blue-600{% endif %}" 
                                         fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                </div>
                                <div class="mr-3">
                                    <p class="font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                        {{ anniversary.customer.full_persian_name }}
                                    </p>
                                    <p class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                        {{ anniversary.years_as_customer }} سال مشتری - {{ anniversary.days_ahead }} روز دیگر
                                    </p>
                                </div>
                            </div>
                            {% if anniversary.customer.is_vip %}
                            <span class="{% if user.theme_preference == 'dark' %}cyber-badge success{% else %}bg-green-100 text-green-800 px-2 py-1 rounded text-xs{% endif %}">
                                VIP
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Gift Suggestions -->
                        {% if anniversary.gift_suggestions %}
                        <div class="mt-3">
                            <p class="text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-700{% endif %} mb-2">
                                پیشنهادات هدیه:
                            </p>
                            <div class="flex flex-wrap gap-2">
                                {% for gift in anniversary.gift_suggestions %}
                                <span class="{% if user.theme_preference == 'dark' %}cyber-badge tertiary{% else %}bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs{% endif %}">
                                    {{ gift.name_persian }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Persian Message Preview -->
                        {% if anniversary.event %}
                        <div class="mt-3 p-3 {% if user.theme_preference == 'dark' %}bg-cyber-bg-surface/50{% else %}bg-gray-100{% endif %} rounded">
                            <p class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                پیام: {{ anniversary.event.message_persian|truncatechars:100 }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %} text-center py-8">
                        سالگرد آینده‌ای برنامه‌ریزی نشده است
                    </p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recent Events -->
        <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
            <h3 class="text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %} mb-4">
                آخرین رویدادهای تولد و سالگرد
            </h3>
            
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="{% if user.theme_preference == 'dark' %}border-b border-cyber-neon-primary/20{% else %}border-b border-gray-200{% endif %}">
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                مشتری
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                نوع رویداد
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                وضعیت
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                امتیاز اعطا شده
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                تاریخ ایجاد
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in recent_events %}
                        <tr class="{% if user.theme_preference == 'dark' %}border-b border-cyber-neon-primary/10{% else %}border-b border-gray-100{% endif %}">
                            <td class="py-3 px-4">
                                <div class="flex items-center">
                                    <div class="{% if user.theme_preference == 'dark' %}cyber-avatar{% else %}bg-gray-100 p-1 rounded-full{% endif %}">
                                        {% if event.event_type == 'birthday' %}
                                        <svg class="h-3 w-3 {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-pink-600{% endif %}" 
                                             fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 6c1.11 0 2-.9 2-2 0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.89 2 2 2z"/>
                                        </svg>
                                        {% else %}
                                        <svg class="h-3 w-3 {% if user.theme_preference == 'dark' %}text-cyber-neon-tertiary{% else %}text-blue-600{% endif %}" 
                                             fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                        {% endif %}
                                    </div>
                                    <span class="mr-2 {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                        {{ event.customer.full_persian_name }}
                                    </span>
                                </div>
                            </td>
                            <td class="py-3 px-4 {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                {% if event.event_type == 'birthday' %}تولد
                                {% elif event.event_type == 'anniversary' %}سالگرد
                                {% else %}{{ event.get_event_type_display }}{% endif %}
                            </td>
                            <td class="py-3 px-4">
                                <span class="{% if event.status == 'delivered' %}{% if user.theme_preference == 'dark' %}cyber-badge success{% else %}bg-green-100 text-green-800 px-2 py-1 rounded text-sm{% endif %}{% elif event.status == 'sent' %}{% if user.theme_preference == 'dark' %}cyber-badge primary{% else %}bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm{% endif %}{% elif event.status == 'pending' %}{% if user.theme_preference == 'dark' %}cyber-badge warning{% else %}bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm{% endif %}{% else %}{% if user.theme_preference == 'dark' %}cyber-badge danger{% else %}bg-red-100 text-red-800 px-2 py-1 rounded text-sm{% endif %}{% endif %}">
                                    {{ event.get_status_display }}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                {% if event.bonus_points_awarded > 0 %}
                                <span class="font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-green-600{% endif %} persian-numbers">
                                    +{{ event.bonus_points_awarded }}
                                </span>
                                {% else %}
                                <span class="{% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-400{% endif %}">—</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %} text-sm persian-numbers">
                                {{ event.created_at|date:"Y/m/d H:i" }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="py-8 text-center {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                                هنوز رویداد تولد یا سالگردی ثبت نشده است
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
function birthdayReminders() {
    return {
        darkMode: document.documentElement.classList.contains('dark'),
        
        initReminders() {
            // Initialize reminders functionality
            console.log('Birthday Reminders initialized');
        }
    }
}
</script>
{% endblock %}