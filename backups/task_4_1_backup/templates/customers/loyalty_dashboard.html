{% extends "base_rtl.html" %}
{% load static %}

{% block title %}مدیریت وفاداری مشتریان - زرگر{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/customer-loyalty.css' %}">
<script src="{% static 'js/customer-loyalty.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="min-h-screen 
     {% if user.theme_preference == 'dark' %}
     bg-gradient-to-br from-cyber-bg-primary via-cyber-bg-secondary to-cyber-bg-surface
     {% else %}
     bg-gradient-to-br from-gray-50 to-gray-100
     {% endif %}"
     x-data="customerLoyaltyDashboard()" 
     x-init="initDashboard()"
     :class="{ 'dark': darkMode, 'light': !darkMode }">

    <!-- Header -->
    <header class="{% if user.theme_preference == 'dark' %}cyber-glass-header{% else %}bg-white/80 backdrop-blur-sm border-b border-gray-200{% endif %} sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-logo-container{% else %}bg-blue-600 p-2 rounded-lg{% endif %}">
                        <svg class="h-8 w-8 {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-white{% endif %}" 
                             fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-text-primary cyber-glow-text{% else %}text-gray-900{% endif %}">
                            مدیریت وفاداری مشتریان
                        </h1>
                        <p class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}">
                            امتیازات، سطوح VIP و مزایای مشتریان
                        </p>
                    </div>
                </div>
                
                <!-- Navigation -->
                <nav class="hidden md:flex items-center space-x-6 space-x-reverse">
                    <a href="{% url 'customers:loyalty_dashboard' %}" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link active{% else %}nav-link active{% endif %}">
                        داشبورد وفاداری
                    </a>
                    <a href="{% url 'customers:engagement_dashboard' %}" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link{% else %}nav-link{% endif %}">
                        تعامل مشتریان
                    </a>
                    <a href="{% url 'customers:birthday_reminders' %}" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link{% else %}nav-link{% endif %}">
                        یادآوری‌ها
                    </a>
                    <a href="/" 
                       class="{% if user.theme_preference == 'dark' %}cyber-nav-link{% else %}nav-link{% endif %}">
                        بازگشت به داشبورد
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        
        <!-- Loyalty Program Overview -->
        {% if loyalty_program %}
        <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                    برنامه وفاداری: {{ loyalty_program.name_persian }}
                </h2>
                <span class="{% if user.theme_preference == 'dark' %}cyber-badge success{% else %}bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm{% endif %}">
                    فعال
                </span>
            </div>
            <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %} mb-4">
                {{ loyalty_program.description_persian }}
            </p>
            
            <!-- Program Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-blue-600{% endif %} persian-numbers">
                        {{ loyalty_program.points_per_toman }}
                    </div>
                    <div class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                        امتیاز به ازای هر تومان
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-blue-600{% endif %} persian-numbers">
                        {{ loyalty_program.toman_per_point }}
                    </div>
                    <div class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                        تومان ارزش هر امتیاز
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-blue-600{% endif %} persian-numbers">
                        {{ loyalty_program.birthday_bonus_points }}
                    </div>
                    <div class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                        امتیاز هدیه تولد
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-blue-600{% endif %} persian-numbers">
                        {{ loyalty_program.referral_bonus_points }}
                    </div>
                    <div class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                        امتیاز معرفی دوستان
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Total Customers -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-metric-card{% else %}metric-card{% endif %} animate-fade-in-up">
                <div class="flex items-center">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-icon-container primary{% else %}icon-container primary{% endif %}">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                    </div>
                    <div class="mr-3">
                        <p class="text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                            کل مشتریان
                        </p>
                        <p class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary cyber-number-glow{% else %}text-gray-900{% endif %} persian-numbers">
                            {{ total_customers }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- VIP Customers -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-metric-card{% else %}metric-card{% endif %} animate-fade-in-up" style="animation-delay: 0.1s">
                <div class="flex items-center">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-icon-container success{% else %}icon-container success{% endif %}">
                        <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <div class="mr-3">
                        <p class="text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                            مشتریان VIP
                        </p>
                        <p class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary cyber-number-glow{% else %}text-gray-900{% endif %} persian-numbers">
                            {{ vip_customers }}
                        </p>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-sm {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                        {{ regular_customers }} مشتری عادی
                    </span>
                </div>
            </div>

            <!-- Total Points Earned -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-metric-card{% else %}metric-card{% endif %} animate-fade-in-up" style="animation-delay: 0.2s">
                <div class="flex items-center">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-icon-container tertiary{% else %}icon-container tertiary{% endif %}">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div class="mr-3">
                        <p class="text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                            کل امتیازات اعطا شده
                        </p>
                        <p class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary cyber-number-glow{% else %}text-gray-900{% endif %} persian-numbers">
                            {{ points_stats.total_earned|floatformat:0 }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Points Redeemed -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-metric-card{% else %}metric-card{% endif %} animate-fade-in-up" style="animation-delay: 0.3s">
                <div class="flex items-center">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-icon-container warning{% else %}icon-container warning{% endif %}">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="mr-3">
                        <p class="text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                            امتیازات استفاده شده
                        </p>
                        <p class="text-2xl font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary cyber-number-glow{% else %}text-gray-900{% endif %} persian-numbers">
                            {{ points_stats.total_redeemed|floatformat:0 }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIP Tier Distribution -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Tier Distribution Chart -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
                <h3 class="text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %} mb-4">
                    توزیع سطوح VIP
                </h3>
                
                <div class="space-y-4">
                    {% for tier in tier_distribution %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3
                                        {% if tier.tier == 'bronze' %}bg-amber-500
                                        {% elif tier.tier == 'silver' %}bg-gray-400
                                        {% elif tier.tier == 'gold' %}bg-yellow-500
                                        {% elif tier.tier == 'platinum' %}bg-purple-500
                                        {% else %}bg-gray-300{% endif %}">
                            </div>
                            <span class="{% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                {% if tier.tier == 'bronze' %}برنز
                                {% elif tier.tier == 'silver' %}نقره‌ای
                                {% elif tier.tier == 'gold' %}طلایی
                                {% elif tier.tier == 'platinum' %}پلاتینیوم
                                {% else %}عادی{% endif %}
                            </span>
                        </div>
                        <span class="font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-gray-900{% endif %} persian-numbers">
                            {{ tier.count }}
                        </span>
                    </div>
                    {% empty %}
                    <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %} text-center py-4">
                        هنوز مشتری VIP ثبت نشده است
                    </p>
                    {% endfor %}
                </div>
            </div>

            <!-- Top Customers by Points -->
            <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
                <h3 class="text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %} mb-4">
                    برترین مشتریان (امتیاز)
                </h3>
                
                <div class="space-y-3">
                    {% for customer in top_customers %}
                    <div class="flex items-center justify-between p-3 {% if user.theme_preference == 'dark' %}cyber-glass-base{% else %}bg-gray-50{% endif %} rounded-lg">
                        <div class="flex items-center">
                            <div class="{% if user.theme_preference == 'dark' %}cyber-avatar{% else %}bg-blue-100 p-2 rounded-full{% endif %}">
                                <svg class="h-4 w-4 {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                                     fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <div class="mr-3">
                                <p class="font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                    {{ customer.full_persian_name }}
                                </p>
                                {% if customer.is_vip %}
                                <span class="{% if user.theme_preference == 'dark' %}cyber-badge success{% else %}bg-green-100 text-green-800 px-2 py-1 rounded text-xs{% endif %}">
                                    VIP
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-left">
                            <p class="font-bold {% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-gray-900{% endif %} persian-numbers">
                                {{ customer.loyalty_points|floatformat:0 }}
                            </p>
                            <p class="text-xs {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                                امتیاز
                            </p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="{% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %} text-center py-4">
                        هنوز مشتری با امتیاز ثبت نشده است
                    </p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recent Loyalty Transactions -->
        <div class="{% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white rounded-lg shadow{% endif %} p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                    آخرین تراکنش‌های امتیاز
                </h3>
                <button class="{% if user.theme_preference == 'dark' %}cyber-button-secondary{% else %}bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700{% endif %}"
                        @click="showAwardPointsModal = true">
                    اعطای امتیاز
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="{% if user.theme_preference == 'dark' %}border-b border-cyber-neon-primary/20{% else %}border-b border-gray-200{% endif %}">
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                مشتری
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                نوع تراکنش
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                امتیاز
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                دلیل
                            </th>
                            <th class="text-right py-3 px-4 font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                تاریخ
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in recent_transactions %}
                        <tr class="{% if user.theme_preference == 'dark' %}border-b border-cyber-neon-primary/10{% else %}border-b border-gray-100{% endif %}">
                            <td class="py-3 px-4">
                                <div class="flex items-center">
                                    <div class="{% if user.theme_preference == 'dark' %}cyber-avatar{% else %}bg-gray-100 p-1 rounded-full{% endif %}">
                                        <svg class="h-3 w-3 {% if user.theme_preference == 'dark' %}text-cyber-neon-primary{% else %}text-gray-600{% endif %}" 
                                             fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                        </svg>
                                    </div>
                                    <span class="mr-2 {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                        {{ transaction.customer.full_persian_name }}
                                    </span>
                                </div>
                            </td>
                            <td class="py-3 px-4">
                                <span class="{% if transaction.transaction_type == 'earned' %}{% if user.theme_preference == 'dark' %}cyber-badge success{% else %}bg-green-100 text-green-800 px-2 py-1 rounded text-sm{% endif %}{% else %}{% if user.theme_preference == 'dark' %}cyber-badge warning{% else %}bg-red-100 text-red-800 px-2 py-1 rounded text-sm{% endif %}{% endif %}">
                                    {{ transaction.get_transaction_type_display }}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="font-bold {% if transaction.points > 0 %}{% if user.theme_preference == 'dark' %}text-cyber-neon-secondary{% else %}text-green-600{% endif %}{% else %}{% if user.theme_preference == 'dark' %}text-cyber-neon-danger{% else %}text-red-600{% endif %}{% endif %} persian-numbers">
                                    {% if transaction.points > 0 %}+{% endif %}{{ transaction.points }}
                                </span>
                            </td>
                            <td class="py-3 px-4 {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                {{ transaction.reason|default:"—" }}
                            </td>
                            <td class="py-3 px-4 {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %} text-sm persian-numbers">
                                {{ transaction.created_at|date:"Y/m/d H:i" }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="py-8 text-center {% if user.theme_preference == 'dark' %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                                هنوز تراکنش امتیازی ثبت نشده است
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Award Points Modal -->
    <div x-show="showAwardPointsModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto"
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" @click="showAwardPointsModal = false">
                <div class="absolute inset-0 {% if user.theme_preference == 'dark' %}bg-cyber-bg-primary{% else %}bg-gray-500{% endif %} opacity-75"></div>
            </div>

            <div class="inline-block align-bottom {% if user.theme_preference == 'dark' %}cyber-glass-card{% else %}bg-white{% endif %} rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form @submit.prevent="awardPoints()">
                    <div class="{% if user.theme_preference == 'dark' %}cyber-glass-base{% else %}bg-white{% endif %} px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-primary{% else %}text-gray-900{% endif %} mb-4">
                            اعطای امتیاز به مشتری
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-700{% endif %} mb-2">
                                    انتخاب مشتری
                                </label>
                                <select x-model="awardPointsForm.customer_id" 
                                        class="w-full {% if user.theme_preference == 'dark' %}cyber-input{% else %}border border-gray-300 rounded-lg px-3 py-2{% endif %}"
                                        required>
                                    <option value="">انتخاب کنید...</option>
                                    {% for customer in top_customers %}
                                    <option value="{{ customer.id }}">{{ customer.full_persian_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-700{% endif %} mb-2">
                                    تعداد امتیاز
                                </label>
                                <input type="number" 
                                       x-model="awardPointsForm.points"
                                       class="w-full {% if user.theme_preference == 'dark' %}cyber-input{% else %}border border-gray-300 rounded-lg px-3 py-2{% endif %}"
                                       min="1" 
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium {% if user.theme_preference == 'dark' %}text-cyber-text-secondary{% else %}text-gray-700{% endif %} mb-2">
                                    دلیل اعطای امتیاز
                                </label>
                                <input type="text" 
                                       x-model="awardPointsForm.reason"
                                       class="w-full {% if user.theme_preference == 'dark' %}cyber-input{% else %}border border-gray-300 rounded-lg px-3 py-2{% endif %}"
                                       placeholder="مثال: خرید ویژه، تولد، ..."
                                       required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="{% if user.theme_preference == 'dark' %}cyber-glass-base{% else %}bg-gray-50{% endif %} px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" 
                                class="w-full inline-flex justify-center {% if user.theme_preference == 'dark' %}cyber-button-primary{% else %}bg-blue-600 text-white{% endif %} rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                            اعطای امتیاز
                        </button>
                        <button type="button" 
                                @click="showAwardPointsModal = false"
                                class="mt-3 w-full inline-flex justify-center {% if user.theme_preference == 'dark' %}cyber-button-secondary{% else %}bg-white text-gray-700 border border-gray-300{% endif %} rounded-md shadow-sm px-4 py-2 text-base font-medium hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            انصراف
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function customerLoyaltyDashboard() {
    return {
        darkMode: document.documentElement.classList.contains('dark'),
        showAwardPointsModal: false,
        awardPointsForm: {
            customer_id: '',
            points: '',
            reason: ''
        },
        
        initDashboard() {
            // Initialize dashboard functionality
            console.log('Customer Loyalty Dashboard initialized');
        },
        
        async awardPoints() {
            try {
                const formData = new FormData();
                formData.append('action', 'award_points');
                formData.append('customer_id', this.awardPointsForm.customer_id);
                formData.append('points', this.awardPointsForm.points);
                formData.append('reason', this.awardPointsForm.reason);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const response = await fetch('{% url "customers:loyalty_ajax" %}', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    this.showNotification(data.message, 'success');
                    
                    // Reset form and close modal
                    this.awardPointsForm = { customer_id: '', points: '', reason: '' };
                    this.showAwardPointsModal = false;
                    
                    // Reload page to show updated data
                    setTimeout(() => location.reload(), 1000);
                } else {
                    this.showNotification(data.error, 'error');
                }
            } catch (error) {
                this.showNotification('خطا در اعطای امتیاز', 'error');
            }
        },
        
        showNotification(message, type) {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-4 z-50 p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    }
}
</script>
{% endblock %}