{% extends "pos/base_pos.html" %}
{% load static %}

{% block title %}سیستم فروش لمسی - زرگر{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="{% if is_dark_mode %}#0B0E1A{% else %}#ffffff{% endif %}">

<style>
/* Touch-optimized styles */
.touch-btn {
    min-height: 60px;
    min-width: 60px;
    touch-action: manipulation;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

.touch-btn:active {
    transform: scale(0.95);
}

.pos-grid {
    display: grid;
    gap: 1rem;
    padding: 1rem;
}

@media (max-width: 768px) {
    .pos-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
        padding: 0.75rem;
    }
    
    .touch-btn {
        min-height: 70px;
        font-size: 1.1rem;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .pos-grid {
        grid-template-columns: 1fr 1fr;
    }
}

@media (min-width: 1025px) {
    .pos-grid {
        grid-template-columns: 2fr 1fr;
    }
}

/* High contrast for better visibility */
.high-contrast {
    {% if is_dark_mode %}
    background: linear-gradient(135deg, #0B0E1A 0%, #1A1D29 100%);
    color: #FFFFFF;
    border: 2px solid #00D4FF;
    {% else %}
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    color: #1f2937;
    border: 2px solid #3b82f6;
    {% endif %}
}

.high-contrast:hover {
    {% if is_dark_mode %}
    background: linear-gradient(135deg, #1A1D29 0%, #252A3A 100%);
    border-color: #00FF88;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    {% else %}
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-color: #2563eb;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    {% endif %}
}

/* Large touch targets */
.large-touch {
    min-height: 80px;
    font-size: 1.25rem;
    font-weight: 600;
}

/* Persian number display */
.persian-display {
    font-family: 'Vazirmatn', sans-serif;
    font-variant-numeric: tabular-nums;
}
</style>
{% endblock %}

{% block pos_content %}
<div class="touch-pos-container min-h-screen pt-16" 
     x-data="touchPOSInterface()" 
     x-init="init()">
    
    <!-- Main POS Grid -->
    <div class="pos-grid">
        
        <!-- Left Panel - Transaction Building -->
        <div class="transaction-panel space-y-4">
            
            <!-- Current Transaction Header -->
            <div class="transaction-header p-4 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-r from-cyber-bg-surface/80 to-cyber-bg-elevated/80
                        border border-cyber-neon-primary/30 shadow-cyber
                        {% else %}
                        bg-white border-2 border-blue-200 shadow-lg
                        {% endif %}">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        تراکنش جاری
                    </h2>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            شماره:
                        </span>
                        <span class="font-mono text-sm 
                                   {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                              x-text="currentTransaction.number">
                            جدید
                        </span>
                    </div>
                </div>
                
                <!-- Customer Info -->
                <div class="flex items-center justify-between p-3 rounded-lg
                           {% if is_dark_mode %}
                           bg-cyber-bg-surface/50 border border-cyber-neon-primary/20
                           {% else %}
                           bg-gray-50 border border-gray-200
                           {% endif %}">
                    <div>
                        <span class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            مشتری:
                        </span>
                        <span class="font-medium 
                                   {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                              x-text="currentTransaction.customer?.name || 'مشتری نقدی'"></span>
                    </div>
                    <button @click="selectCustomer()" 
                            class="touch-btn px-4 py-2 rounded-lg transition-all duration-200
                                   {% if is_dark_mode %}
                                   bg-cyber-neon-secondary/20 border border-cyber-neon-secondary/30
                                   text-cyber-neon-secondary hover:bg-cyber-neon-secondary/30
                                   {% else %}
                                   bg-green-50 border border-green-200 text-green-600 hover:bg-green-100
                                   {% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Transaction Items -->
            <div class="transaction-items 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80
                        border border-cyber-neon-primary/30 shadow-cyber
                        {% else %}
                        bg-white border-2 border-gray-200 shadow-lg
                        {% endif %}
                        rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        اقلام تراکنش
                    </h3>
                    <span class="text-sm 
                                {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                        <span class="persian-numbers" x-text="currentTransaction.items.length"></span> قلم
                    </span>
                </div>
                
                <!-- Items List -->
                <div class="space-y-2 max-h-64 overflow-y-auto" x-show="currentTransaction.items.length > 0">
                    <template x-for="(item, index) in currentTransaction.items" :key="index">
                        <div class="flex items-center justify-between p-3 rounded-lg
                                   {% if is_dark_mode %}
                                   bg-cyber-bg-surface/30 border border-cyber-neon-primary/10
                                   {% else %}
                                   bg-gray-50 border border-gray-100
                                   {% endif %}">
                            <div class="flex-1">
                                <div class="font-medium 
                                           {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                     x-text="item.name"></div>
                                <div class="text-sm 
                                           {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                    <span class="persian-numbers" x-text="item.quantity"></span> × 
                                    <span class="persian-numbers" x-text="formatCurrency(item.unit_price)"></span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <span class="font-bold persian-numbers
                                           {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                                      x-text="formatCurrency(item.line_total)"></span>
                                <button @click="removeItem(index)" 
                                        class="touch-btn p-2 rounded-lg transition-colors
                                               {% if is_dark_mode %}
                                               text-cyber-neon-danger hover:bg-cyber-neon-danger/20
                                               {% else %}
                                               text-red-600 hover:bg-red-50
                                               {% endif %}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Empty State -->
                <div x-show="currentTransaction.items.length === 0" 
                     class="text-center py-8">
                    <svg class="w-16 h-16 mx-auto mb-4 
                               {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-400{% endif %}" 
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    <p class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                        هنوز محصولی اضافه نشده است
                    </p>
                </div>
                
                <!-- Transaction Totals -->
                <div x-show="currentTransaction.items.length > 0" 
                     class="mt-4 pt-4 space-y-2
                           {% if is_dark_mode %}border-t border-cyber-neon-primary/20{% else %}border-t border-gray-200{% endif %}">
                    <div class="flex justify-between">
                        <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            جمع کل:
                        </span>
                        <span class="font-bold persian-numbers text-lg
                                   {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                              x-text="formatCurrency(currentTransaction.total)"></span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Add Item Button -->
                <button @click="addItem()" 
                        class="touch-btn large-touch high-contrast rounded-xl transition-all duration-200 transform hover:scale-105">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span class="font-bold">افزودن کالا</span>
                    </div>
                </button>
                
                <!-- Calculator Button -->
                <button @click="openCalculator()" 
                        class="touch-btn large-touch rounded-xl transition-all duration-200 transform hover:scale-105
                               {% if is_dark_mode %}
                               bg-gradient-to-br from-cyber-neon-tertiary/20 to-cyber-neon-purple/20
                               border-2 border-cyber-neon-tertiary/30 text-cyber-text-primary
                               hover:border-cyber-neon-tertiary/50 hover:shadow-neon
                               {% else %}
                               bg-gradient-to-br from-orange-50 to-purple-50
                               border-2 border-orange-200 text-gray-800
                               hover:border-orange-300 hover:shadow-lg
                               {% endif %}">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <span class="font-bold">ماشین حساب</span>
                    </div>
                </button>
            </div>
        </div>
        
        <!-- Right Panel - Quick Actions & Payment -->
        <div class="actions-panel space-y-4">
            
            <!-- Gold Price Display -->
            <div class="gold-price-card p-4 rounded-xl
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80
                        border border-cyber-neon-secondary/30 shadow-cyber
                        {% else %}
                        bg-gradient-to-br from-yellow-50 to-orange-50
                        border-2 border-yellow-200 shadow-lg
                        {% endif %}">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        قیمت طلا
                    </h3>
                    <button @click="refreshGoldPrice()" 
                            class="touch-btn p-2 rounded-lg transition-colors
                                   {% if is_dark_mode %}
                                   text-cyber-neon-secondary hover:bg-cyber-bg-surface/50
                                   {% else %}
                                   text-yellow-600 hover:bg-yellow-100
                                   {% endif %}">
                        <svg class="w-5 h-5" :class="{ 'animate-spin': goldPriceLoading }" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            ۱۸ عیار:
                        </span>
                        <span class="font-bold persian-numbers
                                   {% if is_dark_mode %}text-cyber-neon-secondary{% else %}text-yellow-600{% endif %}" 
                              x-text="formatCurrency(goldPrices.karat18)"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            ۲۱ عیار:
                        </span>
                        <span class="font-bold persian-numbers
                                   {% if is_dark_mode %}text-cyber-neon-secondary{% else %}text-yellow-600{% endif %}" 
                              x-text="formatCurrency(goldPrices.karat21)"></span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Action Buttons -->
            <div class="grid grid-cols-1 gap-3">
                <button @click="searchInventory()" 
                        class="touch-btn large-touch rounded-xl transition-all duration-200 transform hover:scale-105
                               {% if is_dark_mode %}
                               bg-gradient-to-r from-cyber-neon-primary/20 to-cyber-neon-secondary/20
                               border-2 border-cyber-neon-primary/30 text-cyber-text-primary
                               hover:border-cyber-neon-primary/50 hover:shadow-neon
                               {% else %}
                               bg-gradient-to-r from-blue-50 to-green-50
                               border-2 border-blue-200 text-gray-800
                               hover:border-blue-300 hover:shadow-lg
                               {% endif %}">
                    <div class="flex items-center justify-center space-x-3 space-x-reverse">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <span class="font-bold">جستجوی کالا</span>
                    </div>
                </button>
                
                <button @click="selectCustomer()" 
                        class="touch-btn large-touch rounded-xl transition-all duration-200 transform hover:scale-105
                               {% if is_dark_mode %}
                               bg-gradient-to-r from-cyber-neon-secondary/20 to-cyber-neon-tertiary/20
                               border-2 border-cyber-neon-secondary/30 text-cyber-text-primary
                               hover:border-cyber-neon-secondary/50 hover:shadow-neon
                               {% else %}
                               bg-gradient-to-r from-green-50 to-orange-50
                               border-2 border-green-200 text-gray-800
                               hover:border-green-300 hover:shadow-lg
                               {% endif %}">
                    <div class="flex items-center justify-center space-x-3 space-x-reverse">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="font-bold">انتخاب مشتری</span>
                    </div>
                </button>
                
                <button @click="openSyncQueue()" 
                        class="touch-btn large-touch rounded-xl transition-all duration-200 transform hover:scale-105
                               {% if is_dark_mode %}
                               bg-gradient-to-r from-cyber-neon-warning/20 to-cyber-neon-primary/20
                               border-2 border-cyber-neon-warning/30 text-cyber-text-primary
                               hover:border-cyber-neon-warning/50 hover:shadow-neon
                               {% else %}
                               bg-gradient-to-r from-yellow-50 to-blue-50
                               border-2 border-yellow-200 text-gray-800
                               hover:border-yellow-300 hover:shadow-lg
                               {% endif %}">
                    <div class="flex items-center justify-center space-x-3 space-x-reverse">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="font-bold">صف همگام‌سازی</span>
                    </div>
                </button>
            </div>
            
            <!-- Payment Section -->
            <div x-show="currentTransaction.items.length > 0" 
                 class="payment-section p-4 rounded-xl
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80
                        border border-cyber-neon-success/30 shadow-cyber
                        {% else %}
                        bg-gradient-to-br from-green-50 to-blue-50
                        border-2 border-green-200 shadow-lg
                        {% endif %}">
                <h3 class="text-lg font-bold mb-4 
                          {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                    پرداخت
                </h3>
                
                <!-- Payment Method Selection -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button @click="setPaymentMethod('cash')"
                            :class="paymentMethod === 'cash' ? 'active' : ''"
                            class="payment-method-btn touch-btn p-3 rounded-lg text-sm font-medium transition-all duration-200
                                   {% if is_dark_mode %}
                                   bg-cyber-bg-surface/50 border border-cyber-neon-primary/30 text-cyber-text-primary
                                   hover:bg-cyber-bg-surface/70
                                   {% else %}
                                   bg-white border border-gray-300 text-gray-700 hover:bg-gray-50
                                   {% endif %}">
                        نقدی
                    </button>
                    <button @click="setPaymentMethod('card')"
                            :class="paymentMethod === 'card' ? 'active' : ''"
                            class="payment-method-btn touch-btn p-3 rounded-lg text-sm font-medium transition-all duration-200
                                   {% if is_dark_mode %}
                                   bg-cyber-bg-surface/50 border border-cyber-neon-primary/30 text-cyber-text-primary
                                   hover:bg-cyber-bg-surface/70
                                   {% else %}
                                   bg-white border border-gray-300 text-gray-700 hover:bg-gray-50
                                   {% endif %}">
                        کارتی
                    </button>
                </div>
                
                <!-- Amount Input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 
                                 {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                        مبلغ دریافتی (تومان)
                    </label>
                    <input type="number" 
                           x-model="amountPaid"
                           :placeholder="currentTransaction.total"
                           class="w-full p-3 rounded-lg border text-lg persian-display transition-all duration-200
                                  {% if is_dark_mode %}
                                  bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                  text-cyber-text-primary placeholder-cyber-text-secondary
                                  focus:border-cyber-neon-primary/50 focus:ring-2 focus:ring-cyber-neon-primary/20
                                  {% else %}
                                  bg-white border-gray-300 text-gray-900 placeholder-gray-500
                                  focus:border-blue-500 focus:ring-2 focus:ring-blue-200
                                  {% endif %}">
                </div>
                
                <!-- Change Display -->
                <div x-show="amountPaid > currentTransaction.total" 
                     class="mb-4 p-3 rounded-lg
                           {% if is_dark_mode %}
                           bg-cyber-neon-warning/20 border border-cyber-neon-warning/30
                           {% else %}
                           bg-yellow-50 border border-yellow-200
                           {% endif %}">
                    <div class="flex justify-between">
                        <span class="{% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                            باقی مانده:
                        </span>
                        <span class="font-bold persian-numbers
                                   {% if is_dark_mode %}text-cyber-neon-warning{% else %}text-yellow-600{% endif %}" 
                              x-text="formatCurrency(amountPaid - currentTransaction.total)"></span>
                    </div>
                </div>
                
                <!-- Complete Transaction Button -->
                <button @click="completeTransaction()" 
                        :disabled="!canCompleteTransaction"
                        class="w-full touch-btn large-touch rounded-xl font-bold transition-all duration-200 transform hover:scale-105
                               {% if is_dark_mode %}
                               bg-gradient-to-r from-cyber-neon-success/30 to-cyber-neon-secondary/30
                               border-2 border-cyber-neon-success/50 text-cyber-text-primary
                               hover:border-cyber-neon-success/70 hover:shadow-neon
                               disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none
                               {% else %}
                               bg-gradient-to-r from-green-500 to-blue-500 text-white
                               hover:from-green-600 hover:to-blue-600 hover:shadow-lg
                               disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none
                               {% endif %}">
                    <div class="flex items-center justify-center space-x-3 space-x-reverse">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>تکمیل تراکنش</span>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include "pos/components/customer_lookup_modal.html" %}
{% include "pos/components/inventory_search_modal.html" %}
{% include "pos/components/calculator_modal.html" %}

<!-- Offline Sync Components -->
{% include "pos/components/offline_sync_status.html" %}
{% include "pos/components/sync_queue_modal.html" %}
{% include "pos/components/conflict_resolution_modal.html" %}

<style>
.payment-method-btn.active {
    {% if is_dark_mode %}
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 212, 255, 0.2)) !important;
    border-color: rgba(0, 255, 136, 0.5) !important;
    color: #00FF88 !important;
    {% else %}
    background: linear-gradient(135deg, #dcfce7, #dbeafe) !important;
    border-color: #10b981 !important;
    color: #059669 !important;
    {% endif %}
}
</style>

<script>
function touchPOSInterface() {
    return {
        currentTransaction: {
            number: null,
            customer: null,
            items: [],
            total: 0
        },
        goldPrices: {
            karat18: 0,
            karat21: 0,
            karat24: 0
        },
        goldPriceLoading: false,
        paymentMethod: 'cash',
        amountPaid: 0,
        
        init() {
            this.loadGoldPrices();
            this.initializeEventListeners();
            this.generateTransactionNumber();
        },
        
        initializeEventListeners() {
            // Listen for customer selection
            window.addEventListener('customer-selected', (event) => {
                this.currentTransaction.customer = event.detail.customer;
            });
            
            // Listen for inventory item selection
            window.addEventListener('inventory-item-selected', (event) => {
                this.addInventoryItem(event.detail.item);
            });
            
            // Listen for custom item addition
            window.addEventListener('add-custom-item-requested', () => {
                this.addCustomItemPrompt();
            });
        },
        
        generateTransactionNumber() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.getTime().toString().slice(-4);
            this.currentTransaction.number = `POS-${dateStr}-${timeStr}`;
        },
        
        async loadGoldPrices() {
            this.goldPriceLoading = true;
            try {
                const response = await fetch('{% url "pos:api_gold_price" %}');
                const data = await response.json();
                if (data.success) {
                    this.goldPrices.karat18 = parseFloat(data.price_data.price_per_gram);
                    this.goldPrices.karat21 = this.goldPrices.karat18 * 1.167;
                    this.goldPrices.karat24 = this.goldPrices.karat18 * 1.333;
                }
            } catch (error) {
                console.error('Error loading gold prices:', error);
            } finally {
                this.goldPriceLoading = false;
            }
        },
        
        refreshGoldPrice() {
            this.loadGoldPrices();
        },
        
        selectCustomer() {
            if (window.POSModals) {
                window.POSModals.openCustomerLookup();
            }
        },
        
        addItem() {
            this.searchInventory();
        },
        
        searchInventory() {
            if (window.POSModals) {
                window.POSModals.openInventorySearch();
            }
        },
        
        openCalculator() {
            if (window.POSModals) {
                window.POSModals.openCalculator();
            }
        },
        
        addInventoryItem(item) {
            const existingItemIndex = this.currentTransaction.items.findIndex(
                transactionItem => transactionItem.id === item.id
            );
            
            if (existingItemIndex >= 0) {
                // Increase quantity if item already exists
                this.currentTransaction.items[existingItemIndex].quantity += 1;
                this.currentTransaction.items[existingItemIndex].line_total = 
                    this.currentTransaction.items[existingItemIndex].quantity * 
                    this.currentTransaction.items[existingItemIndex].unit_price;
            } else {
                // Add new item
                this.currentTransaction.items.push({
                    id: item.id,
                    name: item.name,
                    sku: item.sku,
                    quantity: 1,
                    unit_price: parseFloat(item.selling_price || 0),
                    line_total: parseFloat(item.selling_price || 0),
                    weight_grams: parseFloat(item.weight_grams || 0),
                    karat: parseInt(item.karat || 0)
                });
            }
            
            this.calculateTotal();
        },
        
        addCustomItemPrompt() {
            const name = prompt('نام محصول:');
            if (!name) return;
            
            const price = prompt('قیمت (تومان):');
            if (!price || isNaN(price)) return;
            
            const quantity = prompt('تعداد:', '1');
            if (!quantity || isNaN(quantity)) return;
            
            this.currentTransaction.items.push({
                id: 'custom-' + Date.now(),
                name: name,
                sku: 'CUSTOM',
                quantity: parseInt(quantity),
                unit_price: parseFloat(price),
                line_total: parseInt(quantity) * parseFloat(price),
                weight_grams: 0,
                karat: 0
            });
            
            this.calculateTotal();
        },
        
        removeItem(index) {
            this.currentTransaction.items.splice(index, 1);
            this.calculateTotal();
        },
        
        calculateTotal() {
            this.currentTransaction.total = this.currentTransaction.items.reduce(
                (sum, item) => sum + item.line_total, 0
            );
        },
        
        setPaymentMethod(method) {
            this.paymentMethod = method;
        },
        
        get canCompleteTransaction() {
            return this.currentTransaction.items.length > 0 && 
                   this.amountPaid >= this.currentTransaction.total;
        },
        
        async completeTransaction() {
            if (!this.canCompleteTransaction) return;
            
            try {
                // Create transaction via API
                const transactionData = {
                    customer_id: this.currentTransaction.customer?.id || null,
                    payment_method: this.paymentMethod,
                    amount_paid: this.amountPaid,
                    items: this.currentTransaction.items.map(item => ({
                        jewelry_item_id: item.id.toString().startsWith('custom-') ? null : item.id,
                        item_name: item.name,
                        quantity: item.quantity,
                        unit_price: item.unit_price
                    }))
                };
                
                const response = await fetch('{% url "pos:transaction_create" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.zargarConfig.csrfToken
                    },
                    body: JSON.stringify(transactionData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    this.showNotification('تراکنش با موفقیت تکمیل شد', 'success');
                    
                    // Reset transaction
                    this.resetTransaction();
                    
                    // Optionally redirect to invoice or print
                    if (confirm('آیا می‌خواهید فاکتور را چاپ کنید؟')) {
                        window.open(`/pos/invoice/${result.invoice_id}/pdf/`, '_blank');
                    }
                } else {
                    this.showNotification('خطا در تکمیل تراکنش: ' + result.error, 'error');
                }
                
            } catch (error) {
                console.error('Error completing transaction:', error);
                this.showNotification('خطا در ارتباط با سرور', 'error');
            }
        },
        
        resetTransaction() {
            this.currentTransaction = {
                number: null,
                customer: null,
                items: [],
                total: 0
            };
            this.amountPaid = 0;
            this.paymentMethod = 'cash';
            this.generateTransactionNumber();
        },
        
        showNotification(message, type = 'info') {
            // Use Alpine.js notification system from base template
            if (window.themeData && window.themeData.showNotification) {
                window.themeData.showNotification(message, type);
            } else {
                alert(message);
            }
        },
        
        openSyncQueue() {
            // Dispatch event to open sync queue modal
            window.dispatchEvent(new CustomEvent('open-sync-queue-modal'));
        },
        
        formatCurrency(amount) {
            if (!amount) return '۰ تومان';
            return new Intl.NumberFormat('fa-IR').format(amount) + ' تومان';
        }
    }
}
</script>
{% endblock %}