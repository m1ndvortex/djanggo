<!-- Customer Lookup Modal -->
<div x-data="customerLookupModal()" 
     x-show="showModal" 
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto"
     @keydown.escape="closeModal()">
    
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
         @click="closeModal()"></div>
    
    <!-- Modal Content -->
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative w-full max-w-2xl transform overflow-hidden rounded-xl 
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface to-cyber-bg-elevated
                    border border-cyber-neon-primary/30 shadow-cyber
                    {% else %}
                    bg-white border border-gray-200 shadow-xl
                    {% endif %}
                    transition-all duration-300"
             x-show="showModal"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">
            
            <!-- Header -->
            <div class="flex items-center justify-between p-6 
                        {% if is_dark_mode %}border-b border-cyber-neon-primary/20{% else %}border-b border-gray-200{% endif %}">
                <h3 class="text-xl font-bold 
                          {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                    جستجوی مشتری
                </h3>
                <button @click="closeModal()" 
                        class="p-2 rounded-lg transition-colors
                               {% if is_dark_mode %}
                               text-cyber-text-secondary hover:bg-cyber-bg-surface/50
                               {% else %}
                               text-gray-500 hover:bg-gray-100
                               {% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Search Input -->
            <div class="p-6 pb-4">
                <div class="relative">
                    <input type="text" 
                           x-model="searchQuery"
                           @input="searchCustomers()"
                           placeholder="نام، شماره تلفن یا کد مشتری را وارد کنید..."
                           class="w-full px-4 py-3 pr-12 rounded-lg border transition-all duration-200
                                  {% if is_dark_mode %}
                                  bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                  text-cyber-text-primary placeholder-cyber-text-secondary
                                  focus:border-cyber-neon-primary/50 focus:ring-2 focus:ring-cyber-neon-primary/20
                                  {% else %}
                                  bg-gray-50 border-gray-300 text-gray-900 placeholder-gray-500
                                  focus:border-blue-500 focus:ring-2 focus:ring-blue-200
                                  {% endif %}">
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                        <svg class="w-5 h-5 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-400{% endif %}" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div class="px-6 pb-6 max-h-96 overflow-y-auto">
                <!-- Loading State -->
                <div x-show="loading" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 
                                {% if is_dark_mode %}border-cyber-neon-primary{% else %}border-blue-600{% endif %} 
                                mx-auto mb-3"></div>
                    <p class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                        در حال جستجو...
                    </p>
                </div>
                
                <!-- No Results -->
                <div x-show="!loading && searchQuery && customers.length === 0" 
                     class="text-center py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 
                               {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-400{% endif %}" 
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <p class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                        مشتری یافت نشد
                    </p>
                    <button @click="createNewCustomer()" 
                            class="mt-3 px-4 py-2 rounded-lg transition-all duration-200
                                   {% if is_dark_mode %}
                                   bg-cyber-neon-primary/20 border border-cyber-neon-primary/30
                                   text-cyber-neon-primary hover:bg-cyber-neon-primary/30
                                   {% else %}
                                   bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-100
                                   {% endif %}">
                        ایجاد مشتری جدید
                    </button>
                </div>
                
                <!-- Customer List -->
                <div x-show="!loading && customers.length > 0" class="space-y-2">
                    <template x-for="customer in customers" :key="customer.id">
                        <div @click="selectCustomer(customer)"
                             class="p-4 rounded-lg border cursor-pointer transition-all duration-200
                                    {% if is_dark_mode %}
                                    bg-cyber-bg-surface/30 border-cyber-neon-primary/20
                                    hover:bg-cyber-bg-surface/50 hover:border-cyber-neon-primary/40
                                    {% else %}
                                    bg-gray-50 border-gray-200 hover:bg-blue-50 hover:border-blue-300
                                    {% endif %}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium 
                                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                        x-text="customer.name"></h4>
                                    <p class="text-sm 
                                             {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}" 
                                       x-text="customer.phone"></p>
                                    <p class="text-sm 
                                             {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}" 
                                       x-text="customer.email"></p>
                                </div>
                                <div class="text-left">
                                    <div class="text-sm font-medium 
                                               {% if is_dark_mode %}text-cyber-neon-secondary{% else %}text-green-600{% endif %}">
                                        <span x-text="customer.loyalty_points"></span> امتیاز
                                    </div>
                                    <div class="text-xs 
                                               {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                        مشتری وفادار
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Walk-in Customer Option -->
                <div x-show="!loading" class="mt-4 pt-4 
                            {% if is_dark_mode %}border-t border-cyber-neon-primary/20{% else %}border-t border-gray-200{% endif %}">
                    <button @click="selectWalkInCustomer()"
                            class="w-full p-4 rounded-lg border-2 border-dashed transition-all duration-200
                                   {% if is_dark_mode %}
                                   border-cyber-neon-tertiary/30 text-cyber-text-primary
                                   hover:border-cyber-neon-tertiary/50 hover:bg-cyber-bg-surface/30
                                   {% else %}
                                   border-gray-300 text-gray-700 hover:border-gray-400 hover:bg-gray-50
                                   {% endif %}">
                        <div class="flex items-center justify-center space-x-3 space-x-reverse">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span class="font-medium">مشتری نقدی (بدون ثبت اطلاعات)</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function customerLookupModal() {
    return {
        showModal: false,
        searchQuery: '',
        customers: [],
        loading: false,
        searchTimeout: null,
        
        openModal() {
            this.showModal = true;
            this.searchQuery = '';
            this.customers = [];
            // Focus on search input after modal opens
            this.$nextTick(() => {
                const input = this.$el.querySelector('input[type="text"]');
                if (input) input.focus();
            });
        },
        
        closeModal() {
            this.showModal = false;
            this.searchQuery = '';
            this.customers = [];
        },
        
        async searchCustomers() {
            if (this.searchQuery.length < 2) {
                this.customers = [];
                return;
            }
            
            // Clear previous timeout
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }
            
            // Debounce search
            this.searchTimeout = setTimeout(async () => {
                this.loading = true;
                try {
                    const response = await fetch(`{% url "pos:api_customer_lookup" %}?q=${encodeURIComponent(this.searchQuery)}`);
                    const data = await response.json();
                    if (data.success) {
                        this.customers = data.customers;
                    }
                } catch (error) {
                    console.error('Error searching customers:', error);
                } finally {
                    this.loading = false;
                }
            }, 300);
        },
        
        selectCustomer(customer) {
            // Emit custom event with selected customer
            window.dispatchEvent(new CustomEvent('customer-selected', {
                detail: { customer }
            }));
            this.closeModal();
        },
        
        selectWalkInCustomer() {
            // Emit custom event for walk-in customer
            window.dispatchEvent(new CustomEvent('customer-selected', {
                detail: { customer: null }
            }));
            this.closeModal();
        },
        
        createNewCustomer() {
            // Open customer creation form or redirect
            window.location.href = '/customers/create/?return_to=pos';
        }
    }
}

// Initialize modal when POS modals are requested
window.POSModals = window.POSModals || {};
window.POSModals.openCustomerLookup = function() {
    const modal = document.querySelector('[x-data*="customerLookupModal"]').__x.$data;
    modal.openModal();
};
</script>