<!-- Email Invoice Modal -->
<div x-show="showEmailModal" 
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 overflow-y-auto"
     style="display: none;">
    
    <!-- Backdrop -->
    <div class="fixed inset-0 
               {% if is_dark_mode %}
               bg-cyber-bg-primary/80
               {% else %}
               bg-black/50
               {% endif %}
               backdrop-blur-sm"
         @click="showEmailModal = false"></div>
    
    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen p-4">
        <div x-show="showEmailModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="w-full max-w-2xl rounded-2xl shadow-2xl
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface/95 to-cyber-bg-elevated/95
                    border border-cyber-neon-primary/30
                    {% else %}
                    bg-white border border-gray-200
                    {% endif %}
                    backdrop-blur-sm">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 
                        {% if is_dark_mode %}
                        border-b border-cyber-neon-primary/20
                        {% else %}
                        border-b border-gray-200
                        {% endif %}">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center
                               {% if is_dark_mode %}
                               bg-cyber-neon-tertiary/20 border border-cyber-neon-tertiary/30
                               {% else %}
                               bg-orange-100 border border-orange-200
                               {% endif %}">
                        <svg class="w-6 h-6 
                                   {% if is_dark_mode %}text-cyber-neon-tertiary{% else %}text-orange-600{% endif %}" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold 
                                  {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                            ارسال فاکتور از طریق ایمیل
                        </h2>
                        <p class="text-sm 
                                 {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            فاکتور {{ invoice.invoice_number }}
                        </p>
                    </div>
                </div>
                
                <button @click="showEmailModal = false" 
                        class="p-2 rounded-lg transition-colors
                               {% if is_dark_mode %}
                               text-cyber-text-secondary hover:bg-cyber-bg-surface/50
                               {% else %}
                               text-gray-400 hover:bg-gray-100
                               {% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <form @submit.prevent="sendEmail()" 
                  x-data="emailInvoiceForm()" 
                  class="p-6">
                
                <!-- Recipient Information -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        اطلاعات گیرنده
                    </h3>
                    
                    <!-- Customer Email (if available) -->
                    {% if invoice.transaction.customer and invoice.transaction.customer.email %}
                    <div class="mb-4 p-4 rounded-lg
                               {% if is_dark_mode %}
                               bg-cyber-bg-surface/50 border border-cyber-neon-secondary/20
                               {% else %}
                               bg-green-50 border border-green-200
                               {% endif %}">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium 
                                           {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                    {{ invoice.transaction.customer.full_persian_name }}
                                </div>
                                <div class="text-sm 
                                           {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                    {{ invoice.transaction.customer.email }}
                                </div>
                            </div>
                            <button type="button" 
                                    @click="form.recipient_email = '{{ invoice.transaction.customer.email }}'; form.recipient_name = '{{ invoice.transaction.customer.full_persian_name }}'"
                                    class="px-3 py-2 rounded-lg text-sm font-medium transition-colors
                                           {% if is_dark_mode %}
                                           bg-cyber-neon-secondary/20 border border-cyber-neon-secondary/30
                                           text-cyber-neon-secondary hover:bg-cyber-neon-secondary/30
                                           {% else %}
                                           bg-green-100 border border-green-300 text-green-700 hover:bg-green-200
                                           {% endif %}">
                                انتخاب
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 
                                         {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                                نام گیرنده <span class="text-red-500">*</span>
                            </label>
                            <input type="text" 
                                   x-model="form.recipient_name"
                                   required
                                   class="w-full px-4 py-3 rounded-lg border transition-all duration-200
                                          {% if is_dark_mode %}
                                          bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                          text-cyber-text-primary placeholder-cyber-text-secondary
                                          focus:border-cyber-neon-primary/50 focus:ring-2 focus:ring-cyber-neon-primary/20
                                          {% else %}
                                          bg-white border-gray-300 text-gray-900 placeholder-gray-500
                                          focus:border-blue-500 focus:ring-2 focus:ring-blue-200
                                          {% endif %}"
                                   placeholder="نام و نام خانوادگی">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 
                                         {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                                آدرس ایمیل <span class="text-red-500">*</span>
                            </label>
                            <input type="email" 
                                   x-model="form.recipient_email"
                                   required
                                   class="w-full px-4 py-3 rounded-lg border transition-all duration-200
                                          {% if is_dark_mode %}
                                          bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                          text-cyber-text-primary placeholder-cyber-text-secondary
                                          focus:border-cyber-neon-primary/50 focus:ring-2 focus:ring-cyber-neon-primary/20
                                          {% else %}
                                          bg-white border-gray-300 text-gray-900 placeholder-gray-500
                                          focus:border-blue-500 focus:ring-2 focus:ring-blue-200
                                          {% endif %}"
                                   placeholder="example@email.com">
                        </div>
                    </div>
                </div>
                
                <!-- Email Content -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        محتوای ایمیل
                    </h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2 
                                     {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                            موضوع ایمیل
                        </label>
                        <input type="text" 
                               x-model="form.subject"
                               class="w-full px-4 py-3 rounded-lg border transition-all duration-200
                                      {% if is_dark_mode %}
                                      bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                      text-cyber-text-primary placeholder-cyber-text-secondary
                                      focus:border-cyber-neon-primary/50 focus:ring-2 focus:ring-cyber-neon-primary/20
                                      {% else %}
                                      bg-white border-gray-300 text-gray-900 placeholder-gray-500
                                      focus:border-blue-500 focus:ring-2 focus:ring-blue-200
                                      {% endif %}"
                               placeholder="موضوع ایمیل">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 
                                     {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                            متن پیام
                        </label>
                        <textarea x-model="form.message"
                                  rows="6"
                                  class="w-full px-4 py-3 rounded-lg border transition-all duration-200
                                         {% if is_dark_mode %}
                                         bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                         text-cyber-text-primary placeholder-cyber-text-secondary
                                         focus:border-cyber-neon-primary/50 focus:ring-2 focus:ring-cyber-neon-primary/20
                                         {% else %}
                                         bg-white border-gray-300 text-gray-900 placeholder-gray-500
                                         focus:border-blue-500 focus:ring-2 focus:ring-blue-200
                                         {% endif %}"
                                  placeholder="متن پیام همراه با فاکتور..."></textarea>
                    </div>
                </div>
                
                <!-- Email Options -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        تنظیمات ارسال
                    </h3>
                    
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   x-model="form.include_pdf"
                                   class="rounded border-gray-300 
                                          {% if is_dark_mode %}
                                          bg-cyber-bg-surface/50 border-cyber-neon-primary/30
                                          text-cyber-neon-primary focus:ring-cyber-neon-primary/20
                                          {% else %}
                                          text-blue-600 focus:ring-blue-500
                                          {% endif %}">
                            <span class="mr-3 text-sm 
                                       {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                                ضمیمه کردن فایل PDF فاکتور
                            </span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   x-model="form.send_copy_to_self"
                                   class="rounded border-gray-300 
                                          {% if is_dark_mode %}
                                          bg-cyber-bg-surface/50 border-cyber-neon-primary/30
                                          text-cyber-neon-primary focus:ring-cyber-neon-primary/20
                                          {% else %}
                                          text-blue-600 focus:ring-blue-500
                                          {% endif %}">
                            <span class="mr-3 text-sm 
                                       {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                                ارسال کپی به خودم
                            </span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   x-model="form.request_read_receipt"
                                   class="rounded border-gray-300 
                                          {% if is_dark_mode %}
                                          bg-cyber-bg-surface/50 border-cyber-neon-primary/30
                                          text-cyber-neon-primary focus:ring-cyber-neon-primary/20
                                          {% else %}
                                          text-blue-600 focus:ring-blue-500
                                          {% endif %}">
                            <span class="mr-3 text-sm 
                                       {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %}">
                                درخواست تأیید خواندن
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- Email Templates -->
                <div class="mb-6">
                    <h3 class="font-bold mb-4 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        قالب‌های آماده
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button type="button" 
                                @click="useTemplate('formal')"
                                class="p-3 rounded-lg text-sm text-right transition-colors
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border border-cyber-neon-primary/30
                                       text-cyber-text-primary hover:bg-cyber-bg-surface/70
                                       {% else %}
                                       bg-gray-50 border border-gray-200 text-gray-700 hover:bg-gray-100
                                       {% endif %}">
                            <div class="font-medium mb-1">قالب رسمی</div>
                            <div class="text-xs 
                                       {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                پیام رسمی و تجاری
                            </div>
                        </button>
                        
                        <button type="button" 
                                @click="useTemplate('friendly')"
                                class="p-3 rounded-lg text-sm text-right transition-colors
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border border-cyber-neon-primary/30
                                       text-cyber-text-primary hover:bg-cyber-bg-surface/70
                                       {% else %}
                                       bg-gray-50 border border-gray-200 text-gray-700 hover:bg-gray-100
                                       {% endif %}">
                            <div class="font-medium mb-1">قالب دوستانه</div>
                            <div class="text-xs 
                                       {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                پیام صمیمی و گرم
                            </div>
                        </button>
                        
                        <button type="button" 
                                @click="useTemplate('reminder')"
                                class="p-3 rounded-lg text-sm text-right transition-colors
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border border-cyber-neon-primary/30
                                       text-cyber-text-primary hover:bg-cyber-bg-surface/70
                                       {% else %}
                                       bg-gray-50 border border-gray-200 text-gray-700 hover:bg-gray-100
                                       {% endif %}">
                            <div class="font-medium mb-1">قالب یادآوری</div>
                            <div class="text-xs 
                                       {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                یادآوری پرداخت
                            </div>
                        </button>
                        
                        <button type="button" 
                                @click="useTemplate('thank_you')"
                                class="p-3 rounded-lg text-sm text-right transition-colors
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border border-cyber-neon-primary/30
                                       text-cyber-text-primary hover:bg-cyber-bg-surface/70
                                       {% else %}
                                       bg-gray-50 border border-gray-200 text-gray-700 hover:bg-gray-100
                                       {% endif %}">
                            <div class="font-medium mb-1">قالب تشکر</div>
                            <div class="text-xs 
                                       {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                تشکر از خرید
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Error Messages -->
                <div x-show="errors.length > 0" 
                     class="mb-6 p-4 rounded-lg
                           {% if is_dark_mode %}
                           bg-cyber-neon-danger/20 border border-cyber-neon-danger/30
                           {% else %}
                           bg-red-50 border border-red-200
                           {% endif %}">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2 
                                   {% if is_dark_mode %}text-cyber-neon-danger{% else %}text-red-600{% endif %}" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-medium 
                                   {% if is_dark_mode %}text-cyber-neon-danger{% else %}text-red-800{% endif %}">
                            خطاهای ارسال:
                        </span>
                    </div>
                    <ul class="list-disc list-inside space-y-1">
                        <template x-for="error in errors" :key="error">
                            <li class="text-sm 
                                     {% if is_dark_mode %}text-cyber-neon-danger{% else %}text-red-700{% endif %}" 
                                x-text="error"></li>
                        </template>
                    </ul>
                </div>
                
                <!-- Success Message -->
                <div x-show="success" 
                     class="mb-6 p-4 rounded-lg
                           {% if is_dark_mode %}
                           bg-cyber-neon-success/20 border border-cyber-neon-success/30
                           {% else %}
                           bg-green-50 border border-green-200
                           {% endif %}">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2 
                                   {% if is_dark_mode %}text-cyber-neon-success{% else %}text-green-600{% endif %}" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="font-medium 
                                   {% if is_dark_mode %}text-cyber-neon-success{% else %}text-green-800{% endif %}">
                            فاکتور با موفقیت ارسال شد!
                        </span>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="flex items-center justify-end space-x-3 space-x-reverse">
                    <button type="button" 
                            @click="showEmailModal = false"
                            class="px-6 py-3 rounded-lg font-medium transition-colors
                                   {% if is_dark_mode %}
                                   text-cyber-text-secondary hover:bg-cyber-bg-surface/50
                                   {% else %}
                                   text-gray-600 hover:bg-gray-100
                                   {% endif %}">
                        انصراف
                    </button>
                    
                    <button type="submit" 
                            :disabled="sending"
                            class="px-6 py-3 rounded-lg font-bold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed
                                   {% if is_dark_mode %}
                                   bg-gradient-to-r from-cyber-neon-tertiary/30 to-cyber-neon-primary/30
                                   border-2 border-cyber-neon-tertiary/50 text-cyber-text-primary
                                   hover:border-cyber-neon-tertiary/70
                                   {% else %}
                                   bg-gradient-to-r from-orange-500 to-blue-500 text-white
                                   hover:from-orange-600 hover:to-blue-600
                                   {% endif %}">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <svg x-show="sending" 
                                 class="w-5 h-5 animate-spin" 
                                 fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" 
                                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <svg x-show="!sending" 
                                 class="w-5 h-5" 
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <span x-text="sending ? 'در حال ارسال...' : 'ارسال ایمیل'"></span>
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function emailInvoiceForm() {
    return {
        form: {
            recipient_name: '',
            recipient_email: '',
            subject: 'فاکتور فروش شماره {{ invoice.invoice_number }}',
            message: '',
            include_pdf: true,
            send_copy_to_self: false,
            request_read_receipt: false
        },
        errors: [],
        success: false,
        sending: false,
        
        templates: {
            formal: {
                subject: 'فاکتور فروش شماره {{ invoice.invoice_number }}',
                message: `با سلام و احترام،

فاکتور فروش شماره {{ invoice.invoice_number }} به تاریخ {{ invoice.issue_date_shamsi }} در پیوست ارسال می‌گردد.

لطفاً در صورت وجود هرگونه سؤال یا ابهام، با ما تماس بگیرید.

با تشکر
{{ tenant.name }}`
            },
            friendly: {
                subject: 'فاکتور خرید شما از {{ tenant.name }}',
                message: `سلام عزیز،

امیدوارم حالتان خوب باشه! فاکتور خریدتون رو براتون ارسال کردم.

اگه سؤالی داشتید، حتماً بهم بگید.

ممنون که ما رو انتخاب کردید! 😊

{{ tenant.name }}`
            },
            reminder: {
                subject: 'یادآوری فاکتور شماره {{ invoice.invoice_number }}',
                message: `با سلام،

این یادآوری مربوط به فاکتور شماره {{ invoice.invoice_number }} به تاریخ {{ invoice.issue_date_shamsi }} می‌باشد.

لطفاً در اولین فرصت نسبت به تسویه حساب اقدام فرمایید.

با تشکر از همکاری شما
{{ tenant.name }}`
            },
            thank_you: {
                subject: 'تشکر از خرید شما - فاکتور {{ invoice.invoice_number }}',
                message: `سلام و وقت بخیر،

از اینکه ما رو برای خریدتون انتخاب کردید، صمیمانه تشکر می‌کنیم.

فاکتور خریدتون رو در پیوست ارسال کردیم. امیدواریم از خریدتون راضی باشید.

منتظر دیدار مجددتون هستیم!

با سپاس
{{ tenant.name }}`
            }
        },
        
        validateForm() {
            this.errors = [];
            
            if (!this.form.recipient_name.trim()) {
                this.errors.push('نام گیرنده الزامی است');
            }
            
            if (!this.form.recipient_email.trim()) {
                this.errors.push('آدرس ایمیل الزامی است');
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.form.recipient_email)) {
                this.errors.push('فرمت ایمیل صحیح نیست');
            }
            
            if (!this.form.subject.trim()) {
                this.errors.push('موضوع ایمیل الزامی است');
            }
            
            return this.errors.length === 0;
        },
        
        useTemplate(templateName) {
            if (this.templates[templateName]) {
                this.form.subject = this.templates[templateName].subject;
                this.form.message = this.templates[templateName].message;
            }
        },
        
        async sendEmail() {
            if (!this.validateForm()) {
                return;
            }
            
            this.sending = true;
            this.success = false;
            
            try {
                const response = await fetch('{% url "pos:invoice_email" invoice.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(this.form)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.success = true;
                    this.errors = [];
                    
                    // Auto close after 3 seconds
                    setTimeout(() => {
                        this.showEmailModal = false;
                        this.resetForm();
                    }, 3000);
                } else {
                    this.errors = data.errors || ['خطا در ارسال ایمیل'];
                }
            } catch (error) {
                console.error('Send email error:', error);
                this.errors = ['خطا در ارتباط با سرور'];
            } finally {
                this.sending = false;
            }
        },
        
        resetForm() {
            this.form = {
                recipient_name: '',
                recipient_email: '',
                subject: 'فاکتور فروش شماره {{ invoice.invoice_number }}',
                message: '',
                include_pdf: true,
                send_copy_to_self: false,
                request_read_receipt: false
            };
            this.errors = [];
            this.success = false;
        }
    }
}
</script>