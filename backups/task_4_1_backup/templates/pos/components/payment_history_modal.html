<!-- Payment History Modal -->
<div x-show="showPaymentHistoryModal" 
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 overflow-y-auto"
     style="display: none;">
    
    <!-- Backdrop -->
    <div class="fixed inset-0 
               {% if is_dark_mode %}
               bg-cyber-bg-primary/80
               {% else %}
               bg-black/50
               {% endif %}
               backdrop-blur-sm"
         @click="showPaymentHistoryModal = false"></div>
    
    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen p-4">
        <div x-show="showPaymentHistoryModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="w-full max-w-6xl rounded-2xl shadow-2xl
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface/95 to-cyber-bg-elevated/95
                    border border-cyber-neon-primary/30
                    {% else %}
                    bg-white border border-gray-200
                    {% endif %}
                    backdrop-blur-sm">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 
                        {% if is_dark_mode %}
                        border-b border-cyber-neon-primary/20
                        {% else %}
                        border-b border-gray-200
                        {% endif %}">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center
                               {% if is_dark_mode %}
                               bg-cyber-neon-secondary/20 border border-cyber-neon-secondary/30
                               {% else %}
                               bg-green-100 border border-green-200
                               {% endif %}">
                        <svg class="w-6 h-6 
                                   {% if is_dark_mode %}text-cyber-neon-secondary{% else %}text-green-600{% endif %}" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold 
                                  {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                            تاریخچه پرداخت
                        </h2>
                        <p class="text-sm 
                                 {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}" 
                           x-text="selectedCustomer?.full_persian_name || selectedCustomer?.full_name"></p>
                    </div>
                </div>
                
                <button @click="showPaymentHistoryModal = false" 
                        class="p-2 rounded-lg transition-colors
                               {% if is_dark_mode %}
                               text-cyber-text-secondary hover:bg-cyber-bg-surface/50
                               {% else %}
                               text-gray-400 hover:bg-gray-100
                               {% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6" x-data="paymentHistoryData()" x-init="loadPaymentHistory()">
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="p-4 rounded-xl text-center
                               {% if is_dark_mode %}
                               bg-cyber-bg-surface/50 border border-cyber-neon-primary/20
                               {% else %}
                               bg-blue-50 border border-blue-200
                               {% endif %}">
                        <div class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            کل پرداخت‌ها
                        </div>
                        <div class="font-bold text-lg persian-numbers
                                   {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                             x-text="formatCurrency(paymentSummary.total_payments)"></div>
                    </div>
                    
                    <div class="p-4 rounded-xl text-center
                               {% if is_dark_mode %}
                               bg-cyber-bg-surface/50 border border-cyber-neon-success/20
                               {% else %}
                               bg-green-50 border border-green-200
                               {% endif %}">
                        <div class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            پرداخت‌های نقدی
                        </div>
                        <div class="font-bold text-lg persian-numbers
                                   {% if is_dark_mode %}text-cyber-neon-success{% else %}text-green-600{% endif %}" 
                             x-text="formatCurrency(paymentSummary.cash_payments)"></div>
                    </div>
                    
                    <div class="p-4 rounded-xl text-center
                               {% if is_dark_mode %}
                               bg-cyber-bg-surface/50 border border-cyber-neon-tertiary/20
                               {% else %}
                               bg-orange-50 border border-orange-200
                               {% endif %}">
                        <div class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            پرداخت‌های کارتی
                        </div>
                        <div class="font-bold text-lg persian-numbers
                                   {% if is_dark_mode %}text-cyber-neon-tertiary{% else %}text-orange-600{% endif %}" 
                             x-text="formatCurrency(paymentSummary.card_payments)"></div>
                    </div>
                    
                    <div class="p-4 rounded-xl text-center
                               {% if is_dark_mode %}
                               bg-cyber-bg-surface/50 border border-cyber-neon-danger/20
                               {% else %}
                               bg-red-50 border border-red-200
                               {% endif %}">
                        <div class="text-sm 
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                            بدهی باقی‌مانده
                        </div>
                        <div class="font-bold text-lg persian-numbers
                                   {% if is_dark_mode %}text-cyber-neon-danger{% else %}text-red-600{% endif %}" 
                             x-text="formatCurrency(paymentSummary.remaining_debt)"></div>
                    </div>
                </div>
                
                <!-- Filter and Search -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <select x-model="filterPeriod" @change="loadPaymentHistory()"
                                class="px-4 py-2 rounded-lg border transition-colors
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                       text-cyber-text-primary
                                       {% else %}
                                       bg-white border-gray-300 text-gray-900
                                       {% endif %}">
                            <option value="all">همه دوره‌ها</option>
                            <option value="month">ماه جاری</option>
                            <option value="quarter">سه ماه اخیر</option>
                            <option value="year">سال جاری</option>
                        </select>
                        
                        <select x-model="filterType" @change="loadPaymentHistory()"
                                class="px-4 py-2 rounded-lg border transition-colors
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border-cyber-neon-primary/30 
                                       text-cyber-text-primary
                                       {% else %}
                                       bg-white border-gray-300 text-gray-900
                                       {% endif %}">
                            <option value="all">همه نوع‌ها</option>
                            <option value="cash">نقدی</option>
                            <option value="card">کارتی</option>
                            <option value="bank_transfer">انتقال بانکی</option>
                            <option value="cheque">چک</option>
                        </select>
                    </div>
                    
                    <button @click="exportPaymentHistory()" 
                            class="px-4 py-2 rounded-lg font-medium transition-colors
                                   {% if is_dark_mode %}
                                   bg-cyber-neon-primary/20 border border-cyber-neon-primary/30
                                   text-cyber-neon-primary hover:bg-cyber-neon-primary/30
                                   {% else %}
                                   bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-100
                                   {% endif %}">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>خروجی Excel</span>
                        </div>
                    </button>
                </div>
                
                <!-- Payment History Table -->
                <div class="overflow-x-auto">
                    <div class="min-w-full 
                               {% if is_dark_mode %}
                               bg-cyber-bg-surface/30 border border-cyber-neon-primary/20
                               {% else %}
                               bg-white border border-gray-200
                               {% endif %}
                               rounded-xl overflow-hidden">
                        
                        <!-- Table Header -->
                        <div class="grid grid-cols-6 gap-4 p-4 font-bold text-sm
                                   {% if is_dark_mode %}
                                   bg-cyber-bg-surface/50 border-b border-cyber-neon-primary/20
                                   text-cyber-text-primary
                                   {% else %}
                                   bg-gray-50 border-b border-gray-200 text-gray-900
                                   {% endif %}">
                            <div>تاریخ</div>
                            <div>شماره فاکتور</div>
                            <div>نوع پرداخت</div>
                            <div>مبلغ</div>
                            <div>وضعیت</div>
                            <div>عملیات</div>
                        </div>
                        
                        <!-- Table Body -->
                        <div class="divide-y 
                                   {% if is_dark_mode %}divide-cyber-neon-primary/10{% else %}divide-gray-100{% endif %}">
                            <template x-for="payment in paymentHistory" :key="payment.id">
                                <div class="grid grid-cols-6 gap-4 p-4 items-center hover:bg-opacity-50 transition-colors
                                           {% if is_dark_mode %}
                                           text-cyber-text-primary hover:bg-cyber-bg-surface/30
                                           {% else %}
                                           text-gray-900 hover:bg-gray-50
                                           {% endif %}">
                                    
                                    <!-- Date -->
                                    <div class="persian-numbers" x-text="payment.date_shamsi"></div>
                                    
                                    <!-- Invoice Number -->
                                    <div>
                                        <a :href="payment.invoice_url" 
                                           class="font-medium 
                                                 {% if is_dark_mode %}text-cyber-neon-primary hover:text-cyber-neon-secondary{% else %}text-blue-600 hover:text-blue-800{% endif %}"
                                           x-text="payment.invoice_number"></a>
                                    </div>
                                    
                                    <!-- Payment Method -->
                                    <div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium"
                                              :class="{
                                                  'cash': '{% if is_dark_mode %}bg-cyber-neon-success/20 text-cyber-neon-success{% else %}bg-green-100 text-green-700{% endif %}',
                                                  'card': '{% if is_dark_mode %}bg-cyber-neon-primary/20 text-cyber-neon-primary{% else %}bg-blue-100 text-blue-700{% endif %}',
                                                  'bank_transfer': '{% if is_dark_mode %}bg-cyber-neon-tertiary/20 text-cyber-neon-tertiary{% else %}bg-orange-100 text-orange-700{% endif %}',
                                                  'cheque': '{% if is_dark_mode %}bg-cyber-neon-purple/20 text-cyber-neon-purple{% else %}bg-purple-100 text-purple-700{% endif %}'
                                              }[payment.payment_method]"
                                              x-text="payment.payment_method_display"></span>
                                    </div>
                                    
                                    <!-- Amount -->
                                    <div class="font-bold persian-numbers
                                               {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                                         x-text="formatCurrency(payment.amount)"></div>
                                    
                                    <!-- Status -->
                                    <div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium"
                                              :class="{
                                                  'completed': '{% if is_dark_mode %}bg-cyber-neon-success/20 text-cyber-neon-success{% else %}bg-green-100 text-green-700{% endif %}',
                                                  'pending': '{% if is_dark_mode %}bg-cyber-neon-warning/20 text-cyber-neon-warning{% else %}bg-yellow-100 text-yellow-700{% endif %}',
                                                  'failed': '{% if is_dark_mode %}bg-cyber-neon-danger/20 text-cyber-neon-danger{% else %}bg-red-100 text-red-700{% endif %}'
                                              }[payment.status]"
                                              x-text="payment.status_display"></span>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="flex space-x-2 space-x-reverse">
                                        <button @click="viewPaymentDetails(payment)" 
                                                class="p-1 rounded transition-colors
                                                       {% if is_dark_mode %}
                                                       text-cyber-neon-primary hover:bg-cyber-bg-surface/50
                                                       {% else %}
                                                       text-blue-600 hover:bg-blue-50
                                                       {% endif %}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                        <button @click="downloadInvoice(payment)" 
                                                class="p-1 rounded transition-colors
                                                       {% if is_dark_mode %}
                                                       text-cyber-neon-secondary hover:bg-cyber-bg-surface/50
                                                       {% else %}
                                                       text-green-600 hover:bg-green-50
                                                       {% endif %}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Empty State -->
                        <div x-show="paymentHistory.length === 0 && !loading" 
                             class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 
                                       {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-400{% endif %}" 
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-lg font-medium mb-2 
                                      {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                تاریخچه پرداختی یافت نشد
                            </h3>
                            <p class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                این مشتری هنوز پرداختی انجام نداده است
                            </p>
                        </div>
                        
                        <!-- Loading State -->
                        <div x-show="loading" 
                             class="text-center py-12">
                            <svg class="w-8 h-8 mx-auto mb-4 animate-spin 
                                       {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-500{% endif %}" 
                                 fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" 
                                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="{% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-600{% endif %}">
                                در حال بارگذاری تاریخچه پرداخت...
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div x-show="totalPages > 1" 
                     class="flex items-center justify-between mt-6">
                    <div class="text-sm 
                               {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                        نمایش <span class="persian-numbers" x-text="((currentPage - 1) * pageSize) + 1"></span> تا 
                        <span class="persian-numbers" x-text="Math.min(currentPage * pageSize, totalRecords)"></span> از 
                        <span class="persian-numbers" x-text="totalRecords"></span> رکورد
                    </div>
                    
                    <div class="flex space-x-2 space-x-reverse">
                        <button @click="previousPage()" 
                                :disabled="currentPage === 1"
                                class="px-3 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border border-cyber-neon-primary/30
                                       text-cyber-text-primary hover:bg-cyber-bg-surface/70
                                       {% else %}
                                       bg-white border border-gray-300 text-gray-700 hover:bg-gray-50
                                       {% endif %}">
                            قبلی
                        </button>
                        
                        <template x-for="page in visiblePages" :key="page">
                            <button @click="goToPage(page)" 
                                    :class="page === currentPage ? 'active' : ''"
                                    class="px-3 py-2 rounded-lg transition-colors
                                           {% if is_dark_mode %}
                                           bg-cyber-bg-surface/50 border border-cyber-neon-primary/30
                                           text-cyber-text-primary hover:bg-cyber-bg-surface/70
                                           {% else %}
                                           bg-white border border-gray-300 text-gray-700 hover:bg-gray-50
                                           {% endif %}"
                                    x-text="page"></button>
                        </template>
                        
                        <button @click="nextPage()" 
                                :disabled="currentPage === totalPages"
                                class="px-3 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed
                                       {% if is_dark_mode %}
                                       bg-cyber-bg-surface/50 border border-cyber-neon-primary/30
                                       text-cyber-text-primary hover:bg-cyber-bg-surface/70
                                       {% else %}
                                       bg-white border border-gray-300 text-gray-700 hover:bg-gray-50
                                       {% endif %}">
                            بعدی
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 space-x-reverse p-6 
                        {% if is_dark_mode %}
                        border-t border-cyber-neon-primary/20
                        {% else %}
                        border-t border-gray-200
                        {% endif %}">
                <button @click="recordNewPayment()" 
                        class="px-6 py-2 rounded-lg font-medium transition-colors
                               {% if is_dark_mode %}
                               bg-cyber-neon-success/20 border border-cyber-neon-success/30
                               text-cyber-neon-success hover:bg-cyber-neon-success/30
                               {% else %}
                               bg-green-50 border border-green-200 text-green-600 hover:bg-green-100
                               {% endif %}">
                    ثبت پرداخت جدید
                </button>
                <button @click="showPaymentHistoryModal = false" 
                        class="px-6 py-2 rounded-lg font-medium transition-colors
                               {% if is_dark_mode %}
                               text-cyber-text-secondary hover:bg-cyber-bg-surface/50
                               {% else %}
                               text-gray-600 hover:bg-gray-100
                               {% endif %}">
                    بستن
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function paymentHistoryData() {
    return {
        paymentHistory: [],
        paymentSummary: {
            total_payments: 0,
            cash_payments: 0,
            card_payments: 0,
            remaining_debt: 0
        },
        loading: false,
        filterPeriod: 'all',
        filterType: 'all',
        currentPage: 1,
        pageSize: 10,
        totalPages: 1,
        totalRecords: 0,
        
        async loadPaymentHistory() {
            if (!this.selectedCustomer) return;
            
            this.loading = true;
            
            try {
                const params = new URLSearchParams({
                    customer_id: this.selectedCustomer.id,
                    period: this.filterPeriod,
                    type: this.filterType,
                    page: this.currentPage,
                    page_size: this.pageSize
                });
                
                const response = await fetch(`{% url 'pos:api_payment_history' %}?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    this.paymentHistory = data.payments;
                    this.paymentSummary = data.summary;
                    this.totalPages = data.total_pages;
                    this.totalRecords = data.total_records;
                } else {
                    console.error('Payment history load failed:', data.error);
                }
            } catch (error) {
                console.error('Payment history load error:', error);
            } finally {
                this.loading = false;
            }
        },
        
        get visiblePages() {
            const pages = [];
            const start = Math.max(1, this.currentPage - 2);
            const end = Math.min(this.totalPages, this.currentPage + 2);
            
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }
            
            return pages;
        },
        
        goToPage(page) {
            this.currentPage = page;
            this.loadPaymentHistory();
        },
        
        previousPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadPaymentHistory();
            }
        },
        
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadPaymentHistory();
            }
        },
        
        viewPaymentDetails(payment) {
            // Open payment details modal or navigate to payment detail page
            window.open(payment.invoice_url, '_blank');
        },
        
        downloadInvoice(payment) {
            // Download invoice PDF
            window.open(payment.invoice_pdf_url, '_blank');
        },
        
        exportPaymentHistory() {
            if (!this.selectedCustomer) return;
            
            const params = new URLSearchParams({
                customer_id: this.selectedCustomer.id,
                period: this.filterPeriod,
                type: this.filterType,
                format: 'excel'
            });
            
            window.open(`{% url 'pos:api_payment_history_export' %}?${params}`, '_blank');
        },
        
        recordNewPayment() {
            // Open new payment modal
            this.showPaymentHistoryModal = false;
            // Trigger new payment modal
            window.dispatchEvent(new CustomEvent('open-payment-modal', {
                detail: this.selectedCustomer
            }));
        },
        
        formatCurrency(amount) {
            if (!amount) return '۰ تومان';
            
            // Convert to Persian digits
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const formatted = new Intl.NumberFormat('fa-IR').format(amount);
            
            return formatted.replace(/\d/g, (digit) => persianDigits[digit]) + ' تومان';
        }
    }
}
</script>