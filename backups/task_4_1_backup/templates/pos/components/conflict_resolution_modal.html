{% load static %}

<!-- Conflict Resolution Modal -->
<div class="conflict-resolution-modal fixed inset-0 z-50 overflow-y-auto" 
     x-data="conflictResolutionModal()" 
     x-show="showModal"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     style="display: none;">
    
    <!-- Modal Overlay -->
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" @click="closeModal()"></div>
    
    <!-- Modal Content -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative w-full max-w-5xl rounded-xl shadow-2xl
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface to-cyber-bg-elevated
                    border border-cyber-neon-warning/50
                    {% else %}
                    bg-white border border-orange-200
                    {% endif %}"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 
                        {% if is_dark_mode %}border-b border-cyber-neon-warning/30{% else %}border-b border-orange-200{% endif %}">
                <div class="flex items-center space-x-3 space-x-reverse">
                    <svg class="w-6 h-6 
                               {% if is_dark_mode %}text-cyber-neon-warning{% else %}text-orange-600{% endif %}" 
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h2 class="text-xl font-bold 
                              {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        حل تعارض همگام‌سازی
                    </h2>
                </div>
                
                <button @click="closeModal()" 
                        class="p-2 rounded-lg transition-colors
                               {% if is_dark_mode %}
                               text-cyber-text-secondary hover:text-cyber-text-primary hover:bg-cyber-bg-surface/50
                               {% else %}
                               text-gray-400 hover:text-gray-600 hover:bg-gray-100
                               {% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Warning Banner -->
            <div class="p-4 m-6 rounded-lg
                        {% if is_dark_mode %}
                        bg-cyber-neon-warning/20 border border-cyber-neon-warning/30
                        {% else %}
                        bg-orange-50 border border-orange-200
                        {% endif %}">
                <div class="flex items-start space-x-3 space-x-reverse">
                    <svg class="w-5 h-5 mt-0.5 flex-shrink-0 
                               {% if is_dark_mode %}text-cyber-neon-warning{% else %}text-orange-500{% endif %}" 
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold 
                                  {% if is_dark_mode %}text-cyber-neon-warning{% else %}text-orange-800{% endif %}">
                            تعارض در همگام‌سازی شناسایی شد
                        </h3>
                        <p class="text-sm mt-1 
                                 {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-orange-700{% endif %}">
                            برخی تراکنش‌ها با داده‌های موجود در سرور تعارض دارند. لطفاً برای هر تعارض تصمیم بگیرید.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 max-h-96 overflow-y-auto pos-scrollbar">
                
                <!-- Conflicts List -->
                <div class="space-y-6">
                    <template x-for="(conflict, index) in conflicts" :key="conflict.offline_id">
                        <div class="conflict-item p-4 rounded-lg border
                                    {% if is_dark_mode %}
                                    bg-cyber-bg-surface/30 border-cyber-neon-warning/30
                                    {% else %}
                                    bg-orange-50 border-orange-200
                                    {% endif %}">
                            
                            <!-- Conflict Header -->
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold 
                                          {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                    تعارض <span class="persian-numbers" x-text="index + 1"></span>: 
                                    <span x-text="conflict.transaction_number"></span>
                                </h3>
                                <span class="px-3 py-1 text-sm rounded-full
                                            {% if is_dark_mode %}
                                            bg-cyber-neon-warning/20 text-cyber-neon-warning border border-cyber-neon-warning/30
                                            {% else %}
                                            bg-orange-100 text-orange-800 border border-orange-200
                                            {% endif %}">
                                    <span x-text="getConflictTypeDisplay(conflict.conflict_type)"></span>
                                </span>
                            </div>
                            
                            <!-- Conflict Description -->
                            <div class="mb-4 p-3 rounded-lg
                                        {% if is_dark_mode %}
                                        bg-cyber-bg-surface/50 border border-cyber-neon-primary/20
                                        {% else %}
                                        bg-gray-50 border border-gray-200
                                        {% endif %}">
                                <p class="text-sm 
                                         {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                    <strong>علت تعارض:</strong> <span x-text="conflict.conflict_description"></span>
                                </p>
                            </div>
                            
                            <!-- Data Comparison -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                
                                <!-- Local Data -->
                                <div class="p-4 rounded-lg
                                            {% if is_dark_mode %}
                                            bg-cyber-bg-surface/50 border border-cyber-neon-primary/20
                                            {% else %}
                                            bg-blue-50 border border-blue-200
                                            {% endif %}">
                                    <h4 class="font-bold mb-3 
                                              {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-800{% endif %}">
                                        داده‌های محلی (آفلاین)
                                    </h4>
                                    
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                تاریخ تراکنش:
                                            </span>
                                            <span class="{% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                                  x-text="formatDate(conflict.local_data.transaction_date)"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                مبلغ کل:
                                            </span>
                                            <span class="font-medium persian-numbers
                                                        {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                                                  x-text="formatCurrency(conflict.local_data.total_amount)"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                تعداد اقلام:
                                            </span>
                                            <span class="persian-numbers
                                                        {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                                  x-text="conflict.local_data.line_items?.length || 0"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                روش پرداخت:
                                            </span>
                                            <span class="{% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                                  x-text="getPaymentMethodDisplay(conflict.local_data.payment_method)"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Server Data -->
                                <div class="p-4 rounded-lg
                                            {% if is_dark_mode %}
                                            bg-cyber-bg-surface/50 border border-cyber-neon-success/20
                                            {% else %}
                                            bg-green-50 border border-green-200
                                            {% endif %}">
                                    <h4 class="font-bold mb-3 
                                              {% if is_dark_mode %}text-cyber-neon-success{% else %}text-green-800{% endif %}">
                                        داده‌های سرور (آنلاین)
                                    </h4>
                                    
                                    <div x-show="conflict.server_data" class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                تاریخ تراکنش:
                                            </span>
                                            <span class="{% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                                  x-text="formatDate(conflict.server_data?.transaction_date)"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                مبلغ کل:
                                            </span>
                                            <span class="font-medium persian-numbers
                                                        {% if is_dark_mode %}text-cyber-neon-success{% else %}text-green-600{% endif %}" 
                                                  x-text="formatCurrency(conflict.server_data?.total_amount)"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                تعداد اقلام:
                                            </span>
                                            <span class="persian-numbers
                                                        {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                                  x-text="conflict.server_data?.line_items?.length || 0"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                روش پرداخت:
                                            </span>
                                            <span class="{% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}" 
                                                  x-text="getPaymentMethodDisplay(conflict.server_data?.payment_method)"></span>
                                        </div>
                                    </div>
                                    
                                    <div x-show="!conflict.server_data" 
                                         class="text-sm text-center py-4 
                                               {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                                        داده‌ای در سرور یافت نشد
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resolution Options -->
                            <div class="resolution-options">
                                <h4 class="font-bold mb-3 
                                          {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                    انتخاب راه‌حل:
                                </h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <!-- Use Local Data -->
                                    <label class="resolution-option cursor-pointer">
                                        <input type="radio" 
                                               :name="'resolution_' + conflict.offline_id"
                                               value="use_local"
                                               x-model="resolutions[conflict.offline_id]"
                                               class="sr-only">
                                        <div class="p-3 rounded-lg border-2 transition-all duration-200
                                                    {% if is_dark_mode %}
                                                    border-cyber-neon-primary/30 hover:border-cyber-neon-primary/50
                                                    {% else %}
                                                    border-blue-200 hover:border-blue-300
                                                    {% endif %}"
                                             :class="{
                                                 '{% if is_dark_mode %}border-cyber-neon-primary bg-cyber-neon-primary/20{% else %}border-blue-500 bg-blue-50{% endif %}': resolutions[conflict.offline_id] === 'use_local'
                                             }">
                                            <div class="flex items-center space-x-2 space-x-reverse">
                                                <svg class="w-5 h-5 
                                                           {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}" 
                                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                <span class="font-medium text-sm 
                                                            {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                                    استفاده از داده محلی
                                                </span>
                                            </div>
                                            <p class="text-xs mt-1 
                                                     {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                داده‌های آفلاین را حفظ کن
                                            </p>
                                        </div>
                                    </label>
                                    
                                    <!-- Use Server Data -->
                                    <label class="resolution-option cursor-pointer" 
                                           x-show="conflict.server_data">
                                        <input type="radio" 
                                               :name="'resolution_' + conflict.offline_id"
                                               value="use_server"
                                               x-model="resolutions[conflict.offline_id]"
                                               class="sr-only">
                                        <div class="p-3 rounded-lg border-2 transition-all duration-200
                                                    {% if is_dark_mode %}
                                                    border-cyber-neon-success/30 hover:border-cyber-neon-success/50
                                                    {% else %}
                                                    border-green-200 hover:border-green-300
                                                    {% endif %}"
                                             :class="{
                                                 '{% if is_dark_mode %}border-cyber-neon-success bg-cyber-neon-success/20{% else %}border-green-500 bg-green-50{% endif %}': resolutions[conflict.offline_id] === 'use_server'
                                             }">
                                            <div class="flex items-center space-x-2 space-x-reverse">
                                                <svg class="w-5 h-5 
                                                           {% if is_dark_mode %}text-cyber-neon-success{% else %}text-green-600{% endif %}" 
                                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                          d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v4a2 2 0 01-2 2H5z"></path>
                                                </svg>
                                                <span class="font-medium text-sm 
                                                            {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                                    استفاده از داده سرور
                                                </span>
                                            </div>
                                            <p class="text-xs mt-1 
                                                     {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                داده‌های آنلاین را اولویت بده
                                            </p>
                                        </div>
                                    </label>
                                    
                                    <!-- Skip Transaction -->
                                    <label class="resolution-option cursor-pointer">
                                        <input type="radio" 
                                               :name="'resolution_' + conflict.offline_id"
                                               value="skip"
                                               x-model="resolutions[conflict.offline_id]"
                                               class="sr-only">
                                        <div class="p-3 rounded-lg border-2 transition-all duration-200
                                                    {% if is_dark_mode %}
                                                    border-cyber-neon-danger/30 hover:border-cyber-neon-danger/50
                                                    {% else %}
                                                    border-red-200 hover:border-red-300
                                                    {% endif %}"
                                             :class="{
                                                 '{% if is_dark_mode %}border-cyber-neon-danger bg-cyber-neon-danger/20{% else %}border-red-500 bg-red-50{% endif %}': resolutions[conflict.offline_id] === 'skip'
                                             }">
                                            <div class="flex items-center space-x-2 space-x-reverse">
                                                <svg class="w-5 h-5 
                                                           {% if is_dark_mode %}text-cyber-neon-danger{% else %}text-red-600{% endif %}" 
                                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                          d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                                                </svg>
                                                <span class="font-medium text-sm 
                                                            {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                                                    رد کردن تراکنش
                                                </span>
                                            </div>
                                            <p class="text-xs mt-1 
                                                     {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                                                تراکنش را همگام‌سازی نکن
                                            </p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 
                        {% if is_dark_mode %}border-t border-cyber-neon-warning/30{% else %}border-t border-orange-200{% endif %}">
                
                <!-- Resolution Summary -->
                <div class="text-sm 
                           {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                    <span class="persian-numbers" x-text="getResolvedCount()"></span> از 
                    <span class="persian-numbers" x-text="conflicts.length"></span> تعارض حل شده
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center space-x-3 space-x-reverse">
                    <button @click="closeModal()" 
                            class="px-4 py-2 rounded-lg font-medium transition-colors
                                   {% if is_dark_mode %}
                                   bg-cyber-bg-surface/50 border border-cyber-neon-primary/20 text-cyber-text-secondary
                                   hover:text-cyber-text-primary
                                   {% else %}
                                   bg-gray-50 border border-gray-200 text-gray-600
                                   hover:bg-gray-100
                                   {% endif %}">
                        انصراف
                    </button>
                    
                    <button @click="applyResolutions()" 
                            :disabled="!canApplyResolutions()"
                            class="px-6 py-2 rounded-lg font-medium transition-all duration-200
                                   {% if is_dark_mode %}
                                   bg-cyber-neon-success/30 border border-cyber-neon-success/50 text-cyber-neon-success
                                   hover:bg-cyber-neon-success/40 disabled:opacity-50
                                   {% else %}
                                   bg-green-500 text-white hover:bg-green-600 disabled:opacity-50
                                   {% endif %}">
                        اعمال راه‌حل‌ها
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function conflictResolutionModal() {
    return {
        showModal: false,
        conflicts: [],
        resolutions: {},
        isResolving: false,
        
        init() {
            // Listen for conflict detection event
            window.addEventListener('sync-conflicts-detected', (event) => {
                this.openModal(event.detail.conflicts);
            });
        },
        
        openModal(conflicts) {
            this.conflicts = conflicts || [];
            this.resolutions = {};
            
            // Initialize resolutions object
            this.conflicts.forEach(conflict => {
                this.resolutions[conflict.offline_id] = null;
            });
            
            this.showModal = true;
        },
        
        closeModal() {
            this.showModal = false;
            this.conflicts = [];
            this.resolutions = {};
        },
        
        getResolvedCount() {
            return Object.values(this.resolutions).filter(resolution => 
                resolution !== null
            ).length;
        },
        
        canApplyResolutions() {
            return this.getResolvedCount() === this.conflicts.length && !this.isResolving;
        },
        
        async applyResolutions() {
            if (!this.canApplyResolutions()) return;
            
            this.isResolving = true;
            
            try {
                const response = await fetch('{% url "pos:api_offline_resolve_conflicts" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        device_id: this.getDeviceId(),
                        device_name: 'POS Terminal',
                        resolution_actions: this.resolutions
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.POSInterface?.showNotification(
                        'تعارض‌ها با موفقیت حل شدند',
                        'success'
                    );
                    
                    // Dispatch event to update sync status
                    window.dispatchEvent(new CustomEvent('conflicts-resolved', {
                        detail: { results: data.resolution_results }
                    }));
                    
                    this.closeModal();
                } else {
                    throw new Error(data.error || 'Resolution failed');
                }
                
            } catch (error) {
                window.POSInterface?.showNotification(
                    'خطا در حل تعارض: ' + error.message,
                    'error'
                );
            } finally {
                this.isResolving = false;
            }
        },
        
        getConflictTypeDisplay(conflictType) {
            const types = {
                'duplicate_transaction': 'تراکنش تکراری',
                'inventory_conflict': 'تعارض موجودی',
                'customer_conflict': 'تعارض مشتری',
                'price_conflict': 'تعارض قیمت',
                'data_mismatch': 'عدم تطابق داده‌ها'
            };
            return types[conflictType] || conflictType;
        },
        
        getPaymentMethodDisplay(paymentMethod) {
            const methods = {
                'cash': 'نقدی',
                'card': 'کارتی',
                'bank_transfer': 'انتقال بانکی',
                'cheque': 'چک',
                'gold_exchange': 'مبادله طلا',
                'mixed': 'ترکیبی'
            };
            return methods[paymentMethod] || paymentMethod;
        },
        
        formatCurrency(amount) {
            if (!amount) return '۰ تومان';
            
            const formatted = new Intl.NumberFormat('fa-IR').format(amount);
            return this.toPersianDigits(formatted) + ' تومان';
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            
            const date = new Date(dateStr);
            return date.toLocaleDateString('fa-IR');
        },
        
        toPersianDigits(str) {
            const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
            const englishDigits = '0123456789';
            
            return str.toString().replace(/[0-9]/g, function(w) {
                return persianDigits[englishDigits.indexOf(w)];
            });
        },
        
        getDeviceId() {
            let deviceId = localStorage.getItem('pos_device_id');
            if (!deviceId) {
                deviceId = 'POS-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('pos_device_id', deviceId);
            }
            return deviceId;
        },
        
        getCSRFToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            return token ? token.value : window.zargarConfig?.csrfToken || '';
        }
    }
}
</script>