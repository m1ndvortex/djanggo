{% extends 'base_rtl.html' %}
{% load persian_tags %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Edit Contract" %} {{ object.contract_number }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/gold-installments.css' %}" rel="stylesheet">
<link href="{% static 'css/persian-forms.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">{% trans "Edit Contract" %}</h1>
                    <p class="text-muted">
                        {% trans "Contract" %}: {{ object.contract_number }} - 
                        {{ object.customer.persian_first_name }} {{ object.customer.persian_last_name }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'gold_installments:contract_detail' object.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        {% trans "Back to Contract" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Warning for Active Contracts -->
    {% if object.status == 'active' and object.payments.exists %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-3"></i>
                <div>
                    <strong>{% trans "Warning" %}:</strong>
                    {% trans "This contract has existing payments. Some changes may affect payment calculations. Please review carefully before saving." %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contract Edit Form -->
    <form method="post" id="contract-edit-form">
        {% csrf_token %}
        
        <div class="row">
            <!-- Basic Contract Information -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-file-contract me-2"></i>
                            {% trans "Contract Information" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">{% trans "Contract Number" %}</label>
                            <input type="text" class="form-control" value="{{ object.contract_number }}" readonly>
                            <div class="form-text">{% trans "Contract number cannot be changed" %}</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.customer.id_for_label }}" class="form-label">
                                {{ form.customer.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.customer }}
                            {% if form.customer.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.customer.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.customer.help_text }}</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.contract_date.id_for_label }}" class="form-label">
                                {{ form.contract_date.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.contract_date }}
                            {% if form.contract_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.contract_date.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.initial_gold_weight_grams.id_for_label }}" class="form-label">
                                        {{ form.initial_gold_weight_grams.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.initial_gold_weight_grams }}
                                    {% if form.initial_gold_weight_grams.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.initial_gold_weight_grams.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if object.payments.exists %}
                                        <div class="form-text text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            {% trans "Changing this may affect existing payment calculations" %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.gold_karat.id_for_label }}" class="form-label">
                                        {{ form.gold_karat.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.gold_karat }}
                                    {% if form.gold_karat.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.gold_karat.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Terms -->
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-calendar-alt me-2"></i>
                            {% trans "Payment Terms" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.payment_schedule.id_for_label }}" class="form-label">
                                {{ form.payment_schedule.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.payment_schedule }}
                            {% if form.payment_schedule.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.payment_schedule.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.payment_amount_per_period.id_for_label }}" class="form-label">
                                {{ form.payment_amount_per_period.label }}
                            </label>
                            {{ form.payment_amount_per_period }}
                            {% if form.payment_amount_per_period.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.payment_amount_per_period.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.payment_amount_per_period.help_text }}</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.early_payment_discount_percentage.id_for_label }}" class="form-label">
                                {{ form.early_payment_discount_percentage.label }}
                            </label>
                            {{ form.early_payment_discount_percentage }}
                            {% if form.early_payment_discount_percentage.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.early_payment_discount_percentage.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.early_payment_discount_percentage.help_text }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Price Protection -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-shield-alt me-2"></i>
                            {% trans "Price Protection Settings" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.has_price_protection }}
                                <label class="form-check-label" for="{{ form.has_price_protection.id_for_label }}">
                                    {{ form.has_price_protection.label }}
                                </label>
                            </div>
                            {% if form.has_price_protection.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.has_price_protection.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.has_price_protection.help_text }}</div>
                        </div>

                        <div id="price-protection-options" class="{% if not form.has_price_protection.value %}d-none{% endif %}">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.price_ceiling_per_gram.id_for_label }}" class="form-label">
                                            {{ form.price_ceiling_per_gram.label }}
                                        </label>
                                        {{ form.price_ceiling_per_gram }}
                                        {% if form.price_ceiling_per_gram.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.price_ceiling_per_gram.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.price_ceiling_per_gram.help_text }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.price_floor_per_gram.id_for_label }}" class="form-label">
                                            {{ form.price_floor_per_gram.label }}
                                        </label>
                                        {{ form.price_floor_per_gram }}
                                        {% if form.price_floor_per_gram.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.price_floor_per_gram.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.price_floor_per_gram.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Terms -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-file-alt me-2"></i>
                            {% trans "Contract Terms and Conditions" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.contract_terms_persian.id_for_label }}" class="form-label">
                                {{ form.contract_terms_persian.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.contract_terms_persian }}
                            {% if form.contract_terms_persian.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.contract_terms_persian.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.contract_terms_persian.help_text }}</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.special_conditions.id_for_label }}" class="form-label">
                                {{ form.special_conditions.label }}
                            </label>
                            {{ form.special_conditions }}
                            {% if form.special_conditions.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.special_conditions.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.special_conditions.help_text }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'gold_installments:contract_detail' object.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                {% trans "Cancel" %}
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" id="preview-changes">
                                    <i class="fas fa-eye me-2"></i>
                                    {% trans "Preview Changes" %}
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    {% trans "Save Changes" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Changes Preview Modal -->
<div class="modal fade" id="changesPreviewModal" tabindex="-1" aria-labelledby="changesPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changesPreviewModalLabel">{% trans "Contract Changes Preview" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="changes-preview-content">
                    <!-- Changes preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <button type="button" class="btn btn-primary" onclick="$('#contract-edit-form').submit();">
                    {% trans "Save Changes" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/gold-installments.js' %}"></script>
<script>
$(document).ready(function() {
    // Price protection toggle
    $('#{{ form.has_price_protection.id_for_label }}').change(function() {
        if ($(this).is(':checked')) {
            $('#price-protection-options').removeClass('d-none');
        } else {
            $('#price-protection-options').addClass('d-none');
        }
    });
    
    // Preview changes
    $('#preview-changes').click(function() {
        // Generate changes preview
        const originalData = {
            customer: '{{ object.customer.persian_first_name }} {{ object.customer.persian_last_name }}',
            contract_date: '{{ object.contract_date_shamsi }}',
            initial_weight: '{{ object.initial_gold_weight_grams }}',
            gold_karat: '{{ object.gold_karat }}',
            payment_schedule: '{{ object.get_payment_schedule_display }}',
            has_price_protection: {{ object.has_price_protection|yesno:"true,false" }}
        };
        
        const currentData = {
            customer: $('#{{ form.customer.id_for_label }} option:selected').text(),
            contract_date: $('#{{ form.contract_date.id_for_label }}').val(),
            initial_weight: $('#{{ form.initial_gold_weight_grams.id_for_label }}').val(),
            gold_karat: $('#{{ form.gold_karat.id_for_label }}').val(),
            payment_schedule: $('#{{ form.payment_schedule.id_for_label }} option:selected').text(),
            has_price_protection: $('#{{ form.has_price_protection.id_for_label }}').is(':checked')
        };
        
        let changesHtml = '<div class="table-responsive"><table class="table table-bordered"><thead><tr><th>{% trans "Field" %}</th><th>{% trans "Current Value" %}</th><th>{% trans "New Value" %}</th></tr></thead><tbody>';
        
        let hasChanges = false;
        
        Object.keys(originalData).forEach(function(key) {
            if (originalData[key] != currentData[key]) {
                hasChanges = true;
                changesHtml += `
                    <tr class="table-warning">
                        <td><strong>${key.replace('_', ' ').toUpperCase()}</strong></td>
                        <td>${originalData[key]}</td>
                        <td><strong>${currentData[key]}</strong></td>
                    </tr>
                `;
            }
        });
        
        changesHtml += '</tbody></table></div>';
        
        if (!hasChanges) {
            changesHtml = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>{% trans "No changes detected." %}</div>';
        }
        
        $('#changes-preview-content').html(changesHtml);
        $('#changesPreviewModal').modal('show');
    });
    
    // Form validation
    $('#contract-edit-form').submit(function(e) {
        const hasPayments = {{ object.payments.exists|yesno:"true,false" }};
        const initialWeightChanged = parseFloat($('#{{ form.initial_gold_weight_grams.id_for_label }}').val()) !== {{ object.initial_gold_weight_grams }};
        
        if (hasPayments && initialWeightChanged) {
            if (!confirm('{% trans "Changing the initial gold weight may affect existing payment calculations. Are you sure you want to continue?" %}')) {
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>
{% endblock %}