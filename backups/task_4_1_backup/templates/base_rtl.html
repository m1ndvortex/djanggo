<!DOCTYPE html>
<html dir="rtl" lang="fa" class="{{ current_theme }}" x-data="themeData()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="{% if is_dark_mode %}#0B0E1A{% else %}#f9fafb{% endif %}">
    <meta name="description" content="{% block meta_description %}زرگر - سیستم مدیریت طلا و جواهرات{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}زرگر، طلا، جواهرات، مدیریت، فروش{% endblock %}">
    
    <title>{% block title %}زرگر - سیستم مدیریت طلا و جواهرات{% endblock %}</title>
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Persian Fonts - Multiple weights for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&family=Yekan+Bakh:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS with RTL support -->
    <script src="https://cdn.tailwindcss.com?v=3.4.0"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            direction: 'rtl',
            theme: {
                extend: {
                    fontFamily: {
                        'vazir': ['Vazirmatn', 'Tahoma', 'Arial', 'sans-serif'],
                        'yekan': ['Yekan Bakh', 'Vazirmatn', 'Tahoma', 'sans-serif'],
                    },
                    colors: {
                        // Light theme colors
                        'light': {
                            'bg-primary': '#f9fafb',
                            'bg-secondary': '#ffffff',
                            'bg-surface': '#f3f4f6',
                            'text-primary': '#111827',
                            'text-secondary': '#6b7280',
                            'text-muted': '#9ca3af',
                            'border': '#e5e7eb',
                            'accent': '#3b82f6',
                            'accent-hover': '#2563eb',
                        },
                        // Cybersecurity theme colors
                        'cyber': {
                            'bg-primary': '#0B0E1A',
                            'bg-secondary': '#1A1D29',
                            'bg-surface': '#252A3A',
                            'bg-elevated': '#2D3348',
                            'bg-glass': 'rgba(255, 255, 255, 0.03)',
                            'neon-primary': '#00D4FF',
                            'neon-secondary': '#00FF88',
                            'neon-tertiary': '#FF6B35',
                            'neon-warning': '#FFB800',
                            'neon-danger': '#FF4757',
                            'neon-success': '#00FF88',
                            'neon-purple': '#A55EEA',
                            'text-primary': '#FFFFFF',
                            'text-secondary': '#B8BCC8',
                            'text-muted': '#6B7280',
                            'text-neon': '#00D4FF',
                            'text-numbers': '#00FF88',
                            'border-glass': 'rgba(255, 255, 255, 0.06)',
                            'border-neon': 'rgba(0, 212, 255, 0.2)',
                        }
                    },
                    animation: {
                        'neon-pulse': 'neon-pulse 2s ease-in-out infinite alternate',
                        'cyber-glow': 'cyber-glow 3s ease-in-out infinite',
                        'slide-in-right': 'slide-in-right 0.3s ease-out',
                        'slide-in-left': 'slide-in-left 0.3s ease-out',
                        'fade-in-up': 'fade-in-up 0.4s ease-out',
                    },
                    keyframes: {
                        'neon-pulse': {
                            'from': { boxShadow: '0 0 20px rgba(0, 212, 255, 0.1)' },
                            'to': { boxShadow: '0 0 30px rgba(0, 212, 255, 0.3), 0 0 60px rgba(0, 255, 136, 0.1)' }
                        },
                        'cyber-glow': {
                            '0%, 100%': { textShadow: '0 0 5px #00D4FF' },
                            '50%': { textShadow: '0 0 10px #00D4FF, 0 0 20px #00D4FF, 0 0 30px #00D4FF' }
                        },
                        'slide-in-right': {
                            'from': { transform: 'translateX(100%)', opacity: '0' },
                            'to': { transform: 'translateX(0)', opacity: '1' }
                        },
                        'slide-in-left': {
                            'from': { transform: 'translateX(-100%)', opacity: '0' },
                            'to': { transform: 'translateX(0)', opacity: '1' }
                        },
                        'fade-in-up': {
                            'from': { transform: 'translateY(20px)', opacity: '0' },
                            'to': { transform: 'translateY(0)', opacity: '1' }
                        }
                    },
                    backdropBlur: {
                        'xs': '2px',
                    },
                    boxShadow: {
                        'cyber': '0 12px 40px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.03)',
                        'cyber-hover': '0 16px 50px rgba(0, 0, 0, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.05)',
                        'neon': '0 8px 32px rgba(0, 212, 255, 0.15), 0 0 20px rgba(0, 212, 255, 0.1)',
                        'neon-hover': '0 12px 40px rgba(0, 212, 255, 0.25), 0 0 30px rgba(0, 212, 255, 0.2)',
                    }
                }
            }
        }
    </script>
    
    <!-- Flowbite Components -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Framer Motion for cybersecurity theme animations -->
    <script src="https://unpkg.com/framer-motion@10.16.16/dist/framer-motion.js"></script>
    
    <!-- Custom CSS -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/base-rtl.css' %}">
    
    <!-- Theme and Persian utilities -->
    <script>
        // Global configuration
        window.zargarConfig = {
            csrfToken: '{{ csrf_token }}',
            currentTheme: '{{ current_theme }}',
            isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},
            userRole: '{% if user.is_authenticated %}{{ user.role }}{% endif %}',
            locale: 'fa',
            direction: 'rtl',
            apiEndpoints: {
                themeToggle: '/theme/toggle/',
                goldPrice: '/api/gold-prices/',
            }
        };
        
        // Alpine.js theme data
        function themeData() {
            return {
                darkMode: '{{ current_theme }}' === 'dark',
                sidebarOpen: false,
                loading: false,
                notifications: [],
                
                init() {
                    this.$watch('darkMode', value => {
                        if (window.themeManager) {
                            window.themeManager.applyTheme(value ? 'dark' : 'light');
                        }
                    });
                    
                    // Initialize theme manager
                    if (window.themeManager) {
                        window.themeManager.init();
                    }
                },
                
                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    if (window.themeManager) {
                        window.themeManager.toggleTheme();
                    }
                },
                
                showNotification(message, type = 'info', duration = 5000) {
                    const notification = {
                        id: Date.now(),
                        message,
                        type,
                        show: true
                    };
                    
                    this.notifications.push(notification);
                    
                    setTimeout(() => {
                        notification.show = false;
                        setTimeout(() => {
                            this.notifications = this.notifications.filter(n => n.id !== notification.id);
                        }, 300);
                    }, duration);
                }
            }
        }
    </script>
    
    {% block extra_head %}{% endblock %}
</head>

<body class="font-vazir transition-all duration-300 min-h-screen
             {% if is_dark_mode %}
             bg-gradient-to-br from-cyber-bg-primary via-cyber-bg-secondary to-cyber-bg-surface text-cyber-text-primary
             {% else %}
             bg-light-bg-primary text-light-text-primary
             {% endif %}"
      :class="{ 'dark': darkMode, 'light': !darkMode }">

    <!-- Theme Toggle Button (Fixed Position) -->
    <div class="fixed top-4 left-4 z-50">
        <button 
            @click="toggleTheme()"
            data-theme-toggle
            class="p-3 rounded-lg transition-all duration-300 backdrop-blur-sm
                   {% if is_dark_mode %}
                   bg-gradient-to-r from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                   border border-cyber-neon-primary/20 
                   hover:border-cyber-neon-primary/40 
                   hover:shadow-lg hover:shadow-cyber-neon-primary/20
                   {% else %}
                   bg-white/80 border border-gray-200 
                   hover:bg-white hover:border-gray-300 
                   shadow-sm hover:shadow-md
                   {% endif %}"
            aria-label="تغییر تم">
            
            <!-- Light Mode Icon -->
            <svg class="theme-light-icon w-5 h-5 {% if is_dark_mode %}hidden{% endif %} text-gray-600" 
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            
            <!-- Dark Mode Icon -->
            <svg class="theme-dark-icon w-5 h-5 {% if not is_dark_mode %}hidden{% endif %} text-cyber-neon-primary" 
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div x-show="loading" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center backdrop-blur-sm
                {% if is_dark_mode %}bg-cyber-bg-primary/90{% else %}bg-white/90{% endif %}">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 
                        {% if is_dark_mode %}border-cyber-neon-primary{% else %}border-blue-600{% endif %} 
                        mx-auto mb-4"></div>
            <p class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                در حال بارگذاری...
            </p>
        </div>
    </div>

    <!-- Navigation -->
    {% block navigation %}
    {% endblock %}

    <!-- Main Content -->
    <main class="min-h-screen {% block main_classes %}{% endblock %}">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    {% block footer %}
    {% endblock %}

    <!-- Notifications -->
    <div class="fixed top-20 right-4 z-40 space-y-2" x-show="notifications.length > 0">
        <template x-for="notification in notifications" :key="notification.id">
            <div x-show="notification.show"
                 x-transition:enter="transition ease-out duration-300 transform"
                 x-transition:enter-start="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="transition ease-in duration-200 transform"
                 x-transition:leave-start="translate-x-0 opacity-100"
                 x-transition:leave-end="translate-x-full opacity-0"
                 class="max-w-sm p-4 rounded-lg shadow-lg backdrop-blur-sm transition-all duration-300"
                 :class="{
                     'bg-red-900/80 border border-red-500/50 text-red-200': notification.type === 'error' && darkMode,
                     'bg-red-50 border border-red-200 text-red-800': notification.type === 'error' && !darkMode,
                     'bg-yellow-900/80 border border-yellow-500/50 text-yellow-200': notification.type === 'warning' && darkMode,
                     'bg-yellow-50 border border-yellow-200 text-yellow-800': notification.type === 'warning' && !darkMode,
                     'bg-green-900/80 border border-green-500/50 text-green-200': notification.type === 'success' && darkMode,
                     'bg-green-50 border border-green-200 text-green-800': notification.type === 'success' && !darkMode,
                     'bg-cyber-bg-surface/80 border border-cyber-neon-primary/30 text-cyber-text-primary': notification.type === 'info' && darkMode,
                     'bg-blue-50 border border-blue-200 text-blue-800': notification.type === 'info' && !darkMode
                 }">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium" x-text="notification.message"></p>
                    <button @click="notification.show = false" 
                            class="mr-2 text-current opacity-70 hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Django Messages -->
    {% if messages %}
    <div class="fixed top-20 right-4 z-40 space-y-2">
        {% for message in messages %}
        <div class="max-w-sm p-4 rounded-lg shadow-lg backdrop-blur-sm transition-all duration-300 animate-slide-in-right
                    {% if message.tags == 'error' %}
                        {% if is_dark_mode %}bg-red-900/80 border border-red-500/50 text-red-200{% else %}bg-red-50 border border-red-200 text-red-800{% endif %}
                    {% elif message.tags == 'warning' %}
                        {% if is_dark_mode %}bg-yellow-900/80 border border-yellow-500/50 text-yellow-200{% else %}bg-yellow-50 border border-yellow-200 text-yellow-800{% endif %}
                    {% elif message.tags == 'success' %}
                        {% if is_dark_mode %}bg-green-900/80 border border-green-500/50 text-green-200{% else %}bg-green-50 border border-green-200 text-green-800{% endif %}
                    {% else %}
                        {% if is_dark_mode %}bg-cyber-bg-surface/80 border border-cyber-neon-primary/30 text-cyber-text-primary{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}
                    {% endif %}"
             x-data="{ show: true }" 
             x-show="show"
             x-init="setTimeout(() => show = false, 5000)">
            <div class="flex items-center justify-between">
                <p class="text-sm font-medium">{{ message }}</p>
                <button @click="show = false" class="mr-2 text-current opacity-70 hover:opacity-100 transition-opacity">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <script src="{% static 'js/theme-toggle.js' %}"></script>
    <script src="{% static 'js/persian-utils.js' %}"></script>
    <script src="{% static 'js/rtl-components.js' %}"></script>
    
    {% block extra_scripts %}{% endblock %}
    
    <!-- Initialize components -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Persian number formatting
            const persianNumberElements = document.querySelectorAll('.persian-numbers');
            persianNumberElements.forEach(element => {
                if (window.PersianNumbers) {
                    element.textContent = window.PersianNumbers.toPersian(element.textContent);
                }
            });
            
            // Initialize RTL utilities
            if (window.RTLUtils) {
                window.RTLUtils.initializeComponents();
            }
            
            // Initialize cybersecurity animations if in dark mode
            if (document.body.classList.contains('dark') && window.Motion) {
                window.themeManager?.initCyberAnimations();
            }
        });
    </script>
</body>
</html>