{% extends 'base_rtl.html' %}
{% load persian_tags %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Notification Details" %} - {{ notification.title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/notifications.css' %}" rel="stylesheet">
<style>
.notification-detail-card {
    border-right: 4px solid #17a2b8;
}
.notification-detail-card.pending { border-right-color: #ffc107; }
.notification-detail-card.sent { border-right-color: #28a745; }
.notification-detail-card.failed { border-right-color: #dc3545; }
.notification-detail-card.delivered { border-right-color: #007bff; }
.notification-detail-card.cancelled { border-right-color: #6c757d; }

.status-timeline {
    position: relative;
    padding-right: 2rem;
}

.status-timeline::before {
    content: '';
    position: absolute;
    right: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    right: 0.75rem;
    top: 0.25rem;
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: #6c757d;
}

.timeline-item.success::before { background: #28a745; }
.timeline-item.warning::before { background: #ffc107; }
.timeline-item.danger::before { background: #dc3545; }
.timeline-item.info::before { background: #17a2b8; }

.message-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    font-family: 'Vazir', sans-serif;
    direction: rtl;
}

.provider-response {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    max-height: 300px;
    overflow-y: auto;
}

.delivery-method-badge {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.delivery-method-badge.sms { background-color: #007bff; color: white; }
.delivery-method-badge.email { background-color: #28a745; color: white; }
.delivery-method-badge.push { background-color: #ffc107; color: white; }
.delivery-method-badge.whatsapp { background-color: #25d366; color: white; }

/* Dark mode styles */
[data-theme="dark"] .notification-detail-card {
    background: rgba(26, 29, 41, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

[data-theme="dark"] .message-preview,
[data-theme="dark"] .provider-response {
    background: rgba(37, 42, 58, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.06);
    color: #ffffff;
}

[data-theme="dark"] .status-timeline::before {
    background: rgba(255, 255, 255, 0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">{% trans "Notification Details" %}</h1>
                    <p class="text-muted">{{ notification.title }}</p>
                </div>
                <div>
                    <a href="{% url 'core:notifications:history' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-right me-2"></i>
                        {% trans "Back to History" %}
                    </a>
                    {% if notification.status == 'pending' or notification.status == 'queued' %}
                    <button class="btn btn-danger" onclick="cancelNotification()">
                        <i class="fas fa-times me-2"></i>
                        {% trans "Cancel" %}
                    </button>
                    {% elif notification.status == 'failed' and notification.can_retry %}
                    <button class="btn btn-warning" onclick="retryNotification()">
                        <i class="fas fa-redo me-2"></i>
                        {% trans "Retry" %}
                    </button>
                    {% endif %}
                    <button class="btn btn-primary" onclick="duplicateNotification()">
                        <i class="fas fa-copy me-2"></i>
                        {% trans "Duplicate" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Details -->
        <div class="col-lg-8">
            <!-- Notification Overview -->
            <div class="card notification-detail-card {{ notification.status }} shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Notification Overview" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>{% trans "ID:" %}</strong></td>
                                    <td>{{ notification.notification_id }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{% trans "Status:" %}</strong></td>
                                    <td>
                                        <span class="badge 
                                            {% if notification.status == 'pending' %}bg-warning
                                            {% elif notification.status == 'queued' %}bg-info
                                            {% elif notification.status == 'sending' %}bg-primary
                                            {% elif notification.status == 'sent' %}bg-success
                                            {% elif notification.status == 'delivered' %}bg-info
                                            {% elif notification.status == 'failed' %}bg-danger
                                            {% elif notification.status == 'cancelled' %}bg-secondary
                                            {% else %}bg-secondary{% endif %}">
                                            {{ notification.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>{% trans "Priority:" %}</strong></td>
                                    <td>
                                        <span class="badge 
                                            {% if notification.priority == 'urgent' %}bg-danger
                                            {% elif notification.priority == 'high' %}bg-warning
                                            {% elif notification.priority == 'normal' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ notification.get_priority_display }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>{% trans "Delivery Method:" %}</strong></td>
                                    <td>
                                        <span class="delivery-method-badge {{ notification.delivery_method }}">
                                            {% if notification.delivery_method == 'sms' %}
                                                <i class="fas fa-sms"></i>
                                            {% elif notification.delivery_method == 'email' %}
                                                <i class="fas fa-envelope"></i>
                                            {% elif notification.delivery_method == 'push' %}
                                                <i class="fas fa-mobile-alt"></i>
                                            {% elif notification.delivery_method == 'whatsapp' %}
                                                <i class="fab fa-whatsapp"></i>
                                            {% endif %}
                                            {{ notification.get_delivery_method_display }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>{% trans "Template:" %}</strong></td>
                                    <td>
                                        {% if notification.template %}
                                            <a href="{% url 'core:notifications:template_edit' notification.template.id %}">
                                                {{ notification.template.name }}
                                            </a>
                                            <br><small class="text-muted">{{ notification.template.get_template_type_display }}</small>
                                        {% else %}
                                            <span class="text-muted">{% trans "Custom message" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>{% trans "Created:" %}</strong></td>
                                    <td>{{ notification.created_at|date:"Y/m/d H:i:s" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{% trans "Scheduled:" %}</strong></td>
                                    <td>{{ notification.scheduled_at|date:"Y/m/d H:i:s" }}</td>
                                </tr>
                                {% if notification.expires_at %}
                                <tr>
                                    <td><strong>{% trans "Expires:" %}</strong></td>
                                    <td>
                                        {{ notification.expires_at|date:"Y/m/d H:i:s" }}
                                        {% if notification.is_expired %}
                                            <span class="badge bg-danger ms-2">{% trans "Expired" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipient Information -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Recipient Information" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>{% trans "Name:" %}</strong></td>
                                    <td>{{ notification.recipient_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{% trans "Type:" %}</strong></td>
                                    <td>{{ notification.recipient_type|capfirst }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{% trans "ID:" %}</strong></td>
                                    <td>{{ notification.recipient_id }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                {% if notification.recipient_phone %}
                                <tr>
                                    <td><strong>{% trans "Phone:" %}</strong></td>
                                    <td>
                                        <a href="tel:{{ notification.recipient_phone }}">
                                            {{ notification.recipient_phone }}
                                        </a>
                                    </td>
                                </tr>
                                {% endif %}
                                {% if notification.recipient_email %}
                                <tr>
                                    <td><strong>{% trans "Email:" %}</strong></td>
                                    <td>
                                        <a href="mailto:{{ notification.recipient_email }}">
                                            {{ notification.recipient_email }}
                                        </a>
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Content -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Message Content" %}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>{% trans "Title:" %}</strong></label>
                        <div class="message-preview">
                            {{ notification.title }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>{% trans "Content:" %}</strong></label>
                        <div class="message-preview">
                            {{ notification.content|linebreaks }}
                        </div>
                    </div>
                    {% if notification.context_data %}
                    <div class="mb-3">
                        <label class="form-label"><strong>{% trans "Context Data:" %}</strong></label>
                        <div class="provider-response">
                            <pre>{{ notification.context_data|pprint }}</pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Provider Response -->
            {% if notification.provider_response or notification.provider_message_id %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Provider Response" %}</h6>
                </div>
                <div class="card-body">
                    {% if notification.provider_message_id %}
                    <div class="mb-3">
                        <label class="form-label"><strong>{% trans "Provider Message ID:" %}</strong></label>
                        <div class="message-preview">
                            {{ notification.provider_message_id }}
                        </div>
                    </div>
                    {% endif %}
                    {% if notification.provider_response %}
                    <div class="mb-3">
                        <label class="form-label"><strong>{% trans "Provider Response:" %}</strong></label>
                        <div class="provider-response">
                            <pre>{{ notification.provider_response|pprint }}</pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Error Information -->
            {% if notification.error_message %}
            <div class="card shadow mb-4 border-danger">
                <div class="card-header py-3 bg-danger text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% trans "Error Information" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <strong>{% trans "Error Message:" %}</strong><br>
                        {{ notification.error_message }}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>{% trans "Failed At:" %}</strong><br>
                            {{ notification.failed_at|date:"Y/m/d H:i:s" }}
                        </div>
                        <div class="col-md-6">
                            <strong>{% trans "Retry Count:" %}</strong><br>
                            {{ notification.retry_count }} / {{ notification.max_retries }}
                        </div>
                    </div>
                    {% if notification.can_retry %}
                    <div class="mt-3">
                        <button class="btn btn-warning" onclick="retryNotification()">
                            <i class="fas fa-redo me-2"></i>
                            {% trans "Retry Now" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Status Timeline -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Status Timeline" %}</h6>
                </div>
                <div class="card-body">
                    <div class="status-timeline">
                        <div class="timeline-item info">
                            <div class="d-flex justify-content-between">
                                <strong>{% trans "Created" %}</strong>
                                <small class="text-muted">{{ notification.created_at|date:"H:i" }}</small>
                            </div>
                            <small class="text-muted">{{ notification.created_at|date:"Y/m/d" }}</small>
                        </div>
                        
                        {% if notification.scheduled_at != notification.created_at %}
                        <div class="timeline-item warning">
                            <div class="d-flex justify-content-between">
                                <strong>{% trans "Scheduled" %}</strong>
                                <small class="text-muted">{{ notification.scheduled_at|date:"H:i" }}</small>
                            </div>
                            <small class="text-muted">{{ notification.scheduled_at|date:"Y/m/d" }}</small>
                        </div>
                        {% endif %}
                        
                        {% if notification.sent_at %}
                        <div class="timeline-item success">
                            <div class="d-flex justify-content-between">
                                <strong>{% trans "Sent" %}</strong>
                                <small class="text-muted">{{ notification.sent_at|date:"H:i" }}</small>
                            </div>
                            <small class="text-muted">{{ notification.sent_at|date:"Y/m/d" }}</small>
                        </div>
                        {% endif %}
                        
                        {% if notification.delivered_at %}
                        <div class="timeline-item success">
                            <div class="d-flex justify-content-between">
                                <strong>{% trans "Delivered" %}</strong>
                                <small class="text-muted">{{ notification.delivered_at|date:"H:i" }}</small>
                            </div>
                            <small class="text-muted">{{ notification.delivered_at|date:"Y/m/d" }}</small>
                        </div>
                        {% endif %}
                        
                        {% if notification.failed_at %}
                        <div class="timeline-item danger">
                            <div class="d-flex justify-content-between">
                                <strong>{% trans "Failed" %}</strong>
                                <small class="text-muted">{{ notification.failed_at|date:"H:i" }}</small>
                            </div>
                            <small class="text-muted">{{ notification.failed_at|date:"Y/m/d" }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Delivery Logs -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Delivery Logs" %}</h6>
                </div>
                <div class="card-body">
                    {% if delivery_logs %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>{% trans "Time" %}</th>
                                        <th>{% trans "Action" %}</th>
                                        <th>{% trans "Status" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in delivery_logs %}
                                    <tr>
                                        <td>
                                            <small>{{ log.timestamp|date:"H:i:s" }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ log.action }}</span>
                                        </td>
                                        <td>
                                            {% if log.success %}
                                                <i class="fas fa-check text-success"></i>
                                            {% else %}
                                                <i class="fas fa-times text-danger" 
                                                   title="{{ log.error_message }}"></i>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">{% trans "No delivery logs available" %}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Quick Actions" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if notification.status == 'pending' or notification.status == 'queued' %}
                        <button class="btn btn-danger" onclick="cancelNotification()">
                            <i class="fas fa-times me-2"></i>
                            {% trans "Cancel Notification" %}
                        </button>
                        {% elif notification.status == 'failed' and notification.can_retry %}
                        <button class="btn btn-warning" onclick="retryNotification()">
                            <i class="fas fa-redo me-2"></i>
                            {% trans "Retry Notification" %}
                        </button>
                        {% endif %}
                        
                        <button class="btn btn-primary" onclick="duplicateNotification()">
                            <i class="fas fa-copy me-2"></i>
                            {% trans "Duplicate Notification" %}
                        </button>
                        
                        {% if notification.recipient_type == 'customer' %}
                        <a href="#" class="btn btn-outline-info">
                            <i class="fas fa-user me-2"></i>
                            {% trans "View Customer" %}
                        </a>
                        {% endif %}
                        
                        <button class="btn btn-outline-secondary" onclick="exportDetails()">
                            <i class="fas fa-download me-2"></i>
                            {% trans "Export Details" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/notifications.js' %}"></script>
<script>
function cancelNotification() {
    if (confirm('{% trans "Are you sure you want to cancel this notification?" %}')) {
        fetch('{% url "core:notifications:cancel_ajax" notification.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                location.reload();
            } else {
                showNotification(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error cancelling notification:', error);
            showNotification('{% trans "Error connecting to server" %}', 'error');
        });
    }
}

function retryNotification() {
    if (confirm('{% trans "Do you want to retry sending this notification?" %}')) {
        fetch('{% url "core:notifications:retry_ajax" notification.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                location.reload();
            } else {
                showNotification(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error retrying notification:', error);
            showNotification('{% trans "Error connecting to server" %}', 'error');
        });
    }
}

function duplicateNotification() {
    // This would redirect to create notification with pre-filled data
    showNotification('{% trans "Duplicate functionality will be implemented" %}', 'info');
}

function exportDetails() {
    // Export notification details as PDF or JSON
    const exportUrl = '{% url "core:notifications:detail" notification.id %}?export=pdf';
    window.open(exportUrl, '_blank');
}
</script>
{% endblock %}