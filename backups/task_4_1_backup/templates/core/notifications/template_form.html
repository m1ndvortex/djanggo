{% extends 'base_rtl.html' %}
{% load persian_tags %}
{% load i18n %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        {% trans "Edit Template" %} - {{ form.instance.name }}
    {% else %}
        {% trans "Create Template" %}
    {% endif %}
    - {{ block.super }}
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/notifications.css' %}" rel="stylesheet">
<style>
.form-card {
    border-right: 4px solid #007bff;
}

.preview-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
}

.template-preview {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.375rem;
    padding: 1rem;
    font-family: 'Vazir', sans-serif;
    direction: rtl;
    min-height: 100px;
}

.variable-tag {
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 15px;
    padding: 0.25rem 0.75rem;
    margin: 0.25rem;
    display: inline-block;
    cursor: pointer;
    transition: all 0.2s ease;
}

.variable-tag:hover {
    background-color: #007bff;
    color: white;
    transform: scale(1.05);
}

.delivery-method-card {
    border: 2px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.delivery-method-card.selected {
    border-color: #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}

.delivery-method-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-bottom: 0.5rem;
}

.delivery-method-icon.sms { background-color: #007bff; color: white; }
.delivery-method-icon.email { background-color: #28a745; color: white; }
.delivery-method-icon.push { background-color: #ffc107; color: white; }
.delivery-method-icon.whatsapp { background-color: #25d366; color: white; }

/* Dark mode styles */
[data-theme="dark"] .form-card {
    background: rgba(26, 29, 41, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

[data-theme="dark"] .preview-card {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    border: 1px solid rgba(0, 212, 255, 0.2);
}

[data-theme="dark"] .template-preview {
    background: rgba(37, 42, 58, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.06);
    color: #ffffff;
}

[data-theme="dark"] .variable-tag {
    background-color: rgba(37, 42, 58, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.06);
    color: #ffffff;
}

[data-theme="dark"] .variable-tag:hover {
    background-color: #00D4FF;
    color: #000000;
}

[data-theme="dark"] .delivery-method-card {
    background: rgba(37, 42, 58, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.06);
}

[data-theme="dark"] .delivery-method-card.selected {
    border-color: #00D4FF;
    background-color: rgba(0, 212, 255, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        {% if form.instance.pk %}
                            {% trans "Edit Template" %}
                        {% else %}
                            {% trans "Create Template" %}
                        {% endif %}
                    </h1>
                    <p class="text-muted">
                        {% if form.instance.pk %}
                            {% trans "Modify the notification template settings and content" %}
                        {% else %}
                            {% trans "Create a new notification template for automated messaging" %}
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'core:notifications:template_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-right me-2"></i>
                        {% trans "Back to Templates" %}
                    </a>
                    {% if form.instance.pk %}
                    <a href="{% url 'core:notifications:template_delete' form.instance.pk %}" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        {% trans "Delete" %}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="templateForm">
        {% csrf_token %}
        <div class="row">
            <!-- Form Fields -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card form-card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">{% trans "Basic Information" %}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        {{ form.name.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "A descriptive name for this template" %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.template_type.id_for_label }}" class="form-label">
                                        {{ form.template_type.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.template_type }}
                                    {% if form.template_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.template_type.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{% trans "The type of notification this template is for" %}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        {{ form.is_active.label }}
                                    </label>
                                    <div class="form-text">{% trans "Only active templates can be used for notifications" %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.is_default }}
                                    <label class="form-check-label" for="{{ form.is_default.id_for_label }}">
                                        {{ form.is_default.label }}
                                    </label>
                                    <div class="form-text">{% trans "Default template for this type (only one per type)" %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Content -->
                <div class="card form-card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">{% trans "Message Content" %}</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                {{ form.title.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.title.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{% trans "Title for email/push notifications (supports variables)" %}</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.content.id_for_label }}" class="form-label">
                                {{ form.content.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.content }}
                            {% if form.content.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.content.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{% trans "Main message content in Persian (supports variables)" %}</div>
                        </div>

                        <!-- Available Variables -->
                        <div class="mb-3">
                            <label class="form-label">{% trans "Available Variables" %}</label>
                            <div id="availableVariables" class="border rounded p-3 bg-light">
                                <p class="text-muted mb-2">{% trans "Click on a variable to insert it into your message:" %}</p>
                                <div id="variablesList">
                                    <!-- Variables will be populated based on template type -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delivery Methods -->
                <div class="card form-card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">{% trans "Delivery Methods" %}</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">{% trans "Select which delivery methods this template supports:" %}</p>
                        
                        <div class="row">
                            <div class="col-md-6 col-lg-3">
                                <div class="delivery-method-card text-center" data-method="sms">
                                    <div class="delivery-method-icon sms mx-auto">
                                        <i class="fas fa-sms"></i>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="delivery_methods" 
                                               value="sms" id="method_sms">
                                        <label class="form-check-label" for="method_sms">
                                            <strong>{% trans "SMS" %}</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">{% trans "Text message to phone" %}</small>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="delivery-method-card text-center" data-method="email">
                                    <div class="delivery-method-icon email mx-auto">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="delivery_methods" 
                                               value="email" id="method_email">
                                        <label class="form-check-label" for="method_email">
                                            <strong>{% trans "Email" %}</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">{% trans "Email message" %}</small>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="delivery-method-card text-center" data-method="push">
                                    <div class="delivery-method-icon push mx-auto">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="delivery_methods" 
                                               value="push" id="method_push">
                                        <label class="form-check-label" for="method_push">
                                            <strong>{% trans "Push" %}</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">{% trans "Mobile app notification" %}</small>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="delivery-method-card text-center" data-method="whatsapp">
                                    <div class="delivery-method-icon whatsapp mx-auto">
                                        <i class="fab fa-whatsapp"></i>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="delivery_methods" 
                                               value="whatsapp" id="method_whatsapp">
                                        <label class="form-check-label" for="method_whatsapp">
                                            <strong>{% trans "WhatsApp" %}</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">{% trans "WhatsApp message" %}</small>
                                </div>
                            </div>
                        </div>
                        
                        {% if form.delivery_methods.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.delivery_methods.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="card form-card shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="previewTemplate()">
                                    <i class="fas fa-eye me-2"></i>
                                    {% trans "Preview" %}
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="testTemplate()">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    {% trans "Send Test" %}
                                </button>
                            </div>
                            <div>
                                <a href="{% url 'core:notifications:template_list' %}" class="btn btn-secondary">
                                    {% trans "Cancel" %}
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    {% if form.instance.pk %}
                                        {% trans "Update Template" %}
                                    {% else %}
                                        {% trans "Create Template" %}
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Sidebar -->
            <div class="col-lg-4">
                <div class="preview-card sticky-top">
                    <h6 class="mb-3">{% trans "Live Preview" %}</h6>
                    
                    <div class="mb-3">
                        <label class="form-label text-white-50">{% trans "Title:" %}</label>
                        <div class="template-preview" id="previewTitle">
                            {% trans "Enter title above to see preview" %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white-50">{% trans "Content:" %}</label>
                        <div class="template-preview" id="previewContent">
                            {% trans "Enter content above to see preview" %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white-50">{% trans "Sample Context:" %}</label>
                        <div class="template-preview">
                            <small id="sampleContext">
                                {% trans "Select template type to see sample variables" %}
                            </small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-white-50">{% trans "Character Count:" %}</label>
                        <div class="d-flex justify-content-between">
                            <span>{% trans "Title:" %} <span id="titleCount">0</span></span>
                            <span>{% trans "Content:" %} <span id="contentCount">0</span></span>
                        </div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" role="progressbar" id="smsProgress" style="width: 0%"></div>
                        </div>
                        <small class="text-white-50">{% trans "SMS limit: 160 characters" %}</small>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Include modals -->
{% include 'core/notifications/modals/template_preview.html' %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/notifications.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form
    initializeForm();
    
    // Template type change handler
    document.getElementById('{{ form.template_type.id_for_label }}').addEventListener('change', function() {
        updateAvailableVariables(this.value);
        updateSampleContext(this.value);
        updatePreview();
    });
    
    // Content change handlers
    document.getElementById('{{ form.title.id_for_label }}').addEventListener('input', updatePreview);
    document.getElementById('{{ form.content.id_for_label }}').addEventListener('input', updatePreview);
    
    // Delivery method handlers
    document.querySelectorAll('input[name="delivery_methods"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateDeliveryMethodCards();
        });
    });
    
    // Initialize preview
    updateAvailableVariables(document.getElementById('{{ form.template_type.id_for_label }}').value);
    updatePreview();
});

function initializeForm() {
    // Set initial delivery method selections
    {% if form.instance.pk and form.instance.delivery_methods %}
        const selectedMethods = {{ form.instance.delivery_methods|safe }};
        selectedMethods.forEach(method => {
            const checkbox = document.getElementById(`method_${method}`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    {% endif %}
    
    updateDeliveryMethodCards();
}

function updateAvailableVariables(templateType) {
    const variablesList = document.getElementById('variablesList');
    variablesList.innerHTML = '';
    
    const variableConfigs = {
        'payment_reminder': [
            { name: 'customer_name', label: '{% trans "Customer Name" %}' },
            { name: 'contract_number', label: '{% trans "Contract Number" %}' },
            { name: 'amount', label: '{% trans "Amount" %}' },
            { name: 'due_date', label: '{% trans "Due Date" %}' },
            { name: 'remaining_weight', label: '{% trans "Remaining Weight" %}' }
        ],
        'payment_overdue': [
            { name: 'customer_name', label: '{% trans "Customer Name" %}' },
            { name: 'contract_number', label: '{% trans "Contract Number" %}' },
            { name: 'overdue_amount', label: '{% trans "Overdue Amount" %}' },
            { name: 'overdue_days', label: '{% trans "Days Overdue" %}' }
        ],
        'birthday_greeting': [
            { name: 'customer_name', label: '{% trans "Customer Name" %}' },
            { name: 'age', label: '{% trans "Age" %}' },
            { name: 'birth_date', label: '{% trans "Birth Date" %}' },
            { name: 'special_offer', label: '{% trans "Special Offer" %}' }
        ],
        'appointment_reminder': [
            { name: 'customer_name', label: '{% trans "Customer Name" %}' },
            { name: 'appointment_date', label: '{% trans "Appointment Date" %}' },
            { name: 'appointment_time', label: '{% trans "Appointment Time" %}' },
            { name: 'service_type', label: '{% trans "Service Type" %}' }
        ],
        'special_offer': [
            { name: 'customer_name', label: '{% trans "Customer Name" %}' },
            { name: 'offer_title', label: '{% trans "Offer Title" %}' },
            { name: 'offer_description', label: '{% trans "Offer Description" %}' },
            { name: 'discount_percentage', label: '{% trans "Discount Percentage" %}' },
            { name: 'expiry_date', label: '{% trans "Expiry Date" %}' }
        ]
    };
    
    const variables = variableConfigs[templateType] || [
        { name: 'customer_name', label: '{% trans "Customer Name" %}' },
        { name: 'date', label: '{% trans "Current Date" %}' },
        { name: 'shop_name', label: '{% trans "Shop Name" %}' }
    ];
    
    variables.forEach(variable => {
        const tag = document.createElement('span');
        tag.className = 'variable-tag';
        tag.textContent = `{${variable.name}}`;
        tag.title = variable.label;
        tag.onclick = () => insertVariable(variable.name);
        variablesList.appendChild(tag);
    });
}

function updateSampleContext(templateType) {
    const sampleContext = document.getElementById('sampleContext');
    
    const sampleData = {
        'payment_reminder': 'احمد رضایی، قرارداد GI-2024-001، 2,500,000 تومان، 1403/07/15',
        'birthday_greeting': 'مریم حسینی، 35 سال، 1368/05/10',
        'appointment_reminder': 'علی محمدی، 1403/07/20، 14:30، تعمیر جواهرات',
        'special_offer': 'تخفیف ویژه طلا، 20٪، 1403/08/01'
    };
    
    sampleContext.textContent = sampleData[templateType] || 'احمد رضایی، 1403/07/10، طلا و جواهرات زرگر';
}

function insertVariable(variableName) {
    const contentField = document.getElementById('{{ form.content.id_for_label }}');
    const cursorPos = contentField.selectionStart;
    const textBefore = contentField.value.substring(0, cursorPos);
    const textAfter = contentField.value.substring(cursorPos);
    
    contentField.value = textBefore + `{${variableName}}` + textAfter;
    contentField.focus();
    contentField.setSelectionRange(cursorPos + variableName.length + 2, cursorPos + variableName.length + 2);
    
    updatePreview();
}

function updatePreview() {
    const title = document.getElementById('{{ form.title.id_for_label }}').value;
    const content = document.getElementById('{{ form.content.id_for_label }}').value;
    
    // Update preview
    document.getElementById('previewTitle').textContent = title || '{% trans "Enter title above to see preview" %}';
    document.getElementById('previewContent').textContent = content || '{% trans "Enter content above to see preview" %}';
    
    // Update character counts
    document.getElementById('titleCount').textContent = title.length;
    document.getElementById('contentCount').textContent = content.length;
    
    // Update SMS progress bar
    const totalChars = title.length + content.length;
    const smsProgress = Math.min((totalChars / 160) * 100, 100);
    document.getElementById('smsProgress').style.width = smsProgress + '%';
    
    if (smsProgress > 100) {
        document.getElementById('smsProgress').className = 'progress-bar bg-danger';
    } else if (smsProgress > 80) {
        document.getElementById('smsProgress').className = 'progress-bar bg-warning';
    } else {
        document.getElementById('smsProgress').className = 'progress-bar bg-success';
    }
}

function updateDeliveryMethodCards() {
    document.querySelectorAll('.delivery-method-card').forEach(card => {
        const method = card.dataset.method;
        const checkbox = document.getElementById(`method_${method}`);
        
        if (checkbox && checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
}

function previewTemplate() {
    const templateData = {
        title: document.getElementById('{{ form.title.id_for_label }}').value,
        content: document.getElementById('{{ form.content.id_for_label }}').value,
        template_type: document.getElementById('{{ form.template_type.id_for_label }}').value,
        delivery_methods: Array.from(document.querySelectorAll('input[name="delivery_methods"]:checked')).map(cb => cb.value),
        available_variables: {}
    };
    
    showTemplatePreview(templateData);
}

function testTemplate() {
    if (!document.getElementById('{{ form.title.id_for_label }}').value || 
        !document.getElementById('{{ form.content.id_for_label }}').value) {
        showNotification('{% trans "Please fill in title and content before testing" %}', 'warning');
        return;
    }
    
    showNotification('{% trans "Test notification functionality will be implemented" %}', 'info');
}

// Form validation
document.getElementById('templateForm').addEventListener('submit', function(e) {
    const deliveryMethods = document.querySelectorAll('input[name="delivery_methods"]:checked');
    
    if (deliveryMethods.length === 0) {
        e.preventDefault();
        showNotification('{% trans "Please select at least one delivery method" %}', 'error');
        return false;
    }
    
    return true;
});
</script>
{% endblock %}