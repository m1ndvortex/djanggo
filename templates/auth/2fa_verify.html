{% extends "auth/base_auth.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<style>
    .token-input {
        letter-spacing: 0.5em;
        text-align: center;
        font-family: 'Courier New', monospace;
    }
    .countdown-circle {
        animation: countdown 30s linear infinite;
    }
    @keyframes countdown {
        from { stroke-dashoffset: 0; }
        to { stroke-dashoffset: 283; }
    }
    .error-shake {
        animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
</style>
{% endblock %}

{% block auth_content %}
<div class="min-h-screen flex items-center justify-center {% if is_dark_mode %}bg-cyber-bg-primary{% else %}bg-gray-50{% endif %} py-12 px-4 sm:px-6 lg:px-8" dir="rtl" x-data="twoFAVerify()">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full {% if is_dark_mode %}bg-cyber-neon-primary/20 text-cyber-neon-primary{% else %}bg-blue-100 text-blue-600{% endif %} relative">
                <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <!-- Countdown indicator -->
                <svg class="absolute inset-0 w-16 h-16 transform -rotate-90" x-show="showCountdown">
                    <circle cx="32" cy="32" r="30" stroke="currentColor" stroke-width="2" fill="none" 
                            class="{% if is_dark_mode %}text-cyber-neon-primary/20{% else %}text-blue-200{% endif %}"/>
                    <circle cx="32" cy="32" r="30" stroke="currentColor" stroke-width="2" fill="none" 
                            class="countdown-circle {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-500{% endif %}"
                            stroke-dasharray="188" stroke-dashoffset="0"/>
                </svg>
            </div>
            <h2 class="mt-6 text-center text-3xl font-extrabold {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                تأیید کد دو مرحله‌ای
            </h2>
            <p class="mt-2 text-center text-sm {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                لطفاً کد ۶ رقمی را از اپلیکیشن احراز هویت خود وارد کنید
            </p>
            <div class="mt-4 flex items-center justify-center space-x-reverse space-x-2" x-show="timeLeft > 0">
                <div class="w-2 h-2 {% if is_dark_mode %}bg-cyber-neon-secondary{% else %}bg-green-500{% endif %} rounded-full animate-pulse"></div>
                <span class="text-xs {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                    کد جدید در <span x-text="timeLeft"></span> ثانیه
                </span>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="rounded-md p-4 {% if message.tags == 'error' %}{% if is_dark_mode %}bg-red-900/20 border border-red-500/30{% else %}bg-red-50 border border-red-200{% endif %}{% elif message.tags == 'success' %}{% if is_dark_mode %}bg-green-900/20 border border-green-500/30{% else %}bg-green-50 border border-green-200{% endif %}{% elif message.tags == 'warning' %}{% if is_dark_mode %}bg-yellow-900/20 border border-yellow-500/30{% else %}bg-yellow-50 border border-yellow-200{% endif %}{% else %}{% if is_dark_mode %}bg-blue-900/20 border border-blue-500/30{% else %}bg-blue-50 border border-blue-200{% endif %}{% endif %}"
                     x-data="{ show: true }" x-show="show" x-transition>
                    <div class="flex">
                        <div class="flex-shrink-0">
                            {% if message.tags == 'error' %}
                                <svg class="h-5 w-5 {% if is_dark_mode %}text-red-400{% else %}text-red-400{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                            {% elif message.tags == 'success' %}
                                <svg class="h-5 w-5 {% if is_dark_mode %}text-green-400{% else %}text-green-400{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            {% else %}
                                <svg class="h-5 w-5 {% if is_dark_mode %}text-blue-400{% else %}text-blue-400{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                            {% endif %}
                        </div>
                        <div class="mr-3 flex-1">
                            <p class="text-sm {% if message.tags == 'error' %}{% if is_dark_mode %}text-red-300{% else %}text-red-800{% endif %}{% elif message.tags == 'success' %}{% if is_dark_mode %}text-green-300{% else %}text-green-800{% endif %}{% elif message.tags == 'warning' %}{% if is_dark_mode %}text-yellow-300{% else %}text-yellow-800{% endif %}{% else %}{% if is_dark_mode %}text-blue-300{% else %}text-blue-800{% endif %}{% endif %}">
                                {{ message }}
                            </p>
                        </div>
                        <div class="mr-auto pl-3">
                            <button @click="show = false" class="inline-flex {% if is_dark_mode %}text-gray-400 hover:text-gray-300{% else %}text-gray-400 hover:text-gray-500{% endif %}">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Verification Form -->
        <div class="{% if is_dark_mode %}bg-cyber-bg-surface border border-cyber-neon-primary/20{% else %}bg-white border border-gray-200{% endif %} rounded-lg shadow-sm p-6">
            <form class="space-y-6" method="post" @submit="handleSubmit">
                {% csrf_token %}
                
                <div>
                    <label for="token" class="block text-sm font-medium {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-700{% endif %} mb-3">
                        کد تأیید ۶ رقمی
                    </label>
                    <div class="relative">
                        <input 
                            id="token" 
                            name="token" 
                            type="text" 
                            required 
                            maxlength="8"
                            x-model="token"
                            @input="validateToken"
                            :class="tokenError ? 'error-shake border-red-500' : ''"
                            class="token-input appearance-none rounded-lg relative block w-full px-4 py-3 border {% if is_dark_mode %}border-cyber-neon-primary/30 bg-cyber-bg-primary text-cyber-text-primary focus:border-cyber-neon-primary focus:ring-cyber-neon-primary/20{% else %}border-gray-300 text-gray-900 focus:border-blue-500 focus:ring-blue-500{% endif %} focus:outline-none focus:ring-2 text-2xl font-mono tracking-widest"
                            placeholder="۱۲۳۴۵۶"
                            autocomplete="one-time-code"
                            inputmode="numeric"
                            pattern="[0-9A-Z]{6,8}"
                        >
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                            <div x-show="isValidating" class="animate-spin">
                                <svg class="w-5 h-5 {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-500{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </div>
                            <div x-show="tokenValid && !isValidating">
                                <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Token Input Helper -->
                    <div class="mt-3 flex justify-center space-x-reverse space-x-2">
                        <template x-for="i in 6" :key="i">
                            <div class="w-6 h-1 rounded-full transition-all duration-200"
                                 :class="token.length >= i ? '{% if is_dark_mode %}bg-cyber-neon-primary{% else %}bg-blue-500{% endif %}' : '{% if is_dark_mode %}bg-cyber-bg-surface{% else %}bg-gray-200{% endif %}'">
                            </div>
                        </template>
                    </div>
                    
                    <div class="mt-2 space-y-1">
                        <p class="text-sm {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                            کد ۶ رقمی نمایش داده شده در اپلیکیشن احراز هویت را وارد کنید
                        </p>
                        <div x-show="tokenError" class="text-sm text-red-600" x-text="tokenError"></div>
                        <div x-show="token.length >= 6 && !tokenError" class="text-sm text-green-600">
                            ✓ کد معتبر است
                        </div>
                    </div>
                </div>

                <div>
                    <button 
                        type="submit" 
                        :disabled="!tokenValid || isSubmitting"
                        :class="tokenValid && !isSubmitting ? '' : 'opacity-50 cursor-not-allowed'"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white {% if is_dark_mode %}bg-gradient-to-r from-cyber-neon-primary to-cyber-neon-secondary hover:from-cyber-neon-primary/80 hover:to-cyber-neon-secondary/80{% else %}bg-blue-600 hover:bg-blue-700{% endif %} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                    >
                        <span class="absolute right-0 inset-y-0 flex items-center pr-3">
                            <div x-show="isSubmitting" class="animate-spin">
                                <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </div>
                            <svg x-show="!isSubmitting" class="h-5 w-5 text-blue-500 group-hover:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                            </svg>
                        </span>
                        <span x-text="isSubmitting ? 'در حال تأیید...' : 'تأیید کد'"></span>
                    </button>
                </div>

                <!-- Help Text -->
                <div class="text-center space-y-3">
                    <div class="{% if is_dark_mode %}bg-cyber-bg-primary border border-cyber-neon-secondary/20{% else %}bg-blue-50 border border-blue-200{% endif %} rounded-lg p-3">
                        <p class="text-sm {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-blue-700{% endif %}">
                            <strong>کد را دریافت نکردید؟</strong>
                        </p>
                        <p class="text-xs {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-blue-600{% endif %} mt-1">
                            می‌توانید از کدهای پشتیبان ۸ رقمی خود استفاده کنید
                        </p>
                    </div>
                    
                    <div class="flex items-center justify-center space-x-reverse space-x-4 text-xs {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-500{% endif %}">
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full ml-1"></div>
                            <span>کد TOTP (۶ رقم)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-orange-500 rounded-full ml-1"></div>
                            <span>کد پشتیبان (۸ رقم)</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="text-center space-y-4">
            <a href="{% url 'tenant:login' %}" class="inline-flex items-center text-sm {% if is_dark_mode %}text-cyber-neon-primary hover:text-cyber-neon-primary/80{% else %}text-blue-600 hover:text-blue-500{% endif %} transition-colors duration-150">
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                بازگشت به صفحه ورود
            </a>
            
            <div class="{% if is_dark_mode %}bg-cyber-bg-surface border border-cyber-neon-warning/20{% else %}bg-yellow-50 border border-yellow-200{% endif %} rounded-lg p-3">
                <div class="flex items-center justify-center">
                    <svg class="h-4 w-4 {% if is_dark_mode %}text-cyber-neon-warning{% else %}text-yellow-500{% endif %} ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <p class="text-xs {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-yellow-700{% endif %}">
                        در صورت مشکل در دسترسی، با پشتیبانی تماس بگیرید
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Alpine.js component for 2FA verification
function twoFAVerify() {
    return {
        token: '',
        tokenError: '',
        tokenValid: false,
        isValidating: false,
        isSubmitting: false,
        timeLeft: 30,
        showCountdown: true,
        
        init() {
            // Start countdown timer
            this.startCountdown();
            
            // Auto-focus on token input
            setTimeout(() => {
                document.getElementById('token').focus();
            }, 100);
        },
        
        startCountdown() {
            const interval = setInterval(() => {
                this.timeLeft--;
                if (this.timeLeft <= 0) {
                    this.timeLeft = 30;
                }
            }, 1000);
        },
        
        validateToken() {
            this.tokenError = '';
            this.tokenValid = false;
            this.isValidating = true;
            
            // Remove non-alphanumeric and convert Persian numerals
            let value = this.token.replace(/[۰-۹]/g, (d) => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d))
                                  .replace(/[^0-9A-Z]/g, '').toUpperCase();
            
            // Limit to 8 characters (backup tokens can be 8 digits)
            if (value.length > 8) {
                value = value.slice(0, 8);
            }
            
            this.token = value;
            
            setTimeout(() => {
                this.isValidating = false;
                
                if (value.length === 0) {
                    return;
                }
                
                if (value.length < 6) {
                    this.tokenError = 'کد باید حداقل ۶ رقم باشد';
                    return;
                }
                
                if (value.length === 6) {
                    // TOTP code validation
                    if (!/^\d{6}$/.test(value)) {
                        this.tokenError = 'کد TOTP باید ۶ رقم باشد';
                        return;
                    }
                } else if (value.length === 8) {
                    // Backup code validation
                    if (!/^[0-9A-Z]{8}$/.test(value)) {
                        this.tokenError = 'کد پشتیبان باید ۸ کاراکتر باشد';
                        return;
                    }
                } else {
                    this.tokenError = 'کد باید ۶ رقم (TOTP) یا ۸ کاراکتر (پشتیبان) باشد';
                    return;
                }
                
                this.tokenValid = true;
                
                // Auto-submit for 6-digit codes after a short delay
                if (value.length === 6) {
                    setTimeout(() => {
                        if (this.tokenValid && !this.isSubmitting) {
                            this.handleSubmit();
                        }
                    }, 800);
                }
            }, 300);
        },
        
        handleSubmit(event) {
            if (event && !this.tokenValid) {
                event.preventDefault();
                this.tokenError = 'لطفاً کد معتبر وارد کنید';
                return false;
            }
            
            this.isSubmitting = true;
            // Form will submit normally if event is not prevented
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const tokenInput = document.getElementById('token');
    
    if (tokenInput) {
        // Handle paste events
        tokenInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const cleanPaste = paste.replace(/[۰-۹]/g, (d) => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d))
                                   .replace(/[^0-9A-Z]/g, '').toUpperCase().substring(0, 8);
            
            // Trigger Alpine.js update
            this.value = cleanPaste;
            this.dispatchEvent(new Event('input'));
        });
        
        // Keyboard shortcuts
        tokenInput.addEventListener('keydown', function(e) {
            // Allow: backspace, delete, tab, escape, enter
            if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true)) {
                return;
            }
            
            // Ensure that it is a number or letter and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && 
                (e.keyCode < 65 || e.keyCode > 90) && 
                (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });
    }
    
    // Global keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // ESC to go back to login
        if (e.key === 'Escape') {
            const backButton = document.querySelector('a[href*="login"]');
            if (backButton) {
                window.location.href = backButton.href;
            }
        }
    });
});
</script>
{% endblock %}