{% extends "base_rtl.html" %}
{% load static %}
{% load i18n %}

{% block title %}مدیریت دسته‌بندی‌ها - زرگر{% endblock %}

{% block extra_head %}
<style>
    .category-card {
        backdrop-filter: blur(16px) saturate(150%);
        background: linear-gradient(145deg, 
            rgba(37, 42, 58, 0.8) 0%, 
            rgba(26, 29, 41, 0.9) 50%,
            rgba(11, 14, 26, 0.95) 100%);
        border: 1px solid rgba(255, 255, 255, 0.04);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.03);
        transition: all 0.3s ease;
    }
    
    .category-card:hover {
        transform: translateY(-2px);
    }
    
    .dark .category-card:hover {
        box-shadow: 0 16px 50px rgba(0, 0, 0, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
    
    .modal-backdrop {
        backdrop-filter: blur(8px);
    }
    
    .modal-content {
        backdrop-filter: blur(20px) saturate(180%);
        background: linear-gradient(145deg, 
            rgba(37, 42, 58, 0.95) 0%, 
            rgba(26, 29, 41, 0.98) 50%,
            rgba(11, 14, 26, 0.99) 100%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div>
            <nav class="flex items-center space-x-2 space-x-reverse text-sm mb-4
                       {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                <a href="{% url 'jewelry:dashboard' %}" 
                   class="{% if is_dark_mode %}hover:text-cyber-neon-primary{% else %}hover:text-blue-600{% endif %}">
                    داشبورد موجودی
                </a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <span>مدیریت دسته‌بندی‌ها</span>
            </nav>
            
            <h1 class="text-3xl font-bold mb-2
                       {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                مدیریت دسته‌بندی‌ها
            </h1>
            <p class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                ایجاد و مدیریت دسته‌بندی‌های کالاها
            </p>
        </div>
        
        <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
            {% if can_manage %}
            <button onclick="openCreateCategoryModal()" 
                    class="inline-flex items-center px-4 py-2 rounded-lg font-medium transition-all duration-300
                           {% if is_dark_mode %}
                           bg-gradient-to-r from-cyber-neon-primary/20 to-cyber-neon-secondary/20 
                           border border-cyber-neon-primary/30 text-cyber-neon-primary
                           hover:border-cyber-neon-primary/50 hover:shadow-lg hover:shadow-cyber-neon-primary/20
                           {% else %}
                           bg-blue-600 text-white border border-blue-600
                           hover:bg-blue-700 hover:border-blue-700
                           {% endif %}">
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                دسته‌بندی جدید
            </button>
            {% endif %}
            
            <a href="{% url 'jewelry:dashboard' %}" 
               class="inline-flex items-center px-4 py-2 rounded-lg font-medium transition-all duration-300
                      {% if is_dark_mode %}
                      bg-cyber-bg-surface/50 border border-cyber-text-muted/30 text-cyber-text-secondary
                      hover:border-cyber-text-secondary/50
                      {% else %}
                      bg-white text-gray-700 border border-gray-300
                      hover:bg-gray-50 hover:border-gray-400
                      {% endif %}">
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                </svg>
                بازگشت به داشبورد
            </a>
        </div>
    </div>

    <!-- Categories Grid -->
    {% if categories %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for category in categories %}
        <div class="category-card rounded-xl p-6">
            <!-- Category Header -->
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <h3 class="text-lg font-bold mb-1
                             {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                        {{ category.name_persian|default:category.name }}
                    </h3>
                    {% if category.name_persian and category.name != category.name_persian %}
                    <p class="text-sm
                             {% if is_dark_mode %}text-cyber-text-muted{% else %}text-gray-500{% endif %}">
                        {{ category.name }}
                    </p>
                    {% endif %}
                </div>
                
                <!-- Status Badge -->
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                           {% if category.is_active %}
                           {% if is_dark_mode %}bg-cyber-neon-secondary/20 text-cyber-neon-secondary border border-cyber-neon-secondary/30{% else %}bg-green-100 text-green-800 border border-green-200{% endif %}
                           {% else %}
                           {% if is_dark_mode %}bg-cyber-text-muted/20 text-cyber-text-muted border border-cyber-text-muted/30{% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}
                           {% endif %}">
                    {% if category.is_active %}فعال{% else %}غیرفعال{% endif %}
                </span>
            </div>

            <!-- Description -->
            {% if category.description %}
            <p class="text-sm mb-4 line-clamp-3
                     {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                {{ category.description }}
            </p>
            {% endif %}

            <!-- Statistics -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="text-center p-3 rounded-lg
                           {% if is_dark_mode %}bg-cyber-bg-surface/30{% else %}bg-gray-50{% endif %}">
                    <p class="text-2xl font-bold persian-numbers
                             {% if is_dark_mode %}text-cyber-neon-primary{% else %}text-blue-600{% endif %}">
                        {{ category.item_count|default:0 }}
                    </p>
                    <p class="text-xs
                             {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                        تعداد کالا
                    </p>
                </div>
                
                <div class="text-center p-3 rounded-lg
                           {% if is_dark_mode %}bg-cyber-bg-surface/30{% else %}bg-gray-50{% endif %}">
                    <p class="text-lg font-bold persian-numbers
                             {% if is_dark_mode %}text-cyber-neon-secondary{% else %}text-green-600{% endif %}">
                        {% if category.total_value %}
                        {{ category.total_value|floatformat:0 }}
                        {% else %}
                        0
                        {% endif %}
                    </p>
                    <p class="text-xs
                             {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %}">
                        ارزش کل (تومان)
                    </p>
                </div>
            </div>

            <!-- Actions -->
            {% if can_manage %}
            <div class="flex gap-2">
                <button onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.name_persian }}', '{{ category.description|default:'' }}', {{ category.is_active|yesno:'true,false' }})" 
                        class="flex-1 text-center px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300
                               {% if is_dark_mode %}
                               bg-cyber-neon-secondary/20 border border-cyber-neon-secondary/30 text-cyber-neon-secondary
                               hover:border-cyber-neon-secondary/50 hover:bg-cyber-neon-secondary/30
                               {% else %}
                               bg-green-50 border border-green-200 text-green-700
                               hover:bg-green-100 hover:border-green-300
                               {% endif %}">
                    ویرایش
                </button>
                
                <a href="{% url 'jewelry:inventory_list' %}?category={{ category.id }}" 
                   class="flex-1 text-center px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300
                          {% if is_dark_mode %}
                          bg-cyber-neon-primary/20 border border-cyber-neon-primary/30 text-cyber-neon-primary
                          hover:border-cyber-neon-primary/50 hover:bg-cyber-neon-primary/30
                          {% else %}
                          bg-blue-50 border border-blue-200 text-blue-700
                          hover:bg-blue-100 hover:border-blue-300
                          {% endif %}">
                    مشاهده کالاها
                </a>
            </div>
            {% else %}
            <a href="{% url 'jewelry:inventory_list' %}?category={{ category.id }}" 
               class="block text-center px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300
                      {% if is_dark_mode %}
                      bg-cyber-neon-primary/20 border border-cyber-neon-primary/30 text-cyber-neon-primary
                      hover:border-cyber-neon-primary/50 hover:bg-cyber-neon-primary/30
                      {% else %}
                      bg-blue-50 border border-blue-200 text-blue-700
                      hover:bg-blue-100 hover:border-blue-300
                      {% endif %}">
                مشاهده کالاها
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- No Categories -->
    <div class="{% if is_dark_mode %}category-card{% else %}bg-white border border-gray-200 shadow-sm{% endif %} 
                rounded-xl p-12 text-center">
        <svg class="w-24 h-24 mx-auto mb-6 {% if is_dark_mode %}text-cyber-text-muted{% else %}text-gray-400{% endif %}" 
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        <h3 class="text-xl font-bold mb-2
                 {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
            هنوز دسته‌بندی‌ای ایجاد نشده است
        </h3>
        <p class="{% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-600{% endif %} mb-6">
            برای سازماندهی بهتر کالاها، دسته‌بندی‌های مختلف ایجاد کنید.
        </p>
        {% if can_manage %}
        <button onclick="openCreateCategoryModal()" 
                class="inline-flex items-center px-6 py-3 rounded-lg font-medium transition-all duration-300
                       {% if is_dark_mode %}
                       bg-gradient-to-r from-cyber-neon-primary/20 to-cyber-neon-secondary/20 
                       border border-cyber-neon-primary/30 text-cyber-neon-primary
                       hover:border-cyber-neon-primary/50 hover:shadow-lg hover:shadow-cyber-neon-primary/20
                       {% else %}
                       bg-blue-600 text-white border border-blue-600
                       hover:bg-blue-700 hover:border-blue-700
                       {% endif %}">
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            ایجاد اولین دسته‌بندی
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Create/Edit Category Modal -->
{% if can_manage %}
<div id="categoryModal" 
     class="fixed inset-0 z-50 hidden overflow-y-auto"
     x-data="{ show: false }"
     x-show="show"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <!-- Backdrop -->
    <div class="modal-backdrop fixed inset-0
                {% if is_dark_mode %}bg-cyber-bg-primary/80{% else %}bg-black/50{% endif %}"
         @click="show = false"></div>
    
    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="modal-content relative w-full max-w-md rounded-xl p-6
                    {% if is_dark_mode %}{% else %}bg-white{% endif %}"
             x-transition:enter="transition ease-out duration-300 transform"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200 transform"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6">
                <h3 id="modalTitle" class="text-lg font-bold
                                         {% if is_dark_mode %}text-cyber-text-primary{% else %}text-gray-900{% endif %}">
                    دسته‌بندی جدید
                </h3>
                <button @click="show = false" 
                        class="p-2 rounded-lg transition-all duration-300
                               {% if is_dark_mode %}
                               text-cyber-text-muted hover:text-cyber-text-primary hover:bg-cyber-bg-surface/30
                               {% else %}
                               text-gray-400 hover:text-gray-600 hover:bg-gray-100
                               {% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Form -->
            <form id="categoryForm" class="space-y-4">
                <input type="hidden" id="categoryId" name="categoryId">
                
                <!-- Persian Name -->
                <div>
                    <label class="block text-sm font-medium mb-2
                                 {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-700{% endif %}">
                        نام فارسی <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="namePersian" 
                           name="name_persian" 
                           required
                           class="w-full px-4 py-3 rounded-lg border transition-all duration-300
                                  {% if is_dark_mode %}
                                  bg-cyber-bg-surface/50 border-cyber-text-muted/30 text-cyber-text-primary
                                  placeholder-cyber-text-muted focus:border-cyber-neon-primary/50
                                  {% else %}
                                  bg-white border-gray-300 text-gray-900
                                  placeholder-gray-500 focus:border-blue-500 focus:ring-blue-500
                                  {% endif %}"
                           placeholder="نام فارسی دسته‌بندی">
                </div>
                
                <!-- English Name -->
                <div>
                    <label class="block text-sm font-medium mb-2
                                 {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-700{% endif %}">
                        نام انگلیسی <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="nameEnglish" 
                           name="name" 
                           required
                           class="w-full px-4 py-3 rounded-lg border transition-all duration-300
                                  {% if is_dark_mode %}
                                  bg-cyber-bg-surface/50 border-cyber-text-muted/30 text-cyber-text-primary
                                  placeholder-cyber-text-muted focus:border-cyber-neon-primary/50
                                  {% else %}
                                  bg-white border-gray-300 text-gray-900
                                  placeholder-gray-500 focus:border-blue-500 focus:ring-blue-500
                                  {% endif %}"
                           placeholder="English category name">
                </div>
                
                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium mb-2
                                 {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-700{% endif %}">
                        توضیحات
                    </label>
                    <textarea id="description" 
                              name="description" 
                              rows="3"
                              class="w-full px-4 py-3 rounded-lg border transition-all duration-300
                                     {% if is_dark_mode %}
                                     bg-cyber-bg-surface/50 border-cyber-text-muted/30 text-cyber-text-primary
                                     placeholder-cyber-text-muted focus:border-cyber-neon-primary/50
                                     {% else %}
                                     bg-white border-gray-300 text-gray-900
                                     placeholder-gray-500 focus:border-blue-500 focus:ring-blue-500
                                     {% endif %}"
                              placeholder="توضیحات اختیاری در مورد دسته‌بندی..."></textarea>
                </div>
                
                <!-- Active Status -->
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" 
                               id="isActive" 
                               name="is_active" 
                               checked
                               class="rounded border-gray-300 
                                      {% if is_dark_mode %}
                                      text-cyber-neon-primary focus:ring-cyber-neon-primary/50
                                      {% else %}
                                      text-blue-600 focus:ring-blue-500
                                      {% endif %}">
                        <span class="mr-2 text-sm
                                   {% if is_dark_mode %}text-cyber-text-secondary{% else %}text-gray-700{% endif %}">
                            دسته‌بندی فعال باشد
                        </span>
                    </label>
                </div>
                
                <!-- Form Actions -->
                <div class="flex gap-3 pt-4">
                    <button type="submit" 
                            class="flex-1 px-4 py-3 rounded-lg font-medium transition-all duration-300
                                   {% if is_dark_mode %}
                                   bg-gradient-to-r from-cyber-neon-primary/20 to-cyber-neon-secondary/20 
                                   border border-cyber-neon-primary/30 text-cyber-neon-primary
                                   hover:border-cyber-neon-primary/50 hover:shadow-lg hover:shadow-cyber-neon-primary/20
                                   {% else %}
                                   bg-blue-600 text-white border border-blue-600
                                   hover:bg-blue-700 hover:border-blue-700
                                   {% endif %}">
                        ذخیره
                    </button>
                    <button type="button" 
                            @click="show = false"
                            class="flex-1 px-4 py-3 rounded-lg font-medium transition-all duration-300
                                   {% if is_dark_mode %}
                                   bg-cyber-bg-surface/50 border border-cyber-text-muted/30 text-cyber-text-secondary
                                   hover:border-cyber-text-secondary/50
                                   {% else %}
                                   bg-white text-gray-700 border border-gray-300
                                   hover:bg-gray-50 hover:border-gray-400
                                   {% endif %}">
                        انصراف
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
let isEditMode = false;

function openCreateCategoryModal() {
    isEditMode = false;
    document.getElementById('modalTitle').textContent = 'دسته‌بندی جدید';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('isActive').checked = true;
    
    // Show modal using Alpine.js
    const modal = document.getElementById('categoryModal');
    modal.__x.$data.show = true;
    modal.classList.remove('hidden');
}

function editCategory(id, name, namePersian, description, isActive) {
    isEditMode = true;
    document.getElementById('modalTitle').textContent = 'ویرایش دسته‌بندی';
    document.getElementById('categoryId').value = id;
    document.getElementById('nameEnglish').value = name;
    document.getElementById('namePersian').value = namePersian;
    document.getElementById('description').value = description;
    document.getElementById('isActive').checked = isActive;
    
    // Show modal using Alpine.js
    const modal = document.getElementById('categoryModal');
    modal.__x.$data.show = true;
    modal.classList.remove('hidden');
}

document.addEventListener('DOMContentLoaded', function() {
    const categoryForm = document.getElementById('categoryForm');
    
    if (categoryForm) {
        categoryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                name: formData.get('name'),
                name_persian: formData.get('name_persian'),
                description: formData.get('description'),
                is_active: formData.get('is_active') === 'on'
            };
            
            try {
                let url = '/jewelry/api/create-category/';
                let method = 'POST';
                
                if (isEditMode) {
                    // For edit mode, you would need to implement an update endpoint
                    // url = `/jewelry/api/update-category/${formData.get('categoryId')}/`;
                    // method = 'PUT';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'X-CSRFToken': window.zargarConfig.csrfToken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    
                    // Close modal
                    const modal = document.getElementById('categoryModal');
                    modal.__x.$data.show = false;
                    setTimeout(() => modal.classList.add('hidden'), 300);
                    
                    // Reload page to show new category
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                console.error('Error saving category:', error);
                showNotification('خطا در ذخیره دسته‌بندی', 'error');
            }
        });
    }
    
    // Initialize Persian number formatting
    const persianNumberElements = document.querySelectorAll('.persian-numbers');
    persianNumberElements.forEach(element => {
        if (window.PersianNumbers) {
            element.textContent = window.PersianNumbers.toPersian(element.textContent);
        }
    });
});

function showNotification(message, type) {
    // Use Alpine.js notification system if available
    if (window.Alpine && document.querySelector('[x-data]').__x) {
        document.querySelector('[x-data]').__x.$data.showNotification(message, type);
    } else {
        // Fallback to alert
        alert(message);
    }
}
</script>
{% endblock %}