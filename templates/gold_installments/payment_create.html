{% extends 'base_rtl.html' %}
{% load persian_tags %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Process Payment" %} - {{ contract.contract_number }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/gold-installments.css' %}" rel="stylesheet">
<link href="{% static 'css/persian-forms.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">{% trans "Process Payment" %}</h1>
                    <p class="text-muted">
                        {% trans "Contract" %}: {{ contract.contract_number }} - 
                        {{ contract.customer.persian_first_name }} {{ contract.customer.persian_last_name }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'gold_installments:contract_detail' contract.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        {% trans "Back to Contract" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Payment Form -->
        <div class="col-lg-8">
            <!-- Current Gold Price Alert -->
            <div class="alert alert-info d-flex align-items-center mb-4">
                <i class="fas fa-info-circle me-3"></i>
                <div>
                    <strong>{% trans "Current Gold Price" %}:</strong>
                    <span class="ms-2">{% persian_currency current_gold_price %}</span>
                    <small class="text-muted ms-2">{% trans "per gram (18 karat)" %}</small>
                </div>
            </div>

            <form method="post" id="payment-form">
                {% csrf_token %}
                
                <!-- Payment Details -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-credit-card me-2"></i>
                            {% trans "Payment Details" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.payment_date.id_for_label }}" class="form-label">
                                        {{ form.payment_date.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.payment_date }}
                                    {% if form.payment_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.payment_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.payment_method.id_for_label }}" class="form-label">
                                        {{ form.payment_method.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.payment_method }}
                                    {% if form.payment_method.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.payment_method.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.payment_amount_toman.id_for_label }}" class="form-label">
                                        {{ form.payment_amount_toman.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.payment_amount_toman }}
                                    {% if form.payment_amount_toman.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.payment_amount_toman.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.payment_amount_toman.help_text }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.gold_price_per_gram_at_payment.id_for_label }}" class="form-label">
                                        {{ form.gold_price_per_gram_at_payment.label }}
                                    </label>
                                    {{ form.gold_price_per_gram_at_payment }}
                                    {% if form.gold_price_per_gram_at_payment.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.gold_price_per_gram_at_payment.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">{{ form.gold_price_per_gram_at_payment.help_text }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.reference_number.id_for_label }}" class="form-label">
                                {{ form.reference_number.label }}
                            </label>
                            {{ form.reference_number }}
                            {% if form.reference_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.reference_number.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.reference_number.help_text }}</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.payment_notes.id_for_label }}" class="form-label">
                                {{ form.payment_notes.label }}
                            </label>
                            {{ form.payment_notes }}
                            {% if form.payment_notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.payment_notes.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.payment_notes.help_text }}</div>
                        </div>
                    </div>
                </div>

                <!-- Payment Calculation -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-calculator me-2"></i>
                            {% trans "Payment Calculation" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="payment-calculation" class="row">
                            <div class="col-md-4">
                                <div class="text-center p-3 border rounded">
                                    <div class="h5 mb-1 text-primary" id="payment-amount-display">-</div>
                                    <small class="text-muted">{% trans "Payment Amount" %}</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 border rounded">
                                    <div class="h5 mb-1 text-success" id="gold-weight-display">-</div>
                                    <small class="text-muted">{% trans "Gold Weight Equivalent" %}</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 border rounded">
                                    <div class="h5 mb-1 text-warning" id="remaining-after-payment">-</div>
                                    <small class="text-muted">{% trans "Remaining After Payment" %}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Price Protection Notice -->
                        {% if contract.has_price_protection %}
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-shield-alt me-2"></i>{% trans "Price Protection Active" %}</h6>
                            <p class="mb-0">
                                {% trans "This contract has price protection enabled." %}
                                {% if contract.price_ceiling_per_gram %}
                                    {% trans "Maximum price" %}: {% persian_currency contract.price_ceiling_per_gram %}
                                {% endif %}
                                {% if contract.price_floor_per_gram %}
                                    {% trans "Minimum price" %}: {% persian_currency contract.price_floor_per_gram %}
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}

                        <!-- Early Payment Discount -->
                        {% if contract.early_payment_discount_percentage > 0 %}
                        <div class="alert alert-success mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="apply-early-discount">
                                <label class="form-check-label" for="apply-early-discount">
                                    <strong>{% trans "Apply Early Payment Discount" %}</strong>
                                    ({% persian_number contract.early_payment_discount_percentage %}%)
                                </label>
                            </div>
                            <div id="discount-calculation" class="mt-2 d-none">
                                <small class="text-muted">
                                    {% trans "Discount amount" %}: <span id="discount-amount">-</span><br>
                                    {% trans "Final amount" %}: <span id="discounted-amount">-</span>
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="card shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'gold_installments:contract_detail' contract.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                {% trans "Cancel" %}
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" id="preview-payment">
                                    <i class="fas fa-eye me-2"></i>
                                    {% trans "Preview Payment" %}
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check me-2"></i>
                                    {% trans "Process Payment" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Contract Summary Sidebar -->
        <div class="col-lg-4">
            <!-- Contract Overview -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Contract Overview" %}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Contract Number" %}</small>
                        <div class="fw-bold">{{ contract.contract_number }}</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Customer" %}</small>
                        <div>{{ contract.customer.persian_first_name }} {{ contract.customer.persian_last_name }}</div>
                        <small class="text-muted">{{ contract.customer.phone_number }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Remaining Gold Weight" %}</small>
                        <div class="h5 text-warning">{% persian_weight contract.remaining_gold_weight_grams 'gram' %}</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Current Value" %}</small>
                        <div class="h5 text-primary">{% persian_currency current_value.total_value_toman %}</div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Completion Progress" %}</small>
                        <div class="progress mt-1" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ contract.completion_percentage }}%"
                                 aria-valuenow="{{ contract.completion_percentage }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                {% persian_number contract.completion_percentage %}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment History Summary -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Payment Summary" %}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Total Payments" %}</small>
                        <div class="fw-bold">{% persian_number payment_summary.total_payments %}</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Total Amount Paid" %}</small>
                        <div class="fw-bold text-success">{% persian_currency payment_summary.total_amount_paid %}</div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Total Gold Weight Paid" %}</small>
                        <div class="fw-bold text-success">{% persian_weight payment_summary.total_gold_weight_paid 'gram' %}</div>
                    </div>
                    
                    {% if payment_summary.last_payment_date %}
                    <div class="mb-3">
                        <small class="text-muted">{% trans "Last Payment" %}</small>
                        <div>{{ payment_summary.last_payment_date }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Payment Presets -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Quick Payment Amounts" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm quick-amount" 
                                data-amount="1000000">
                            {% persian_currency 1000000 %}
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm quick-amount" 
                                data-amount="2000000">
                            {% persian_currency 2000000 %}
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm quick-amount" 
                                data-amount="5000000">
                            {% persian_currency 5000000 %}
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                id="pay-remaining">
                            {% trans "Pay Remaining Balance" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Preview Modal -->
<div class="modal fade" id="paymentPreviewModal" tabindex="-1" aria-labelledby="paymentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentPreviewModalLabel">{% trans "Payment Preview" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="payment-preview-content">
                    <!-- Payment preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <button type="button" class="btn btn-success" onclick="$('#payment-form').submit();">
                    {% trans "Confirm Payment" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/gold-installments.js' %}"></script>
<script>
$(document).ready(function() {
    const currentGoldPrice = {{ current_gold_price }};
    const remainingWeight = {{ contract.remaining_gold_weight_grams }};
    const hasEarlyDiscount = {{ contract.early_payment_discount_percentage|yesno:"true,false" }};
    const discountPercentage = {{ contract.early_payment_discount_percentage }};
    
    // Payment calculation
    function updatePaymentCalculation() {
        const paymentAmount = parseFloat($('#{{ form.payment_amount_toman.id_for_label }}').val()) || 0;
        const goldPrice = parseFloat($('#{{ form.gold_price_per_gram_at_payment.id_for_label }}').val()) || currentGoldPrice;
        
        if (paymentAmount > 0 && goldPrice > 0) {
            const goldWeight = paymentAmount / goldPrice;
            const remainingAfterPayment = Math.max(0, remainingWeight - goldWeight);
            
            $('#payment-amount-display').text(PersianFormatter.formatCurrency(paymentAmount));
            $('#gold-weight-display').text(PersianFormatter.formatWeight(goldWeight, 'gram'));
            $('#remaining-after-payment').text(PersianFormatter.formatWeight(remainingAfterPayment, 'gram'));
            
            // Early payment discount calculation
            if (hasEarlyDiscount && $('#apply-early-discount').is(':checked')) {
                const discountAmount = paymentAmount * (discountPercentage / 100);
                const discountedAmount = paymentAmount - discountAmount;
                
                $('#discount-amount').text(PersianFormatter.formatCurrency(discountAmount));
                $('#discounted-amount').text(PersianFormatter.formatCurrency(discountedAmount));
                $('#discount-calculation').removeClass('d-none');
            } else {
                $('#discount-calculation').addClass('d-none');
            }
        } else {
            $('#payment-amount-display').text('-');
            $('#gold-weight-display').text('-');
            $('#remaining-after-payment').text('-');
        }
    }
    
    // Event listeners
    $('#{{ form.payment_amount_toman.id_for_label }}, #{{ form.gold_price_per_gram_at_payment.id_for_label }}').on('input', updatePaymentCalculation);
    $('#apply-early-discount').change(updatePaymentCalculation);
    
    // Quick amount buttons
    $('.quick-amount').click(function() {
        const amount = $(this).data('amount');
        $('#{{ form.payment_amount_toman.id_for_label }}').val(amount);
        updatePaymentCalculation();
    });
    
    // Pay remaining balance
    $('#pay-remaining').click(function() {
        const remainingValue = remainingWeight * currentGoldPrice;
        $('#{{ form.payment_amount_toman.id_for_label }}').val(remainingValue);
        updatePaymentCalculation();
    });
    
    // Payment preview
    $('#preview-payment').click(function() {
        const paymentAmount = $('#{{ form.payment_amount_toman.id_for_label }}').val();
        const goldPrice = $('#{{ form.gold_price_per_gram_at_payment.id_for_label }}').val();
        
        if (!paymentAmount || !goldPrice) {
            alert('{% trans "Please enter payment amount and gold price" %}');
            return;
        }
        
        // Generate preview content
        const goldWeight = parseFloat(paymentAmount) / parseFloat(goldPrice);
        const remainingAfter = Math.max(0, remainingWeight - goldWeight);
        
        const previewContent = `
            <div class="row">
                <div class="col-md-6">
                    <h6>{% trans "Payment Details" %}</h6>
                    <p><strong>{% trans "Amount" %}:</strong> ${PersianFormatter.formatCurrency(paymentAmount)}</p>
                    <p><strong>{% trans "Gold Price" %}:</strong> ${PersianFormatter.formatCurrency(goldPrice)}</p>
                    <p><strong>{% trans "Method" %}:</strong> ${$('#{{ form.payment_method.id_for_label }} option:selected').text()}</p>
                </div>
                <div class="col-md-6">
                    <h6>{% trans "Gold Weight Calculation" %}</h6>
                    <p><strong>{% trans "Gold Weight Equivalent" %}:</strong> ${PersianFormatter.formatWeight(goldWeight, 'gram')}</p>
                    <p><strong>{% trans "Remaining After Payment" %}:</strong> ${PersianFormatter.formatWeight(remainingAfter, 'gram')}</p>
                    <p><strong>{% trans "Completion" %}:</strong> ${Math.round(((remainingWeight - remainingAfter) / remainingWeight) * 100)}%</p>
                </div>
            </div>
        `;
        
        $('#payment-preview-content').html(previewContent);
        $('#paymentPreviewModal').modal('show');
    });
    
    // Initial calculation
    updatePaymentCalculation();
});
</script>
{% endblock %}