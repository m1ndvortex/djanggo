{% extends 'base_rtl.html' %}
{% load persian_tags %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Notification Management" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/notifications.css' %}" rel="stylesheet">
<style>
.notification-card {
    transition: all 0.3s ease;
    border-right: 4px solid #17a2b8;
}
.notification-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.notification-card.pending { border-right-color: #ffc107; }
.notification-card.sent { border-right-color: #28a745; }
.notification-card.failed { border-right-color: #dc3545; }
.notification-card.delivered { border-right-color: #007bff; }

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.stats-card.warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stats-card.success {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stats-card.danger {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.notification-status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}

.template-preview {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    font-family: 'Vazir', sans-serif;
    direction: rtl;
    max-height: 200px;
    overflow-y: auto;
}

.quick-action-btn {
    margin: 0.25rem;
    border-radius: 20px;
    padding: 0.5rem 1rem;
}

/* Dark mode styles */
[data-theme="dark"] .stats-card {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    border: 1px solid rgba(0, 212, 255, 0.2);
}

[data-theme="dark"] .notification-card {
    background: rgba(26, 29, 41, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

[data-theme="dark"] .template-preview {
    background: rgba(37, 42, 58, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.06);
    color: #ffffff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">{% trans "Notification Management" %}</h1>
                    <p class="text-muted">{% trans "Manage customer notifications, templates, and delivery status" %} - Persian RTL Interface</p>
                </div>
                <div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-success" onclick="showBulkNotificationModal()">
                            <i class="fas fa-paper-plane me-2"></i>
                            {% trans "Send Bulk Notifications" %}
                        </button>
                        <a href="{% url 'core:notifications:template_list' %}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i>
                            {% trans "Manage Templates" %}
                        </a>
                        <button class="btn btn-info" onclick="refreshStatistics()">
                            <i class="fas fa-sync me-2"></i>
                            {% trans "Refresh" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statisticsCards">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-uppercase mb-1">
                            {% trans "Total Notifications" %}
                        </div>
                        <div class="h4 mb-0 font-weight-bold">
                            {% persian_number notification_stats.total_notifications %}
                        </div>
                    </div>
                    <div>
                        <i class="fas fa-bell fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card warning">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-uppercase mb-1">
                            {% trans "Pending" %}
                        </div>
                        <div class="h4 mb-0 font-weight-bold">
                            {% persian_number notification_stats.pending_notifications %}
                        </div>
                    </div>
                    <div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card success">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-uppercase mb-1">
                            {% trans "Sent Today" %}
                        </div>
                        <div class="h4 mb-0 font-weight-bold">
                            {% persian_number notification_stats.sent_today %}
                        </div>
                    </div>
                    <div>
                        <i class="fas fa-paper-plane fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card danger">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-uppercase mb-1">
                            {% trans "Failed Today" %}
                        </div>
                        <div class="h4 mb-0 font-weight-bold">
                            {% persian_number notification_stats.failed_today %}
                        </div>
                    </div>
                    <div>
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quick Actions -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Quick Actions" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary quick-action-btn" onclick="showSingleNotificationModal()">
                            <i class="fas fa-bell me-2"></i>
                            {% trans "Send Single Notification" %}
                        </button>
                        <button class="btn btn-outline-success quick-action-btn" onclick="sendPaymentReminders()">
                            <i class="fas fa-money-bill-wave me-2"></i>
                            {% trans "Send Payment Reminders" %}
                        </button>
                        <button class="btn btn-outline-info quick-action-btn" onclick="sendBirthdayGreetings()">
                            <i class="fas fa-birthday-cake me-2"></i>
                            {% trans "Send Birthday Greetings" %}
                        </button>
                        <button class="btn btn-outline-warning quick-action-btn" onclick="sendSpecialOffers()">
                            <i class="fas fa-gift me-2"></i>
                            {% trans "Send Special Offers" %}
                        </button>
                        <hr>
                        <a href="{% url 'core:notifications:history' %}" class="btn btn-outline-secondary quick-action-btn">
                            <i class="fas fa-history me-2"></i>
                            {% trans "View History" %}
                        </a>
                        <button class="btn btn-outline-dark quick-action-btn" onclick="showScheduleModal()">
                            <i class="fas fa-calendar me-2"></i>
                            {% trans "Schedule Notification" %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Available Templates -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Available Templates" %}</h6>
                    <a href="{% url 'core:notifications:template_create' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>{% trans "New" %}
                    </a>
                </div>
                <div class="card-body">
                    {% for template in notification_templates %}
                    <div class="card notification-card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title mb-1">{{ template.name }}</h6>
                                    <small class="text-muted">{{ template.get_template_type_display }}</small>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="previewTemplate({{ template.id }})">
                                                <i class="fas fa-eye me-2"></i>{% trans "Preview" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'core:notifications:template_edit' template.id %}">
                                                <i class="fas fa-edit me-2"></i>{% trans "Edit" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="useTemplate('{{ template.template_type }}')">
                                                <i class="fas fa-paper-plane me-2"></i>{% trans "Use Template" %}
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-3">
                        <i class="fas fa-file-alt fa-2x text-gray-300 mb-2"></i>
                        <p class="text-muted">{% trans "No templates available" %}</p>
                        <a href="{% url 'core:notifications:template_create' %}" class="btn btn-sm btn-primary">
                            {% trans "Create First Template" %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Recent Notifications" %}</h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="statusFilter" id="all" value="" checked>
                        <label class="btn btn-outline-secondary" for="all">{% trans "All" %}</label>
                        
                        <input type="radio" class="btn-check" name="statusFilter" id="pending" value="pending">
                        <label class="btn btn-outline-warning" for="pending">{% trans "Pending" %}</label>
                        
                        <input type="radio" class="btn-check" name="statusFilter" id="sent" value="sent">
                        <label class="btn btn-outline-success" for="sent">{% trans "Sent" %}</label>
                        
                        <input type="radio" class="btn-check" name="statusFilter" id="failed" value="failed">
                        <label class="btn btn-outline-danger" for="failed">{% trans "Failed" %}</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="notificationsList">
                        {% for notification in notifications %}
                        <div class="notification-card mb-3 notification-item" data-status="{{ notification.status }}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if notification.delivery_method == 'sms' %}
                                                    <i class="fas fa-sms fa-lg text-primary"></i>
                                                {% elif notification.delivery_method == 'email' %}
                                                    <i class="fas fa-envelope fa-lg text-info"></i>
                                                {% elif notification.delivery_method == 'push' %}
                                                    <i class="fas fa-mobile-alt fa-lg text-success"></i>
                                                {% else %}
                                                    <i class="fas fa-bell fa-lg text-secondary"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <h6 class="mb-1">{{ notification.title }}</h6>
                                                <p class="mb-1 text-muted small">{{ notification.recipient_name }}</p>
                                                <small class="text-muted">
                                                    {{ notification.created_at|date:"Y/m/d H:i" }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <span class="notification-status-badge badge 
                                            {% if notification.status == 'pending' %}bg-warning
                                            {% elif notification.status == 'sent' %}bg-success
                                            {% elif notification.status == 'delivered' %}bg-info
                                            {% elif notification.status == 'failed' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ notification.get_status_display }}
                                        </span>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'core:notifications:detail' notification.id %}" 
                                               class="btn btn-outline-info" title="{% trans 'View Details' %}">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if notification.status == 'pending' %}
                                            <button class="btn btn-outline-danger" 
                                                    onclick="cancelNotification({{ notification.id }})"
                                                    title="{% trans 'Cancel' %}">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% elif notification.status == 'failed' and notification.can_retry %}
                                            <button class="btn btn-outline-warning" 
                                                    onclick="retryNotification({{ notification.id }})"
                                                    title="{% trans 'Retry' %}">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5">
                            <i class="fas fa-bell fa-3x text-gray-300 mb-3"></i>
                            <h5 class="text-gray-600">{% trans "No notifications yet" %}</h5>
                            <p class="text-muted">{% trans "Start by sending your first notification or creating a template." %}</p>
                            <button class="btn btn-primary" onclick="showSingleNotificationModal()">
                                {% trans "Send First Notification" %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="{% trans 'Notifications pagination' %}">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "Previous" %}</a>
                                </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "Next" %}</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Delivery Logs -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "Recent Delivery Logs" %}</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "Time" %}</th>
                                    <th>{% trans "Notification" %}</th>
                                    <th>{% trans "Action" %}</th>
                                    <th>{% trans "Provider" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Details" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_logs %}
                                <tr>
                                    <td>
                                        <small>{{ log.timestamp|date:"H:i" }}</small>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ log.notification.title|truncatechars:30 }}</strong>
                                        </div>
                                        <small class="text-muted">{{ log.notification.recipient_name }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ log.action }}</span>
                                    </td>
                                    <td>{{ log.provider_name|default:"-" }}</td>
                                    <td>
                                        {% if log.success %}
                                            <span class="badge bg-success">{% trans "Success" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "Failed" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.error_message %}
                                            <small class="text-danger">{{ log.error_message|truncatechars:50 }}</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        {% trans "No delivery logs available" %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include modals -->
{% include 'core/notifications/modals/single_notification.html' %}
{% include 'core/notifications/modals/bulk_notification.html' %}
{% include 'core/notifications/modals/schedule_notification.html' %}
{% include 'core/notifications/modals/template_preview.html' %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/notifications.js' %}"></script>
<script>
// Initialize notification management
document.addEventListener('DOMContentLoaded', function() {
    // Status filter functionality
    const statusFilters = document.querySelectorAll('input[name="statusFilter"]');
    statusFilters.forEach(filter => {
        filter.addEventListener('change', function() {
            filterNotifications(this.value);
        });
    });
    
    // Auto-refresh statistics every 30 seconds
    setInterval(refreshStatistics, 30000);
});

function filterNotifications(status) {
    const notifications = document.querySelectorAll('.notification-item');
    notifications.forEach(notification => {
        if (status === '' || notification.dataset.status === status) {
            notification.style.display = 'block';
        } else {
            notification.style.display = 'none';
        }
    });
}

function refreshStatistics() {
    fetch('{% url "core:notifications:statistics_ajax" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatisticsCards(data.stats);
            }
        })
        .catch(error => {
            console.error('Error refreshing statistics:', error);
        });
}

function updateStatisticsCards(stats) {
    // Update statistics cards with new data
    const cards = document.querySelectorAll('#statisticsCards .h4');
    if (cards.length >= 4) {
        cards[0].textContent = persianNumber(stats.total_notifications);
        cards[1].textContent = persianNumber(stats.pending_notifications);
        cards[2].textContent = persianNumber(stats.sent_today);
        cards[3].textContent = persianNumber(stats.failed_today);
    }
}

function persianNumber(num) {
    const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
    return num.toString().replace(/\d/g, (digit) => persianDigits[digit]);
}

function showSingleNotificationModal() {
    const modal = new bootstrap.Modal(document.getElementById('singleNotificationModal'));
    modal.show();
}

function showBulkNotificationModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkNotificationModal'));
    modal.show();
}

function showScheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('scheduleNotificationModal'));
    modal.show();
}

function previewTemplate(templateId) {
    fetch(`{% url 'core:notifications:template_preview_ajax' 0 %}`.replace('0', templateId))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('previewTitle').textContent = data.title;
                document.getElementById('previewContent').textContent = data.content;
                document.getElementById('previewType').textContent = data.template_type;
                
                const modal = new bootstrap.Modal(document.getElementById('templatePreviewModal'));
                modal.show();
            } else {
                showNotification('خطا در نمایش الگو: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error previewing template:', error);
            showNotification('خطا در اتصال به سرور', 'error');
        });
}

function useTemplate(templateType) {
    document.getElementById('singleTemplateType').value = templateType;
    showSingleNotificationModal();
}

function cancelNotification(notificationId) {
    if (confirm('{% trans "Are you sure you want to cancel this notification?" %}')) {
        fetch(`{% url 'core:notifications:cancel_ajax' 0 %}`.replace('0', notificationId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                location.reload();
            } else {
                showNotification(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error cancelling notification:', error);
            showNotification('خطا در لغو اعلان', 'error');
        });
    }
}

function retryNotification(notificationId) {
    if (confirm('{% trans "Do you want to retry sending this notification?" %}')) {
        fetch(`{% url 'core:notifications:retry_ajax' 0 %}`.replace('0', notificationId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                location.reload();
            } else {
                showNotification(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error retrying notification:', error);
            showNotification('خطا در تلاش مجدد', 'error');
        });
    }
}

// Quick action functions
function sendPaymentReminders() {
    if (confirm('{% trans "Send payment reminders to all customers with overdue payments?" %}')) {
        // Implementation for payment reminders
        showNotification('{% trans "Payment reminders will be sent shortly" %}', 'info');
    }
}

function sendBirthdayGreetings() {
    if (confirm('{% trans "Send birthday greetings to customers with birthdays today?" %}')) {
        // Implementation for birthday greetings
        showNotification('{% trans "Birthday greetings will be sent shortly" %}', 'info');
    }
}

function sendSpecialOffers() {
    // Show special offer modal or form
    showNotification('{% trans "Special offer feature coming soon" %}', 'info');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type = 'info') {
    // Create notification toast
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; left: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}