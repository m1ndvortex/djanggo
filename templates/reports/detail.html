{% extends 'base_rtl.html' %}
{% load static %}
{% load i18n %}

{% block title %}جزئیات گزارش {{ report.template.name_persian|default:report.template.name }} - زرگر{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/reports.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen p-6 
            {% if is_dark_mode %}
            bg-gradient-to-br from-cyber-bg-primary via-cyber-bg-secondary to-cyber-bg-surface
            {% else %}
            bg-gray-50
            {% endif %}">
    
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold 
                           {% if is_dark_mode %}
                           text-cyber-text-primary bg-gradient-to-r from-cyber-neon-primary to-cyber-neon-secondary bg-clip-text text-transparent
                           {% else %}
                           text-gray-900
                           {% endif %}">
                    {{ report.template.name_persian|default:report.template.name }}
                </h1>
                <p class="mt-2 
                         {% if is_dark_mode %}
                         text-cyber-text-secondary
                         {% else %}
                         text-gray-600
                         {% endif %}">
                    شناسه گزارش: {{ report.report_id }}
                </p>
            </div>
            
            <div class="flex space-x-4 space-x-reverse">
                {% if report.status == 'completed' %}
                <!-- Download Options -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" 
                            class="inline-flex items-center px-6 py-3 rounded-lg font-medium transition-all duration-300
                                   {% if is_dark_mode %}
                                   bg-gradient-to-r from-cyber-neon-success/20 to-cyber-neon-secondary/20 
                                   border border-cyber-neon-success/30 text-cyber-text-primary
                                   hover:border-cyber-neon-success/50 hover:shadow-lg hover:shadow-cyber-neon-success/20
                                   {% else %}
                                   bg-green-600 text-white hover:bg-green-700 shadow-sm hover:shadow-md
                                   {% endif %}">
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        دانلود گزارش
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" 
                         @click.away="open = false"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute left-0 mt-2 w-48 rounded-md shadow-lg z-10
                                {% if is_dark_mode %}
                                bg-cyber-bg-surface border border-cyber-border-glass backdrop-blur-sm
                                {% else %}
                                bg-white border border-gray-200
                                {% endif %}">
                        <div class="py-1">
                            <a href="{% url 'reports:download' report.report_id 'pdf' %}" 
                               class="block px-4 py-2 text-sm transition-colors
                                      {% if is_dark_mode %}
                                      text-cyber-text-primary hover:bg-cyber-bg-elevated
                                      {% else %}
                                      text-gray-700 hover:bg-gray-100
                                      {% endif %}">
                                <svg class="w-4 h-4 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                دانلود PDF
                            </a>
                            <a href="{% url 'reports:download' report.report_id 'excel' %}" 
                               class="block px-4 py-2 text-sm transition-colors
                                      {% if is_dark_mode %}
                                      text-cyber-text-primary hover:bg-cyber-bg-elevated
                                      {% else %}
                                      text-gray-700 hover:bg-gray-100
                                      {% endif %}">
                                <svg class="w-4 h-4 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                دانلود Excel
                            </a>
                            <a href="{% url 'reports:download' report.report_id 'csv' %}" 
                               class="block px-4 py-2 text-sm transition-colors
                                      {% if is_dark_mode %}
                                      text-cyber-text-primary hover:bg-cyber-bg-elevated
                                      {% else %}
                                      text-gray-700 hover:bg-gray-100
                                      {% endif %}">
                                <svg class="w-4 h-4 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                دانلود CSV
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <a href="{% url 'reports:list' %}" 
                   class="inline-flex items-center px-6 py-3 rounded-lg font-medium transition-all duration-300
                          {% if is_dark_mode %}
                          bg-cyber-bg-surface/80 border border-cyber-border-glass text-cyber-text-primary
                          hover:border-cyber-neon-secondary/30 hover:bg-cyber-bg-elevated/80
                          {% else %}
                          bg-white border border-gray-300 text-gray-700 hover:bg-gray-50
                          {% endif %}">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    بازگشت به لیست
                </a>
            </div>
        </div>
    </div>

    <!-- Report Info Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- Status Card -->
        <div class="p-6 rounded-xl transition-all duration-300
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                    border border-cyber-border-glass backdrop-blur-sm
                    {% else %}
                    bg-white border border-gray-200 shadow-sm
                    {% endif %}">
            <div class="flex items-center">
                <div class="p-3 rounded-lg 
                           {% if report.status == 'completed' %}
                               {% if is_dark_mode %}bg-cyber-neon-success/20 text-cyber-neon-success{% else %}bg-green-100 text-green-600{% endif %}
                           {% elif report.status == 'generating' %}
                               {% if is_dark_mode %}bg-cyber-neon-warning/20 text-cyber-neon-warning{% else %}bg-yellow-100 text-yellow-600{% endif %}
                           {% elif report.status == 'failed' %}
                               {% if is_dark_mode %}bg-cyber-neon-danger/20 text-cyber-neon-danger{% else %}bg-red-100 text-red-600{% endif %}
                           {% else %}
                               {% if is_dark_mode %}bg-cyber-text-muted/20 text-cyber-text-muted{% else %}bg-gray-100 text-gray-600{% endif %}
                           {% endif %}">
                    {% if report.status == 'completed' %}
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    {% elif report.status == 'generating' %}
                        <svg class="animate-spin w-6 h-6" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    {% elif report.status == 'failed' %}
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                    {% else %}
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                    {% endif %}
                </div>
                <div class="mr-4">
                    <p class="text-sm font-medium 
                             {% if is_dark_mode %}
                             text-cyber-text-secondary
                             {% else %}
                             text-gray-600
                             {% endif %}">
                        وضعیت
                    </p>
                    <p class="text-lg font-bold 
                             {% if is_dark_mode %}
                             text-cyber-text-primary
                             {% else %}
                             text-gray-900
                             {% endif %}">
                        {{ report.get_status_display }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Generated Date -->
        <div class="p-6 rounded-xl transition-all duration-300
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                    border border-cyber-border-glass backdrop-blur-sm
                    {% else %}
                    bg-white border border-gray-200 shadow-sm
                    {% endif %}">
            <div class="flex items-center">
                <div class="p-3 rounded-lg 
                           {% if is_dark_mode %}
                           bg-cyber-neon-primary/20 text-cyber-neon-primary
                           {% else %}
                           bg-blue-100 text-blue-600
                           {% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="mr-4">
                    <p class="text-sm font-medium 
                             {% if is_dark_mode %}
                             text-cyber-text-secondary
                             {% else %}
                             text-gray-600
                             {% endif %}">
                        تاریخ تولید
                    </p>
                    <p class="text-lg font-bold persian-numbers
                             {% if is_dark_mode %}
                             text-cyber-text-primary
                             {% else %}
                             text-gray-900
                             {% endif %}">
                        {{ report.generated_at|date:"Y/m/d H:i" }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Format -->
        <div class="p-6 rounded-xl transition-all duration-300
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                    border border-cyber-border-glass backdrop-blur-sm
                    {% else %}
                    bg-white border border-gray-200 shadow-sm
                    {% endif %}">
            <div class="flex items-center">
                <div class="p-3 rounded-lg 
                           {% if is_dark_mode %}
                           bg-cyber-neon-purple/20 text-cyber-neon-purple
                           {% else %}
                           bg-purple-100 text-purple-600
                           {% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div class="mr-4">
                    <p class="text-sm font-medium 
                             {% if is_dark_mode %}
                             text-cyber-text-secondary
                             {% else %}
                             text-gray-600
                             {% endif %}">
                        فرمت خروجی
                    </p>
                    <p class="text-lg font-bold 
                             {% if is_dark_mode %}
                             text-cyber-text-primary
                             {% else %}
                             text-gray-900
                             {% endif %}">
                        {{ report.get_output_format_display|upper }}
                    </p>
                </div>
            </div>
        </div>

        <!-- File Size -->
        {% if report.file_size_bytes %}
        <div class="p-6 rounded-xl transition-all duration-300
                    {% if is_dark_mode %}
                    bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                    border border-cyber-border-glass backdrop-blur-sm
                    {% else %}
                    bg-white border border-gray-200 shadow-sm
                    {% endif %}">
            <div class="flex items-center">
                <div class="p-3 rounded-lg 
                           {% if is_dark_mode %}
                           bg-cyber-neon-secondary/20 text-cyber-neon-secondary
                           {% else %}
                           bg-green-100 text-green-600
                           {% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="mr-4">
                    <p class="text-sm font-medium 
                             {% if is_dark_mode %}
                             text-cyber-text-secondary
                             {% else %}
                             text-gray-600
                             {% endif %}">
                        حجم فایل
                    </p>
                    <p class="text-lg font-bold persian-numbers
                             {% if is_dark_mode %}
                             text-cyber-text-primary
                             {% else %}
                             text-gray-900
                             {% endif %}">
                        {% if report.file_size_bytes < 1024 %}
                            {{ report.file_size_bytes }} بایت
                        {% elif report.file_size_bytes < 1048576 %}
                            {{ report.file_size_bytes|floatformat:1|div:1024 }} کیلوبایت
                        {% else %}
                            {{ report.file_size_bytes|floatformat:1|div:1048576 }} مگابایت
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Report Preview -->
        <div class="lg:col-span-2">
            {% if report.status == 'completed' and report_preview %}
            <div class="p-6 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                        border border-cyber-border-glass backdrop-blur-sm
                        {% else %}
                        bg-white border border-gray-200 shadow-sm
                        {% endif %}">
                
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold 
                               {% if is_dark_mode %}
                               text-cyber-text-primary
                               {% else %}
                               text-gray-900
                               {% endif %}">
                        پیش‌نمایش گزارش
                    </h2>
                    
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="text-sm 
                                   {% if is_dark_mode %}
                                   text-cyber-text-secondary
                                   {% else %}
                                   text-gray-600
                                   {% endif %}">
                            {{ report_preview.report_title_persian }}
                        </span>
                    </div>
                </div>

                <!-- Report Content Preview -->
                <div class="overflow-x-auto">
                    {% if report.template.report_type == 'trial_balance' %}
                        {% include 'reports/previews/trial_balance.html' with data=report_preview %}
                    {% elif report.template.report_type == 'profit_loss' %}
                        {% include 'reports/previews/profit_loss.html' with data=report_preview %}
                    {% elif report.template.report_type == 'balance_sheet' %}
                        {% include 'reports/previews/balance_sheet.html' with data=report_preview %}
                    {% elif report.template.report_type == 'inventory_valuation' %}
                        {% include 'reports/previews/inventory_valuation.html' with data=report_preview %}
                    {% elif report.template.report_type == 'customer_aging' %}
                        {% include 'reports/previews/customer_aging.html' with data=report_preview %}
                    {% else %}
                        <div class="text-center py-8">
                            <p class="text-sm 
                                     {% if is_dark_mode %}
                                     text-cyber-text-secondary
                                     {% else %}
                                     text-gray-600
                                     {% endif %}">
                                پیش‌نمایش برای این نوع گزارش در دسترس نیست
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            {% elif report.status == 'generating' %}
            <!-- Generating Status -->
            <div class="p-6 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                        border border-cyber-border-glass backdrop-blur-sm
                        {% else %}
                        bg-white border border-gray-200 shadow-sm
                        {% endif %}">
                
                <div class="text-center py-12" x-data="reportProgress('{{ report.report_id }}')" x-init="startMonitoring()">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4
                                {% if is_dark_mode %}
                                bg-cyber-neon-warning/20 text-cyber-neon-warning
                                {% else %}
                                bg-yellow-100 text-yellow-600
                                {% endif %}">
                        <svg class="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    
                    <h3 class="text-lg font-medium mb-2 
                               {% if is_dark_mode %}
                               text-cyber-text-primary
                               {% else %}
                               text-gray-900
                               {% endif %}">
                        در حال تولید گزارش
                    </h3>
                    
                    <p class="text-sm mb-4 
                             {% if is_dark_mode %}
                             text-cyber-text-secondary
                             {% else %}
                             text-gray-600
                             {% endif %}">
                        لطفاً صبر کنید، گزارش شما در حال آماده‌سازی است...
                    </p>
                    
                    <!-- Progress Bar -->
                    <div class="w-full max-w-md mx-auto rounded-full h-2 mb-4
                                {% if is_dark_mode %}
                                bg-cyber-bg-surface
                                {% else %}
                                bg-gray-200
                                {% endif %}">
                        <div class="h-2 rounded-full transition-all duration-300
                                   {% if is_dark_mode %}
                                   bg-gradient-to-r from-cyber-neon-warning to-cyber-neon-secondary
                                   {% else %}
                                   bg-gradient-to-r from-yellow-600 to-yellow-700
                                   {% endif %}"
                             :style="`width: ${progress}%`"></div>
                    </div>
                    
                    <p class="text-xs 
                             {% if is_dark_mode %}
                             text-cyber-text-muted
                             {% else %}
                             text-gray-500
                             {% endif %} 
                             persian-numbers" 
                       x-text="`${progress}% تکمیل شده`">
                    </p>
                </div>
            </div>
            
            {% elif report.status == 'failed' %}
            <!-- Error Status -->
            <div class="p-6 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                        border border-cyber-border-glass backdrop-blur-sm
                        {% else %}
                        bg-white border border-gray-200 shadow-sm
                        {% endif %}">
                
                <div class="text-center py-12">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4
                                {% if is_dark_mode %}
                                bg-cyber-neon-danger/20 text-cyber-neon-danger
                                {% else %}
                                bg-red-100 text-red-600
                                {% endif %}">
                        <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    
                    <h3 class="text-lg font-medium mb-2 
                               {% if is_dark_mode %}
                               text-cyber-text-primary
                               {% else %}
                               text-gray-900
                               {% endif %}">
                        خطا در تولید گزارش
                    </h3>
                    
                    {% if report.error_message %}
                    <p class="text-sm mb-4 
                             {% if is_dark_mode %}
                             text-cyber-neon-danger
                             {% else %}
                             text-red-600
                             {% endif %}">
                        {{ report.error_message }}
                    </p>
                    {% endif %}
                    
                    <div class="flex justify-center space-x-4 space-x-reverse">
                        <a href="{% url 'reports:generate_template' report.template.id %}" 
                           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md 
                                  {% if is_dark_mode %}
                                  text-cyber-bg-primary bg-cyber-neon-primary hover:bg-cyber-neon-secondary
                                  {% else %}
                                  text-white bg-blue-600 hover:bg-blue-700
                                  {% endif %}">
                            تولید مجدد
                        </a>
                        
                        <a href="{% url 'reports:list' %}" 
                           class="inline-flex items-center px-4 py-2 border text-sm font-medium rounded-md 
                                  {% if is_dark_mode %}
                                  border-cyber-border-glass text-cyber-text-primary hover:bg-cyber-bg-elevated
                                  {% else %}
                                  border-gray-300 text-gray-700 bg-white hover:bg-gray-50
                                  {% endif %}">
                            بازگشت به لیست
                        </a>
                    </div>
                </div>
            </div>
            
            {% else %}
            <!-- Pending Status -->
            <div class="p-6 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                        border border-cyber-border-glass backdrop-blur-sm
                        {% else %}
                        bg-white border border-gray-200 shadow-sm
                        {% endif %}">
                
                <div class="text-center py-12">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4
                                {% if is_dark_mode %}
                                bg-cyber-text-muted/20 text-cyber-text-muted
                                {% else %}
                                bg-gray-100 text-gray-600
                                {% endif %}">
                        <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    
                    <h3 class="text-lg font-medium mb-2 
                               {% if is_dark_mode %}
                               text-cyber-text-primary
                               {% else %}
                               text-gray-900
                               {% endif %}">
                        گزارش در انتظار تولید
                    </h3>
                    
                    <p class="text-sm 
                             {% if is_dark_mode %}
                             text-cyber-text-secondary
                             {% else %}
                             text-gray-600
                             {% endif %}">
                        گزارش شما در صف تولید قرار دارد و به زودی آماده خواهد شد.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            
            <!-- Report Details -->
            <div class="p-6 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                        border border-cyber-border-glass backdrop-blur-sm
                        {% else %}
                        bg-white border border-gray-200 shadow-sm
                        {% endif %}">
                
                <h3 class="text-lg font-semibold mb-4 
                           {% if is_dark_mode %}
                           text-cyber-text-primary
                           {% else %}
                           text-gray-900
                           {% endif %}">
                    جزئیات گزارش
                </h3>

                <div class="space-y-4">
                    <div>
                        <p class="text-sm font-medium 
                                 {% if is_dark_mode %}
                                 text-cyber-text-secondary
                                 {% else %}
                                 text-gray-600
                                 {% endif %}">
                            نوع گزارش:
                        </p>
                        <p class="text-sm 
                                 {% if is_dark_mode %}
                                 text-cyber-text-primary
                                 {% else %}
                                 text-gray-900
                                 {% endif %}">
                            {{ report.template.get_report_type_display }}
                        </p>
                    </div>
                    
                    {% if report.date_from_shamsi %}
                    <div>
                        <p class="text-sm font-medium 
                                 {% if is_dark_mode %}
                                 text-cyber-text-secondary
                                 {% else %}
                                 text-gray-600
                                 {% endif %}">
                            از تاریخ:
                        </p>
                        <p class="text-sm persian-numbers
                                 {% if is_dark_mode %}
                                 text-cyber-text-primary
                                 {% else %}
                                 text-gray-900
                                 {% endif %}">
                            {{ report.date_from_shamsi }}
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if report.date_to_shamsi %}
                    <div>
                        <p class="text-sm font-medium 
                                 {% if is_dark_mode %}
                                 text-cyber-text-secondary
                                 {% else %}
                                 text-gray-600
                                 {% endif %}">
                            تا تاریخ:
                        </p>
                        <p class="text-sm persian-numbers
                                 {% if is_dark_mode %}
                                 text-cyber-text-primary
                                 {% else %}
                                 text-gray-900
                                 {% endif %}">
                            {{ report.date_to_shamsi }}
                        </p>
                    </div>
                    {% endif %}
                    
                    <div>
                        <p class="text-sm font-medium 
                                 {% if is_dark_mode %}
                                 text-cyber-text-secondary
                                 {% else %}
                                 text-gray-600
                                 {% endif %}">
                            تولید شده توسط:
                        </p>
                        <p class="text-sm 
                                 {% if is_dark_mode %}
                                 text-cyber-text-primary
                                 {% else %}
                                 text-gray-900
                                 {% endif %}">
                            {{ report.generated_by.get_full_name|default:report.generated_by.username }}
                        </p>
                    </div>
                    
                    {% if report.generation_duration_seconds %}
                    <div>
                        <p class="text-sm font-medium 
                                 {% if is_dark_mode %}
                                 text-cyber-text-secondary
                                 {% else %}
                                 text-gray-600
                                 {% endif %}">
                            مدت زمان تولید:
                        </p>
                        <p class="text-sm persian-numbers
                                 {% if is_dark_mode %}
                                 text-cyber-text-primary
                                 {% else %}
                                 text-gray-900
                                 {% endif %}">
                            {{ report.generation_duration_seconds }} ثانیه
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if report.expires_at %}
                    <div>
                        <p class="text-sm font-medium 
                                 {% if is_dark_mode %}
                                 text-cyber-text-secondary
                                 {% else %}
                                 text-gray-600
                                 {% endif %}">
                            تاریخ انقضا:
                        </p>
                        <p class="text-sm persian-numbers
                                 {% if is_dark_mode %}
                                 text-cyber-text-primary
                                 {% else %}
                                 text-gray-900
                                 {% endif %}">
                            {{ report.expires_at|date:"Y/m/d H:i" }}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Delivery History -->
            {% if deliveries %}
            <div class="p-6 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                        border border-cyber-border-glass backdrop-blur-sm
                        {% else %}
                        bg-white border border-gray-200 shadow-sm
                        {% endif %}">
                
                <h3 class="text-lg font-semibold mb-4 
                           {% if is_dark_mode %}
                           text-cyber-text-primary
                           {% else %}
                           text-gray-900
                           {% endif %}">
                    تاریخچه ارسال
                </h3>

                <div class="space-y-3">
                    {% for delivery in deliveries %}
                    <div class="p-3 rounded-lg
                               {% if is_dark_mode %}
                               bg-cyber-bg-surface/60 border border-cyber-border-glass
                               {% else %}
                               bg-gray-50 border border-gray-200
                               {% endif %}">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium 
                                         {% if is_dark_mode %}
                                         text-cyber-text-primary
                                         {% else %}
                                         text-gray-900
                                         {% endif %}">
                                    {{ delivery.get_delivery_method_display }}
                                </p>
                                <p class="text-xs 
                                         {% if is_dark_mode %}
                                         text-cyber-text-secondary
                                         {% else %}
                                         text-gray-500
                                         {% endif %}">
                                    {{ delivery.recipient }}
                                </p>
                            </div>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                         {% if delivery.status == 'delivered' %}
                                             {% if is_dark_mode %}bg-cyber-neon-success/20 text-cyber-neon-success{% else %}bg-green-100 text-green-800{% endif %}
                                         {% elif delivery.status == 'sent' %}
                                             {% if is_dark_mode %}bg-cyber-neon-primary/20 text-cyber-neon-primary{% else %}bg-blue-100 text-blue-800{% endif %}
                                         {% elif delivery.status == 'failed' %}
                                             {% if is_dark_mode %}bg-cyber-neon-danger/20 text-cyber-neon-danger{% else %}bg-red-100 text-red-800{% endif %}
                                         {% else %}
                                             {% if is_dark_mode %}bg-cyber-text-muted/20 text-cyber-text-muted{% else %}bg-gray-100 text-gray-800{% endif %}
                                         {% endif %}">
                                {{ delivery.get_status_display }}
                            </span>
                        </div>
                        {% if delivery.sent_at %}
                        <p class="text-xs mt-1 persian-numbers
                                 {% if is_dark_mode %}
                                 text-cyber-text-muted
                                 {% else %}
                                 text-gray-400
                                 {% endif %}">
                            {{ delivery.sent_at|date:"Y/m/d H:i" }}
                        </p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="p-6 rounded-xl 
                        {% if is_dark_mode %}
                        bg-gradient-to-br from-cyber-bg-surface/80 to-cyber-bg-elevated/80 
                        border border-cyber-border-glass backdrop-blur-sm
                        {% else %}
                        bg-white border border-gray-200 shadow-sm
                        {% endif %}">
                
                <h3 class="text-lg font-semibold mb-4 
                           {% if is_dark_mode %}
                           text-cyber-text-primary
                           {% else %}
                           text-gray-900
                           {% endif %}">
                    عملیات
                </h3>

                <div class="space-y-3">
                    <a href="{% url 'reports:generate_template' report.template.id %}" 
                       class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md transition-all duration-300
                              {% if is_dark_mode %}
                              text-cyber-bg-primary bg-cyber-neon-primary hover:bg-cyber-neon-secondary
                              {% else %}
                              text-white bg-blue-600 hover:bg-blue-700
                              {% endif %}">
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        تولید مجدد
                    </a>
                    
                    <a href="{% url 'reports:schedule_create' %}?template={{ report.template.id }}" 
                       class="w-full inline-flex items-center justify-center px-4 py-2 border text-sm font-medium rounded-md transition-all duration-300
                              {% if is_dark_mode %}
                              border-cyber-border-glass text-cyber-text-primary hover:bg-cyber-bg-elevated
                              {% else %}
                              border-gray-300 text-gray-700 bg-white hover:bg-gray-50
                              {% endif %}">
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        زمان‌بندی تولید
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function reportProgress(reportId) {
    return {
        progress: 0,
        
        async startMonitoring() {
            const checkProgress = async () => {
                try {
                    const response = await fetch(`/reports/ajax/status/${reportId}/`);
                    const data = await response.json();
                    
                    this.progress = data.progress || 0;
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        // Reload page to show final status
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // Continue monitoring
                        setTimeout(checkProgress, 3000);
                    }
                } catch (error) {
                    console.error('Error checking progress:', error);
                    setTimeout(checkProgress, 5000);
                }
            };
            
            checkProgress();
        }
    }
}
</script>
{% endblock %}