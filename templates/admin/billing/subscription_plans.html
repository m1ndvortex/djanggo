{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}مدیریت پلن‌های اشتراک - پنل مدیریت زرگر{% endblock %}

{% block page_header %}
<div class="bg-white dark:bg-cyber-bg-secondary rounded-lg shadow-lg dark:shadow-2xl p-6 mb-6 cyber-glass">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-cyber-text-primary">مدیریت پلن‌های اشتراک</h1>
            <p class="text-gray-600 dark:text-cyber-text-secondary mt-1">ایجاد و مدیریت پلن‌های اشتراک برای تنانت‌ها</p>
        </div>
        <div class="flex space-x-3 space-x-reverse">
            <a href="{% url 'admin_panel:tenants:billing:subscription_plan_create' %}" 
               class="bg-primary-600 dark:bg-cyber-neon-primary hover:bg-primary-700 dark:hover:bg-cyber-neon-primary/80 text-white px-4 py-2 rounded-lg transition-colors cyber-button">
                ایجاد پلن جدید
            </a>
            <a href="{% url 'admin_panel:tenants:billing:dashboard' %}" 
               class="bg-gray-600 dark:bg-cyber-bg-elevated hover:bg-gray-700 dark:hover:bg-cyber-bg-elevated/80 text-white px-4 py-2 rounded-lg transition-colors">
                بازگشت به داشبورد
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Search and Filter -->
<div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-6 mb-6 cyber-card">
    <form method="get" class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-64">
            <label for="search" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">جستجو</label>
            <input type="text" name="search" id="search" value="{{ search_query }}" 
                   placeholder="نام پلن، نوع پلن یا توضیحات..."
                   class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
        </div>
        
        <div class="min-w-48">
            <label for="status" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">وضعیت</label>
            <select name="status" id="status" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                <option value="">همه وضعیت‌ها</option>
                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>فعال</option>
                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>غیرفعال</option>
            </select>
        </div>
        
        <div class="flex space-x-2 space-x-reverse">
            <button type="submit" 
                    class="bg-primary-600 dark:bg-cyber-neon-primary hover:bg-primary-700 dark:hover:bg-cyber-neon-primary/80 text-white px-4 py-2 rounded-lg transition-colors cyber-button">
                جستجو
            </button>
            <a href="{% url 'admin_panel:tenants:billing:subscription_plans' %}" 
               class="bg-gray-500 dark:bg-cyber-bg-elevated hover:bg-gray-600 dark:hover:bg-cyber-bg-elevated/80 text-white px-4 py-2 rounded-lg transition-colors">
                پاک کردن
            </a>
        </div>
    </form>
</div>

<!-- Subscription Plans Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for plan in plans %}
    <div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl overflow-hidden cyber-card
                {% if plan.is_popular %}ring-2 ring-primary-500 dark:ring-cyber-neon-primary{% endif %}">
        
        {% if plan.is_popular %}
        <div class="bg-primary-500 dark:bg-cyber-neon-primary text-white text-center py-2 text-sm font-medium">
            محبوب‌ترین پلن
        </div>
        {% endif %}
        
        <div class="p-6">
            <!-- Plan Header -->
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-cyber-text-primary">{{ plan.name_persian }}</h3>
                <p class="text-gray-600 dark:text-cyber-text-secondary text-sm mt-1">{{ plan.get_plan_type_display }}</p>
                
                <div class="mt-4">
                    <span class="text-3xl font-bold text-gray-900 dark:text-cyber-text-primary persian-numbers">
                        {{ plan.monthly_price_toman|floatformat:0 }}
                    </span>
                    <span class="text-gray-600 dark:text-cyber-text-secondary"> تومان/ماه</span>
                </div>
                
                {% if plan.yearly_price_toman %}
                <div class="mt-2">
                    <span class="text-lg text-green-600 dark:text-cyber-neon-secondary persian-numbers">
                        {{ plan.yearly_price_toman|floatformat:0 }}
                    </span>
                    <span class="text-sm text-gray-600 dark:text-cyber-text-secondary"> تومان/سال</span>
                    <span class="inline-block bg-green-100 dark:bg-cyber-neon-secondary/20 text-green-800 dark:text-cyber-neon-secondary text-xs px-2 py-1 rounded-full mr-2">
                        {{ plan.yearly_discount_percentage }}% تخفیف
                    </span>
                </div>
                {% endif %}
            </div>
            
            <!-- Plan Limits -->
            <div class="space-y-3 mb-6">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-cyber-text-secondary">حداکثر کاربران:</span>
                    <span class="font-medium text-gray-900 dark:text-cyber-text-primary persian-numbers">{{ plan.max_users }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-cyber-text-secondary">حداکثر کالاها:</span>
                    <span class="font-medium text-gray-900 dark:text-cyber-text-primary persian-numbers">{{ plan.max_inventory_items }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-cyber-text-secondary">حداکثر مشتریان:</span>
                    <span class="font-medium text-gray-900 dark:text-cyber-text-primary persian-numbers">{{ plan.max_customers }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-cyber-text-secondary">فضای ذخیره‌سازی:</span>
                    <span class="font-medium text-gray-900 dark:text-cyber-text-primary persian-numbers">{{ plan.max_storage_gb }} گیگابایت</span>
                </div>
            </div>
            
            <!-- Plan Features -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-900 dark:text-cyber-text-primary mb-3">امکانات:</h4>
                <div class="space-y-2">
                    {% for feature in plan.features_persian %}
                    <div class="flex items-center text-sm">
                        <svg class="w-4 h-4 text-green-500 dark:text-cyber-neon-secondary ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-gray-700 dark:text-cyber-text-secondary">{{ feature }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Plan Status and Stats -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                        {% if plan.is_active %}bg-green-100 dark:bg-cyber-neon-secondary/20 text-green-800 dark:text-cyber-neon-secondary
                        {% else %}bg-red-100 dark:bg-cyber-neon-danger/20 text-red-800 dark:text-cyber-neon-danger{% endif %}">
                        {% if plan.is_active %}فعال{% else %}غیرفعال{% endif %}
                    </span>
                </div>
                <div class="text-left">
                    <p class="text-sm text-gray-600 dark:text-cyber-text-secondary">تنانت‌های فعال:</p>
                    <p class="text-lg font-bold text-gray-900 dark:text-cyber-text-primary persian-numbers">{{ plan.tenant_count }}</p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-2 space-x-reverse">
                <a href="{% url 'admin_panel:tenants:billing:subscription_plan_update' plan.pk %}" 
                   class="flex-1 bg-primary-600 dark:bg-cyber-neon-primary hover:bg-primary-700 dark:hover:bg-cyber-neon-primary/80 text-white text-center py-2 px-4 rounded-lg transition-colors cyber-button text-sm">
                    ویرایش
                </a>
                {% if plan.tenant_count == 0 %}
                <a href="{% url 'admin_panel:tenants:billing:subscription_plan_delete' plan.pk %}" 
                   class="bg-red-600 dark:bg-cyber-neon-danger hover:bg-red-700 dark:hover:bg-cyber-neon-danger/80 text-white py-2 px-4 rounded-lg transition-colors text-sm"
                   onclick="return confirm('آیا از حذف این پلن اطمینان دارید؟')">
                    حذف
                </a>
                {% else %}
                <button disabled 
                        class="bg-gray-400 dark:bg-cyber-bg-elevated text-gray-600 dark:text-cyber-text-muted py-2 px-4 rounded-lg text-sm cursor-not-allowed"
                        title="نمی‌توان پلن در حال استفاده را حذف کرد">
                    حذف
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full">
        <div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-12 text-center cyber-card">
            <svg class="w-16 h-16 text-gray-400 dark:text-cyber-text-muted mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 dark:text-cyber-text-primary mb-2">هیچ پلن اشتراکی یافت نشد</h3>
            <p class="text-gray-600 dark:text-cyber-text-secondary mb-6">برای شروع، اولین پلن اشتراک خود را ایجاد کنید.</p>
            <a href="{% url 'admin_panel:tenants:billing:subscription_plan_create' %}" 
               class="bg-primary-600 dark:bg-cyber-neon-primary hover:bg-primary-700 dark:hover:bg-cyber-neon-primary/80 text-white px-6 py-3 rounded-lg transition-colors cyber-button">
                ایجاد پلن جدید
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="bg-white dark:bg-cyber-bg-surface rounded-lg shadow-lg dark:shadow-2xl p-4 mt-6 cyber-card">
    <div class="flex justify-between items-center">
        <div class="text-sm text-gray-700 dark:text-cyber-text-secondary">
            نمایش {{ page_obj.start_index }} تا {{ page_obj.end_index }} از {{ page_obj.paginator.count }} پلن
        </div>
        
        <div class="flex space-x-1 space-x-reverse">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                   class="px-3 py-2 text-sm text-gray-500 dark:text-cyber-text-muted hover:text-gray-700 dark:hover:text-cyber-text-secondary">اول</a>
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                   class="px-3 py-2 text-sm text-gray-500 dark:text-cyber-text-muted hover:text-gray-700 dark:hover:text-cyber-text-secondary">قبلی</a>
            {% endif %}
            
            <span class="px-3 py-2 text-sm bg-primary-600 dark:bg-cyber-neon-primary text-white rounded persian-numbers">
                {{ page_obj.number }}
            </span>
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                   class="px-3 py-2 text-sm text-gray-500 dark:text-cyber-text-muted hover:text-gray-700 dark:hover:text-cyber-text-secondary">بعدی</a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                   class="px-3 py-2 text-sm text-gray-500 dark:text-cyber-text-muted hover:text-gray-700 dark:hover:text-cyber-text-secondary">آخر</a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}