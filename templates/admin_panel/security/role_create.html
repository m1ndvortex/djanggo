{% extends 'admin_panel/base_unified.html' %}
{% load static %}

{% block title %}ایجاد نقش جدید - پنل مدیریت زرگر{% endblock %}

{% block extra_css %}
<style>
    .permission-section {
        transition: all 0.3s ease;
    }
    
    .permission-item {
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    
    .permission-item:hover {
        border-color: rgba(59, 130, 246, 0.3);
        transform: translateY(-1px);
    }
    
    .dark .permission-item:hover {
        border-color: rgba(0, 212, 255, 0.3);
    }
    
    .permission-checkbox {
        transform: scale(1.2);
    }
    
    .section-header {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .section-header:hover {
        background-color: rgba(59, 130, 246, 0.05);
    }
    
    .dark .section-header:hover {
        background-color: rgba(0, 212, 255, 0.05);
    }
    
    .select-all-btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-cyber-bg-primary" x-data="roleCreate()">
    
    <!-- Page Header -->
    <div class="bg-white dark:bg-cyber-bg-secondary shadow-lg dark:shadow-cyber-neon-primary/10 border-b dark:border-cyber-neon-primary/20">
        <div class="px-6 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <nav class="flex items-center space-x-2 space-x-reverse text-sm text-gray-500 dark:text-cyber-text-muted mb-2">
                        <a href="{% url 'admin_panel:dashboard' %}" class="hover:text-primary-600 dark:hover:text-cyber-neon-primary">داشبورد</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <a href="{% url 'admin_panel:rbac_management' %}" class="hover:text-primary-600 dark:hover:text-cyber-neon-primary">کنترل دسترسی</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <a href="{% url 'admin_panel:rbac_role_list' %}" class="hover:text-primary-600 dark:hover:text-cyber-neon-primary">لیست نقش‌ها</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="text-gray-900 dark:text-cyber-text-primary">ایجاد نقش جدید</span>
                    </nav>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-cyber-text-primary">ایجاد نقش جدید</h1>
                    <p class="mt-2 text-gray-600 dark:text-cyber-text-secondary">تعریف نقش جدید با مجوزهای مورد نیاز</p>
                </div>
                
                <div class="flex space-x-4 space-x-reverse">
                    <a href="{% url 'admin_panel:rbac_role_list' %}" 
                       class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-cyber-bg-elevated text-gray-700 dark:text-cyber-text-secondary rounded-lg hover:bg-gray-200 dark:hover:bg-cyber-bg-surface transition-colors">
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        بازگشت
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="px-6 py-6">
        <form method="post" class="max-w-6xl mx-auto">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Role Information -->
                <div class="lg:col-span-1">
                    <div class="bg-white dark:bg-cyber-bg-secondary rounded-xl shadow-lg dark:shadow-cyber-neon-primary/10 p-6 sticky top-6">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-cyber-text-primary mb-6">اطلاعات نقش</h2>
                        
                        <!-- Name -->
                        <div class="mb-6">
                            <label for="name" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">نام انگلیسی *</label>
                            <input type="text" 
                                   id="name" 
                                   name="name" 
                                   required
                                   placeholder="admin_manager"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                        </div>
                        
                        <!-- Persian Name -->
                        <div class="mb-6">
                            <label for="name_persian" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">نام فارسی *</label>
                            <input type="text" 
                                   id="name_persian" 
                                   name="name_persian" 
                                   required
                                   placeholder="مدیر ادمین"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                        </div>
                        
                        <!-- Role Type -->
                        <div class="mb-6">
                            <label for="role_type" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">نوع نقش</label>
                            <select id="role_type" 
                                    name="role_type"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                                {% for value, label in role_types %}
                                <option value="{{ value }}">
                                    {% if value == 'system' %}سیستمی{% elif value == 'custom' %}سفارشی{% else %}{{ label }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Max Users -->
                        <div class="mb-6">
                            <label for="max_users" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">حداکثر کاربران</label>
                            <input type="number" 
                                   id="max_users" 
                                   name="max_users" 
                                   placeholder="نامحدود"
                                   min="1"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary">
                            <p class="mt-1 text-xs text-gray-500 dark:text-cyber-text-muted">خالی بگذارید برای نامحدود</p>
                        </div>
                        
                        <!-- Description -->
                        <div class="mb-6">
                            <label for="description" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">توضیحات انگلیسی</label>
                            <textarea id="description" 
                                      name="description" 
                                      rows="3"
                                      placeholder="Role description in English"
                                      class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary"></textarea>
                        </div>
                        
                        <!-- Persian Description -->
                        <div class="mb-6">
                            <label for="description_persian" class="block text-sm font-medium text-gray-700 dark:text-cyber-text-secondary mb-2">توضیحات فارسی</label>
                            <textarea id="description_persian" 
                                      name="description_persian" 
                                      rows="3"
                                      placeholder="توضیحات نقش به فارسی"
                                      class="w-full px-3 py-2 border border-gray-300 dark:border-cyber-neon-primary/30 rounded-lg focus:ring-primary-500 dark:focus:ring-cyber-neon-primary focus:border-primary-500 dark:focus:border-cyber-neon-primary bg-white dark:bg-cyber-bg-elevated text-gray-900 dark:text-cyber-text-primary"></textarea>
                        </div>
                        
                        <!-- Permission Summary -->
                        <div class="bg-gray-50 dark:bg-cyber-bg-elevated rounded-lg p-4 mb-6">
                            <h3 class="text-sm font-medium text-gray-900 dark:text-cyber-text-primary mb-2">خلاصه مجوزها</h3>
                            <div class="text-2xl font-bold text-primary-600 dark:text-cyber-neon-primary persian-numbers" x-text="selectedPermissions.length"></div>
                            <div class="text-xs text-gray-500 dark:text-cyber-text-muted">مجوز انتخاب شده</div>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" 
                                class="w-full px-4 py-3 bg-primary-600 dark:bg-cyber-neon-primary text-white dark:text-cyber-bg-primary rounded-lg hover:bg-primary-700 dark:hover:bg-cyber-neon-primary/80 transition-colors font-medium">
                            <svg class="w-5 h-5 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            ایجاد نقش
                        </button>
                    </div>
                </div>
                
                <!-- Permissions Selection -->
                <div class="lg:col-span-2">
                    <div class="bg-white dark:bg-cyber-bg-secondary rounded-xl shadow-lg dark:shadow-cyber-neon-primary/10 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-cyber-text-primary">انتخاب مجوزها</h2>
                            
                            <!-- Global Actions -->
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <button type="button" 
                                        @click="selectAllPermissions()"
                                        class="select-all-btn bg-green-100 dark:bg-cyber-neon-secondary/20 text-green-700 dark:text-cyber-neon-secondary hover:bg-green-200 dark:hover:bg-cyber-neon-secondary/30">
                                    انتخاب همه
                                </button>
                                
                                <button type="button" 
                                        @click="deselectAllPermissions()"
                                        class="select-all-btn bg-red-100 dark:bg-cyber-neon-danger/20 text-red-700 dark:text-cyber-neon-danger hover:bg-red-200 dark:hover:bg-cyber-neon-danger/30">
                                    حذف انتخاب همه
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            {% for section, permissions in permissions_by_section.items %}
                            <div class="permission-section" x-data="{ open: true }">
                                
                                <!-- Section Header -->
                                <div class="section-header flex items-center justify-between p-4 bg-gray-50 dark:bg-cyber-bg-elevated rounded-lg mb-4" 
                                     @click="open = !open">
                                    <div class="flex items-center">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-cyber-text-primary capitalize ml-3">{{ section }}</h3>
                                        <span class="px-2 py-1 text-xs rounded-full bg-gray-200 dark:bg-cyber-bg-surface text-gray-600 dark:text-cyber-text-muted persian-numbers">
                                            {{ permissions|length }} مجوز
                                        </span>
                                    </div>
                                    
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <!-- Section Actions -->
                                        <button type="button" 
                                                @click.stop="selectSectionPermissions('{{ section }}')"
                                                class="select-all-btn bg-blue-100 dark:bg-cyber-neon-primary/20 text-blue-700 dark:text-cyber-neon-primary hover:bg-blue-200 dark:hover:bg-cyber-neon-primary/30">
                                            انتخاب بخش
                                        </button>
                                        
                                        <!-- Expand/Collapse Icon -->
                                        <svg class="w-5 h-5 text-gray-400 dark:text-cyber-text-muted transition-transform" 
                                             :class="{ 'rotate-180': open }" 
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- Section Permissions -->
                                <div x-show="open" x-transition class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {% for permission in permissions %}
                                    <div class="permission-item bg-gray-50 dark:bg-cyber-bg-elevated rounded-lg p-4">
                                        <label class="flex items-start cursor-pointer">
                                            <input type="checkbox" 
                                                   name="permissions" 
                                                   value="{{ permission.id }}"
                                                   @change="updateSelectedPermissions()"
                                                   class="permission-checkbox mt-1 ml-3 text-primary-600 dark:text-cyber-neon-primary border-gray-300 dark:border-cyber-neon-primary/30 rounded focus:ring-primary-500 dark:focus:ring-cyber-neon-primary">
                                            
                                            <div class="flex-1">
                                                <div class="text-sm font-medium text-gray-900 dark:text-cyber-text-primary">
                                                    {{ permission.name_persian|default:permission.name }}
                                                </div>
                                                <div class="text-xs text-gray-500 dark:text-cyber-text-muted mt-1">
                                                    {{ permission.codename }}
                                                </div>
                                                {% if permission.description_persian or permission.description %}
                                                <div class="text-xs text-gray-600 dark:text-cyber-text-secondary mt-1">
                                                    {{ permission.description_persian|default:permission.description }}
                                                </div>
                                                {% endif %}
                                                
                                                <div class="flex items-center mt-2 space-x-2 space-x-reverse">
                                                    {% if permission.is_dangerous %}
                                                    <span class="px-2 py-1 text-xs rounded-full bg-red-100 dark:bg-cyber-neon-danger/20 text-red-800 dark:text-cyber-neon-danger">
                                                        خطرناک
                                                    </span>
                                                    {% endif %}
                                                    
                                                    {% if permission.requires_2fa %}
                                                    <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 dark:bg-cyber-neon-warning/20 text-yellow-800 dark:text-cyber-neon-warning">
                                                        نیاز به 2FA
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
            </div>
        </form>
    </div>
</div>

<script>
function roleCreate() {
    return {
        selectedPermissions: [],
        
        init() {
            this.updateSelectedPermissions();
        },
        
        updateSelectedPermissions() {
            const checkboxes = document.querySelectorAll('input[name="permissions"]:checked');
            this.selectedPermissions = Array.from(checkboxes).map(cb => cb.value);
        },
        
        selectAllPermissions() {
            const checkboxes = document.querySelectorAll('input[name="permissions"]');
            checkboxes.forEach(cb => cb.checked = true);
            this.updateSelectedPermissions();
        },
        
        deselectAllPermissions() {
            const checkboxes = document.querySelectorAll('input[name="permissions"]');
            checkboxes.forEach(cb => cb.checked = false);
            this.updateSelectedPermissions();
        },
        
        selectSectionPermissions(section) {
            // Find all checkboxes in the section
            const sectionElement = document.querySelector(`[data-section="${section}"]`);
            if (sectionElement) {
                const checkboxes = sectionElement.querySelectorAll('input[name="permissions"]');
                checkboxes.forEach(cb => cb.checked = true);
                this.updateSelectedPermissions();
            }
        }
    }
}
</script>
{% endblock %}